<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:activiti="http://activiti.org/bpmn" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:tns="http://sourceforge.net/bpmn/definitions/_1445012669732" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:yaoqiang="http://bpmn.sourceforge.net" exporter="Yaoqiang BPMN Editor" exporterVersion="2.2.18 (GPLv3, Non-Commercial)" expressionLanguage="http://activiti.org/Juel" id="_1445012669732" name="" targetNamespace="http://sourceforge.net/bpmn/definitions/_1445012669732" typeLanguage="http://www.w3.org/2001/XMLSchema" xsi:schemaLocation="http://www.omg.org/spec/BPMN/20100524/MODEL http://bpmn.sourceforge.net/schemas/BPMN20.xsd">
  <process id="CreateContactAndAccount" isClosed="false" isExecutable="true" name="Create Contact and Account" processType="None">
    <documentation id="CreateContactAndAccount_D_1" textFormat="text/plain"><![CDATA[Reusable process to create contact and account from a single JSON message.]]></documentation>
    <extensionElements>
      <yaoqiang:pageFormat height="842.4" imageableHeight="832.4" imageableWidth="587.6" imageableX="5.0" imageableY="5.0" orientation="0" width="597.6"/>
      <yaoqiang:page background="#FFFFFF" horizontalCount="1" verticalCount="1"/>
    </extensionElements>
    <ioSpecification>
      <dataInput id="_15" isCollection="false" name="External Contact"/>
      <dataOutput id="_17" isCollection="false" name="Omny Contact"/>
      <dataOutput id="_19" isCollection="false" name="Omny Account"/>
      <inputSet>
        <dataInputRefs>_15</dataInputRefs>
      </inputSet>
      <outputSet>
        <dataOutputRefs>_17</dataOutputRefs>
        <dataOutputRefs>_19</dataOutputRefs>
      </outputSet>
    </ioSpecification>
    <scriptTask completionQuantity="1" id="_3" isForCompensation="false" name="Split Contact&#10;and Account" scriptFormat="JavaScript" startQuantity="1">
      <incoming>_4</incoming>
      <outgoing>_6</outgoing>
      <ioSpecification>
        <dataInput id="Din_3_15" isCollection="false"/>
        <dataOutput id="Dout_3_17" isCollection="false"/>
        <dataOutput id="Dout_3_19" isCollection="false"/>
        <inputSet>
          <dataInputRefs>Din_3_15</dataInputRefs>
        </inputSet>
        <outputSet>
          <dataOutputRefs>Dout_3_17</dataOutputRefs>
          <dataOutputRefs>Dout_3_19</dataOutputRefs>
        </outputSet>
      </ioSpecification>
      <dataInputAssociation id="_16">
        <sourceRef>_15</sourceRef>
        <targetRef>Din_3_15</targetRef>
      </dataInputAssociation>
      <dataOutputAssociation id="_18">
        <sourceRef>Dout_3_17</sourceRef>
        <targetRef>_17</targetRef>
      </dataOutputAssociation>
      <dataOutputAssociation id="_13">
        <sourceRef>Dout_3_19</sourceRef>
        <targetRef>_19</targetRef>
      </dataOutputAssociation>
      <script><![CDATA[
var System = java.lang.System;
var json = execution.getVariable('json');
System.out.println('JSON: '+json);
var extContact = JSON.parse(json);
System.out.println('extContact: '+extContact);
System.out.println('external acct: '+extContact.account);
var account = JSON.stringify(extContact.account);
var contact = extContact;
contact.account = undefined; 
//var account = extContact.account;

var pageSubmitted = extContact['pageSubmitted'];
if (pageSubmitted!=undefined) { 
  //println('Setting page submitted to: '+pageSubmitted);
  if (contact['customFields']==undefined) contact.customFields = {};
  contact.customFields.pageSubmitted = pageSubmitted; 
}
  
execution.setVariable('contactFirstName',extContact.firstName);
execution.setVariable('contactEmail',extContact.email);
execution.setVariable('contactPwd',extContact.password == undefined ? null : extContact.password);
execution.setVariable('contact',JSON.stringify(contact));
execution.setVariable('account',account == undefined ? null : account);
]]></script>
    </scriptTask>
    <sequenceFlow id="_4" sourceRef="_2" targetRef="_3"/>
    <serviceTask activiti:class="com.knowprocess.resource.spi.RestPost" completionQuantity="1" id="_5" implementation="##WebService" isForCompensation="false" name="POST &#10;contact" startQuantity="1">
      <extensionElements>
        <activiti:field name="resourceUsername">
          <activiti:string>userInfo('tenant-bot')</activiti:string>
        </activiti:field>
        <activiti:field name="resourcePassword">
          <activiti:expression>userInfo('cust-mgmt-secret')</activiti:expression>
        </activiti:field>
        <activiti:field name="globalResource">
          <activiti:expression>userInfo('cust-mgmt-url')/contacts</activiti:expression>
        </activiti:field>
        <activiti:field name="headers">
          <activiti:string>Content-Type:application/json,Accept:application/json</activiti:string>
        </activiti:field>
        <activiti:field name="data">
          <activiti:expression>${contact}</activiti:expression>
        </activiti:field>
        <activiti:field expression="contactId=Location" name="responseHeaders"/>
      </extensionElements>
      <incoming>_6</incoming>
      <outgoing>_24</outgoing>
    </serviceTask>
    <sequenceFlow id="_6" sourceRef="_3" targetRef="_5"/>
    <serviceTask activiti:class="com.knowprocess.resource.spi.RestPost" completionQuantity="1" id="_7" implementation="##WebService" isForCompensation="false" name="POST &#10;account" startQuantity="1">
      <extensionElements>
        <activiti:field name="resourceUsername">
          <activiti:string>userInfo('tenant-bot')</activiti:string>
        </activiti:field>
        <activiti:field name="resourcePassword">
          <activiti:expression>userInfo('cust-mgmt-secret')</activiti:expression>
        </activiti:field>
        <activiti:field name="globalResource">
          <activiti:expression>userInfo('cust-mgmt-url')/accounts</activiti:expression>
        </activiti:field>
        <activiti:field name="headers">
          <activiti:string>Content-Type:application/json,Accept:application/json</activiti:string>
        </activiti:field>
        <activiti:field name="data">
          <activiti:expression>${account}</activiti:expression>
        </activiti:field>
        <activiti:field expression="accountId=Location" name="responseHeaders"/>
      </extensionElements>
      <incoming>_21</incoming>
      <outgoing>_10</outgoing>
    </serviceTask>
    <serviceTask activiti:class="com.knowprocess.resource.spi.RestPut" completionQuantity="1" id="_9" implementation="##WebService" isForCompensation="false" name="PUT association&#10;between contact &#10;and account" startQuantity="1">
      <extensionElements>
        <activiti:field name="resourceUsername">
          <activiti:string>userInfo('tenant-bot')</activiti:string>
        </activiti:field>
        <activiti:field name="resourcePassword">
          <activiti:expression>userInfo('cust-mgmt-secret')</activiti:expression>
        </activiti:field>
        <activiti:field name="globalResource">
          <activiti:expression>${contactId}/account</activiti:expression>
        </activiti:field>
        <activiti:field name="headers">
          <activiti:string>Content-Type:text/uri-list,Accept:application/json</activiti:string>
        </activiti:field>
        <activiti:field name="data">
          <activiti:expression>${accountId}</activiti:expression>
        </activiti:field>
        <activiti:field name="responseVar">
          <activiti:expression>textResponse</activiti:expression>
        </activiti:field>
      </extensionElements>
      <incoming>_10</incoming>
      <outgoing>_28</outgoing>
    </serviceTask>
    <sequenceFlow id="_10" sourceRef="_7" targetRef="_9"/>
    <dataObject id="DO_CreateContactAndAccount_1" isCollection="false" name="Data Object"/>
    <sequenceFlow id="_21" name="Yes" sourceRef="_14" targetRef="_7">
      <extensionElements>
        <yaoqiang:label offset-x="-3.0" offset-y="0.0" x="0.0" y="22.0"/>
      </extensionElements>
      <conditionExpression><![CDATA[${!empty account}]]></conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="_23" name="No" sourceRef="_14" targetRef="_25"/>
    <callActivity calledElement="ConfirmEmail" completionQuantity="1" id="_31" isForCompensation="false" name="Send&#10;confirmation&#10;email" startQuantity="1">
      <extensionElements>
        <activiti:in sourceExpression="Account activation code" target="subject"/>
        <activiti:in sourceExpression="${contact.getString('email')}" target="contactEmail"/>
        <activiti:in sourceExpression="${contact.getString('firstName')}" target="contactFirstName"/>
        <activiti:in sourceExpression="http://api.omny.link:8082/${tenantId}/contacts" target="baseUrl"/>
        <activiti:in sourceExpression="The Omny Link Team" target="signOff"/>
        <activiti:in source="tenantId" target="tenantId"/>
        <activiti:in source="contactId" target="contactId"/>
        <activiti:in source="contact" target="contact"/>
      </extensionElements>
      <incoming>_30</incoming>
      <outgoing>_32</outgoing>
    </callActivity>
    <sequenceFlow id="_24" sourceRef="_5" targetRef="_14"/>
    <endEvent id="_11" name="End Event">
      <incoming>_32</incoming>
    </endEvent>
    <sequenceFlow id="_28" sourceRef="_9" targetRef="_25"/>
    <sequenceFlow id="_30" sourceRef="_25" targetRef="_31"/>
    <exclusiveGateway default="_23" gatewayDirection="Diverging" id="_14" name="Have account?">
      <incoming>_24</incoming>
      <outgoing>_21</outgoing>
      <outgoing>_23</outgoing>
    </exclusiveGateway>
    <exclusiveGateway gatewayDirection="Converging" id="_25">
      <incoming>_28</incoming>
      <incoming>_23</incoming>
      <outgoing>_30</outgoing>
    </exclusiveGateway>
    <sequenceFlow id="_32" sourceRef="_31" targetRef="_11"/>
    <startEvent id="_2" isInterrupting="true" name="Start Event" parallelMultiple="false">
      <outgoing>_4</outgoing>
    </startEvent>
    <textAnnotation id="_33" textFormat="text/plain">
      <text>Note that this may 
be long running

</text>
    </textAnnotation>
    <association associationDirection="None" id="_34" sourceRef="_33" targetRef="_31"/>
  </process>
  <globalTask id="GT_1" name="Global Task"/>
  <bpmndi:BPMNDiagram id="Yaoqiang_Diagram-_1" name="New Diagram" resolution="96.0">
    <bpmndi:BPMNPlane bpmnElement="CreateContactAndAccount">
      <bpmndi:BPMNShape bpmnElement="_3" id="Yaoqiang-_3">
        <dc:Bounds height="81.0" width="116.0" x="127.38461538461536" y="260.9090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="32.955078125" width="74.0" x="148.38461538461536" y="286.9315518465909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_5" id="Yaoqiang-_5">
        <dc:Bounds height="81.0" width="116.0" x="283.30769230769226" y="260.9090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="32.955078125" width="46.0" x="318.30769230769226" y="286.9315518465909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_7" id="Yaoqiang-_7">
        <dc:Bounds height="81.0" width="116.0" x="548.2307692307692" y="260.9090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="32.955078125" width="49.0" x="581.7307692307692" y="286.9315518465909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_9" id="Yaoqiang-_9">
        <dc:Bounds height="81.0" width="116.0" x="692.0" y="260.9090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="46.955078125" width="93.0" x="703.5" y="279.9315518465909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_15" id="Yaoqiang-_15">
        <dc:Bounds height="38.0" width="29.0" x="71.42307692307693" y="141.49999999999997"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="95.0" x="38.423076923076934" y="181.5"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_17" id="Yaoqiang-_17">
        <dc:Bounds height="38.0" width="29.0" x="268.5769230769231" y="58.80769230769229"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="83.0" x="241.5769230769231" y="98.80769230769229"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_19" id="Yaoqiang-_19">
        <dc:Bounds height="38.0" width="29.0" x="268.5769230769231" y="141.49999999999997"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="86.0" x="240.0769230769231" y="181.5"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_31" id="Yaoqiang-_31" isExpanded="false">
        <dc:Bounds height="81.0" width="116.0" x="925.2272727272727" y="260.9090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="46.955078125" width="75.0" x="945.7272727272727" y="279.9315518465909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_11" id="Yaoqiang-_11">
        <dc:Bounds height="32.0" width="32.0" x="1098.8636363636365" y="285.4090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="58.0" x="1085.8636363636365" y="326.7801846590909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_14" id="Yaoqiang-_14" isMarkerVisible="true">
        <dc:Bounds height="42.0" width="42.0" x="427.0454545454545" y="280.4090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="83.0" x="406.5454545454545" y="324.4090909090909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_25" id="Yaoqiang-_25" isMarkerVisible="true">
        <dc:Bounds height="42.0" width="42.0" x="839.3181818181818" y="280.4090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="857.3181818181818" y="324.4090909090909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_2" id="Yaoqiang-_2">
        <dc:Bounds height="32.0" width="32.0" x="34.96153846153848" y="285.4090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="63.0" x="19.461538461538453" y="326.7801846590909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_33" id="Yaoqiang-_33">
        <dc:Bounds height="55.0" width="123.0" x="921.7272727272727" y="427.0"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="32.955078125" width="106.0" x="921.7272727272727" y="440.0224609375"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge bpmnElement="_18" id="Yaoqiang-_18">
        <di:waypoint x="243.04545454545462" y="301.4090909090909"/>
        <di:waypoint x="269.0454545454546" y="77.80769230769229"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="252.98076923076923" y="180.06616723120624"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_16" id="Yaoqiang-_16">
        <di:waypoint x="100.04545454545462" y="160.49999999999997"/>
        <di:waypoint x="127.04545454545462" y="301.4090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="110.90384615384613" y="221.11861478365392"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_13" id="Yaoqiang-_13">
        <di:waypoint x="243.04545454545462" y="301.4090909090909"/>
        <di:waypoint x="269.0454545454546" y="160.49999999999997"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="252.98076923076923" y="221.41232107736005"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_6" id="Yaoqiang-_6">
        <di:waypoint x="243.04545454545462" y="301.4090909090909"/>
        <di:waypoint x="283.0454545454546" y="301.4090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="260.0454545454546" y="291.9315518465909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_10" id="Yaoqiang-_10">
        <di:waypoint x="664.0454545454546" y="301.4090909090909"/>
        <di:waypoint x="692.0454545454546" y="301.4090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="675.0454545454546" y="291.9315518465909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_4" id="Yaoqiang-_4">
        <di:waypoint x="67.04442145425097" y="301.4090909090909"/>
        <di:waypoint x="127.04545454545462" y="301.4090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="94.04493799985278" y="291.9315518465909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_28" id="Yaoqiang-_28">
        <di:waypoint x="808.0454545454546" y="301.4090909090909"/>
        <di:waypoint x="839.2272727272727" y="301.4090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="820.6363636363636" y="291.9315518465909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_24" id="Yaoqiang-_24">
        <di:waypoint x="399.0454545454546" y="301.4090909090909"/>
        <di:waypoint x="427.22727272727275" y="301.4090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="410.1363636363637" y="291.9315518465909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_23" id="Yaoqiang-_23">
        <di:waypoint x="448.0454545454545" y="322.22727272727263"/>
        <di:waypoint x="506.0" y="430.0"/>
        <di:waypoint x="860.3181818181818" y="321.9545454545456"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="21.0" x="643.8181818181816" y="420.5224609375"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_21" id="Yaoqiang-_21">
        <di:waypoint x="468.8636363636365" y="301.4090909090909"/>
        <di:waypoint x="548.0454545454546" y="301.4090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="32.955078125" width="103.0" x="453.9545454545456" y="262.9315518465909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_32" id="Yaoqiang-_32">
        <di:waypoint x="1041.0454545454545" y="301.4090909090909"/>
        <di:waypoint x="1099.0464876366582" y="301.4090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="1067.0459710910563" y="291.9315518465909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_30" id="Yaoqiang-_30">
        <di:waypoint x="880.8636363636365" y="301.4090909090909"/>
        <di:waypoint x="925.0454545454546" y="301.4090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="899.9545454545456" y="291.9315518465909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_34" id="Yaoqiang-_34">
        <di:waypoint x="983.4350145309087" y="427.22727272727275"/>
        <di:waypoint x="983.0936544859485" y="342.22727272727275"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="980.2643345084285" y="375.24973366477275"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</definitions>
