<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:activiti="http://activiti.org/bpmn" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:tns="http://sourceforge.net/bpmn/definitions/_1445012669732" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:yaoqiang="http://bpmn.sourceforge.net" exporter="Yaoqiang BPMN Editor" exporterVersion="2.2.18 (GPLv3, Non-Commercial)" expressionLanguage="http://activiti.org/Juel" id="_1445012669732" name="" targetNamespace="http://sourceforge.net/bpmn/definitions/_1445012669732" typeLanguage="http://www.w3.org/2001/XMLSchema" xsi:schemaLocation="http://www.omg.org/spec/BPMN/20100524/MODEL http://bpmn.sourceforge.net/schemas/BPMN20.xsd">
  <process id="CreateContactAndAccount" isClosed="false" isExecutable="true" name="Create Contact and Account" processType="None">
    <documentation id="CreateContactAndAccount_D_1" textFormat="text/plain"><![CDATA[Reusable process to create contact and account from a single JSON message.]]></documentation>
    <extensionElements>
      <yaoqiang:pageFormat height="842.4" imageableHeight="832.4" imageableWidth="587.6" imageableX="5.0" imageableY="5.0" orientation="0" width="597.6"/>
      <yaoqiang:page background="#FFFFFF" horizontalCount="1" verticalCount="1"/>
    </extensionElements>
    <ioSpecification>
      <dataInput id="_15" isCollection="false" name="External Contact"/>
      <dataOutput id="_17" isCollection="false" name="Omny Contact"/>
      <dataOutput id="_19" isCollection="false" name="Omny Account"/>
      <inputSet>
        <dataInputRefs>_15</dataInputRefs>
      </inputSet>
      <outputSet>
        <dataOutputRefs>_17</dataOutputRefs>
        <dataOutputRefs>_19</dataOutputRefs>
      </outputSet>
    </ioSpecification>
    <scriptTask completionQuantity="1" id="_3" isForCompensation="false" name="Split Contact&#10;and Account" scriptFormat="JavaScript" startQuantity="1">
      <incoming>_4</incoming>
      <outgoing>_6</outgoing>
      <ioSpecification>
        <dataInput id="Din_3_15" isCollection="false"/>
        <dataOutput id="Dout_3_17" isCollection="false"/>
        <dataOutput id="Dout_3_19" isCollection="false"/>
        <inputSet>
          <dataInputRefs>Din_3_15</dataInputRefs>
        </inputSet>
        <outputSet>
          <dataOutputRefs>Dout_3_17</dataOutputRefs>
          <dataOutputRefs>Dout_3_19</dataOutputRefs>
        </outputSet>
      </ioSpecification>
      <dataInputAssociation id="_16">
        <sourceRef>_15</sourceRef>
        <targetRef>Din_3_15</targetRef>
      </dataInputAssociation>
      <dataOutputAssociation id="_18">
        <sourceRef>Dout_3_17</sourceRef>
        <targetRef>_17</targetRef>
      </dataOutputAssociation>
      <dataOutputAssociation id="_13">
        <sourceRef>Dout_3_19</sourceRef>
        <targetRef>_19</targetRef>
      </dataOutputAssociation>
      <script><![CDATA[
var System = java.lang.System;
var json = execution.getVariable('json');
//System.out.println('JSON: '+json);
var extContact = JSON.parse(json);
//System.out.println('extContact: '+extContact);
//System.out.println('external acct: '+extContact.account);
var account = JSON.stringify(extContact.account);
var contact = extContact;
contact.account = undefined;
//System.out.println('external acct after stringify: '+extContact.account);
//var account = extContact.account;

var pageSubmitted = extContact['pageSubmitted'];
if (pageSubmitted!=undefined) {
  //println('Setting page submitted to: '+pageSubmitted);
  if (contact['customFields']==undefined) contact.customFields = {};
  contact.customFields.pageSubmitted = pageSubmitted;
}

//System.out.println('contactFirstName: '+extContact.firstName);
execution.setVariable('contactFirstName',extContact.firstName);
//System.out.println('contactEmail: '+extContact.email);
execution.setVariable('contactEmail',extContact.email);
//System.out.println('contactPwd: '+extContact.password == undefined ? null : extContact.password);
execution.setVariable('contactPwd',extContact.password == undefined ? null : extContact.password);
//System.out.println('contact: '+JSON.stringify(contact));
execution.setVariable('contact',JSON.stringify(contact));
//System.out.println('account: '+account);
execution.setVariable('account',account == undefined ? null : account);
]]></script>
    </scriptTask>
    <sequenceFlow id="_4" sourceRef="_2" targetRef="_3"/>
    <serviceTask activiti:class="com.knowprocess.resource.spi.RestPost" completionQuantity="1" id="_5" implementation="##WebService" isForCompensation="false" name="POST contact" startQuantity="1">
      <extensionElements>
        <activiti:field name="resourceUsername">
          <activiti:string>userInfo('tenant-bot')</activiti:string>
        </activiti:field>
        <activiti:field name="resourcePassword">
          <activiti:expression>userInfo('cust-mgmt-secret')</activiti:expression>
        </activiti:field>
        <activiti:field name="globalResource">
          <activiti:expression>userInfo('cust-mgmt-url')/contacts</activiti:expression>
        </activiti:field>
        <activiti:field name="headers">
          <activiti:string>Content-Type:application/json,Accept:application/json</activiti:string>
        </activiti:field>
        <activiti:field name="data">
          <activiti:expression>${contact}</activiti:expression>
        </activiti:field>
        <activiti:field expression="contactId=Location" name="responseHeaders"/>
        <activiti:field expression="contact" name="responseVar"/>
      </extensionElements>
      <incoming>_6</incoming>
      <outgoing>_24</outgoing>
    </serviceTask>
    <sequenceFlow id="_6" sourceRef="_3" targetRef="_5"/>
    <serviceTask activiti:class="com.knowprocess.resource.spi.RestPost" completionQuantity="1" id="_7" implementation="##WebService" isForCompensation="false" name="POST account" startQuantity="1">
      <extensionElements>
        <activiti:field name="resourceUsername">
          <activiti:string>userInfo('tenant-bot')</activiti:string>
        </activiti:field>
        <activiti:field name="resourcePassword">
          <activiti:expression>userInfo('cust-mgmt-secret')</activiti:expression>
        </activiti:field>
        <activiti:field name="globalResource">
          <activiti:expression>userInfo('cust-mgmt-url')/accounts</activiti:expression>
        </activiti:field>
        <activiti:field name="headers">
          <activiti:string>Content-Type:application/json,Accept:application/json</activiti:string>
        </activiti:field>
        <activiti:field name="data">
          <activiti:expression>${account}</activiti:expression>
        </activiti:field>
        <activiti:field expression="accountId=Location" name="responseHeaders"/>
      </extensionElements>
      <incoming>_21</incoming>
      <outgoing>_10</outgoing>
    </serviceTask>
    <serviceTask activiti:class="com.knowprocess.resource.spi.RestPut" completionQuantity="1" id="_9" implementation="##WebService" isForCompensation="false" name="PUT contact to account link" startQuantity="1">
      <extensionElements>
        <activiti:field name="resourceUsername">
          <activiti:string>userInfo('tenant-bot')</activiti:string>
        </activiti:field>
        <activiti:field name="resourcePassword">
          <activiti:expression>userInfo('cust-mgmt-secret')</activiti:expression>
        </activiti:field>
        <activiti:field name="globalResource">
          <activiti:expression>${contactId}/account</activiti:expression>
        </activiti:field>
        <activiti:field name="headers">
          <activiti:string>Content-Type:text/uri-list,Accept:application/json</activiti:string>
        </activiti:field>
        <activiti:field name="data">
          <activiti:expression>${accountId}</activiti:expression>
        </activiti:field>
        <activiti:field name="responseVar">
          <activiti:expression>textResponse</activiti:expression>
        </activiti:field>
      </extensionElements>
      <incoming>_10</incoming>
      <outgoing>_28</outgoing>
    </serviceTask>
    <sequenceFlow id="_10" sourceRef="_7" targetRef="_9"/>
    <sequenceFlow id="_21" name="Yes" sourceRef="_14" targetRef="_7">
      <extensionElements>
        <yaoqiang:label offset-x="-3.0" offset-y="0.0" x="0.0" y="22.0"/>
      </extensionElements>
      <conditionExpression><![CDATA[${!empty account}]]></conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="_23" name="No" sourceRef="_14" targetRef="_25"/>
    <sequenceFlow id="_24" sourceRef="_5" targetRef="_14"/>
    <endEvent id="_11" name="End Event">
      <incoming>_8</incoming>
      <inputSet/>
    </endEvent>
    <sequenceFlow id="_28" sourceRef="_9" targetRef="_25"/>
    <exclusiveGateway default="_23" gatewayDirection="Diverging" id="_14" name="Have account?">
      <incoming>_24</incoming>
      <outgoing>_21</outgoing>
      <outgoing>_23</outgoing>
    </exclusiveGateway>
    <exclusiveGateway gatewayDirection="Converging" id="_25">
      <incoming>_28</incoming>
      <incoming>_23</incoming>
      <outgoing>_8</outgoing>
    </exclusiveGateway>
    <startEvent id="_2" isInterrupting="true" name="Start Event" parallelMultiple="false">
      <outgoing>_4</outgoing>
      <outputSet/>
    </startEvent>
    <sequenceFlow id="_8" sourceRef="_25" targetRef="_11"/>
  </process>
  <globalTask id="GT_1" name="Global Task"/>
  <bpmndi:BPMNDiagram id="Yaoqiang_Diagram-_1" name="New Diagram" resolution="96.0">
    <bpmndi:BPMNPlane bpmnElement="CreateContactAndAccount">
      <bpmndi:BPMNShape bpmnElement="_3" id="Yaoqiang-_3">
        <dc:Bounds height="81.0" width="116.0" x="127.38461538461536" y="260.9090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="32.955078125" width="74.0" x="148.38461538461536" y="286.9315518465909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_5" id="Yaoqiang-_5">
        <dc:Bounds height="81.0" width="116.0" x="283.30769230769226" y="260.9090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="77.0" x="302.80769230769226" y="293.9315518465909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_7" id="Yaoqiang-_7">
        <dc:Bounds height="81.0" width="116.0" x="548.2307692307692" y="260.9090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="80.0" x="566.2307692307692" y="293.9315518465909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_9" id="Yaoqiang-_9">
        <dc:Bounds height="81.0" width="116.0" x="742.0" y="260.9090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="32.955078125" width="84.0" x="758.0" y="286.9315518465909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_15" id="Yaoqiang-_15">
        <dc:Bounds height="38.0" width="29.0" x="71.42307692307693" y="141.49999999999997"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="95.0" x="38.423076923076934" y="181.49999999999997"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_17" id="Yaoqiang-_17">
        <dc:Bounds height="38.0" width="29.0" x="273.5769230769231" y="58.80769230769229"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="83.0" x="246.5769230769231" y="98.80769230769229"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_19" id="Yaoqiang-_19">
        <dc:Bounds height="38.0" width="29.0" x="273.5769230769231" y="141.49999999999997"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="86.0" x="245.0769230769231" y="181.49999999999997"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_11" id="Yaoqiang-_11">
        <dc:Bounds height="32.0" width="32.0" x="1008.8636363636365" y="285.4090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="58.0" x="995.8636363636365" y="326.8475674715909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_14" id="Yaoqiang-_14" isMarkerVisible="true">
        <dc:Bounds height="42.0" width="42.0" x="427.0454545454545" y="280.4090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="83.0" x="406.5454545454545" y="324.4090909090909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_25" id="Yaoqiang-_25" isMarkerVisible="true">
        <dc:Bounds height="42.0" width="42.0" x="934.3181818181818" y="280.4090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="952.3181818181818" y="324.4090909090909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_2" id="Yaoqiang-_2">
        <dc:Bounds height="32.0" width="32.0" x="34.96153846153848" y="285.4090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="63.0" x="19.461538461538453" y="326.8475674715909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge bpmnElement="_18" id="Yaoqiang-_18">
        <di:waypoint x="243.5" y="301.4090909090909"/>
        <di:waypoint x="252.0" y="81.0"/>
        <di:waypoint x="273.5" y="81.0"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="249.0" y="175.22700639204544"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_16" id="Yaoqiang-_16">
        <di:waypoint x="100.5" y="160.49999999999997"/>
        <di:waypoint x="127.5" y="301.4090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="110.90384615384615" y="221.5731602381993"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_8" id="Yaoqiang-_8">
        <di:waypoint x="976.0909090909091" y="301.4090909090909"/>
        <di:waypoint x="1008.5052307103822" y="301.4090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="989.2980699006457" y="291.9315518465909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_13" id="Yaoqiang-_13">
        <di:waypoint x="243.5" y="301.4090909090909"/>
        <di:waypoint x="252.0" y="161.0"/>
        <di:waypoint x="273.5" y="161.0"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="249.0" y="215.22700639204544"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_6" id="Yaoqiang-_6">
        <di:waypoint x="243.5" y="301.4090909090909"/>
        <di:waypoint x="283.5" y="301.4090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="260.5" y="291.9315518465909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_10" id="Yaoqiang-_10">
        <di:waypoint x="664.5" y="301.4090909090909"/>
        <di:waypoint x="742.5" y="301.4090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="700.5" y="291.9315518465909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_4" id="Yaoqiang-_4">
        <di:waypoint x="66.49476928961775" y="301.4090909090909"/>
        <di:waypoint x="127.5" y="301.4090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="93.99738464480888" y="291.9315518465909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_28" id="Yaoqiang-_28">
        <di:waypoint x="858.5" y="301.4090909090909"/>
        <di:waypoint x="934.9090909090909" y="301.4090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="893.7045454545455" y="291.9315518465909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_24" id="Yaoqiang-_24">
        <di:waypoint x="399.5" y="301.4090909090909"/>
        <di:waypoint x="427.9090909090909" y="301.4090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="410.70454545454544" y="291.9315518465909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_23" id="Yaoqiang-_23">
        <di:waypoint x="449.0" y="321.5"/>
        <di:waypoint x="449.0" y="431.0"/>
        <di:waypoint x="955.3181818181818" y="321.81818181818176"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="21.0" x="691.5" y="421.5224609375"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_21" id="Yaoqiang-_21">
        <di:waypoint x="469.0909090909091" y="301.4090909090909"/>
        <di:waypoint x="548.5" y="301.4090909090909"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="32.955078125" width="103.0" x="454.29545454545456" y="262.9315518465909"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</definitions>
