<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:activiti="http://activiti.org/bpmn" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:tns="http://omny.link/website" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:yaoqiang="http://bpmn.sourceforge.net" exporter="Yaoqiang BPMN Editor" exporterVersion="2.2.18 (GPLv3, Non-Commercial)" expressionLanguage="http://activiti.org/Juel" id="_1421050736845" name="" targetNamespace="http://omny.link/website" typeLanguage="http://www.w3.org/2001/XMLSchema" xsi:schemaLocation="http://www.omg.org/spec/BPMN/20100524/MODEL http://bpmn.sourceforge.net/schemas/BPMN20.xsd">
  <message id="omny.enquiry" name="omny.enquiry"/>
  <process id="RecordEnquiry" isClosed="false" isExecutable="true" name="Record an enquiry" processType="None">
    <documentation id="RecordEnquiry_D_1" textFormat="text/plain"><![CDATA[Record an enquiry from the website]]></documentation>
    <extensionElements>
      <!-- <activiti:eventListener class="com.knowprocess.bpm.listeners.JsonInputListener" />-->
      <yaoqiang:pageFormat height="842.4" imageableHeight="832.4" imageableWidth="587.6" imageableX="5.0" imageableY="5.0" orientation="0" width="597.6"/>
      <yaoqiang:page background="#FFFFFF" horizontalCount="1" verticalCount="1"/>
    </extensionElements>
    <sequenceFlow id="_7" sourceRef="startEvent" targetRef="fetchContact"/>
    <boundaryEvent attachedToRef="fetchContact" cancelActivity="true" id="_4" name="Not found" parallelMultiple="false">
      <extensionElements>
        <yaoqiang:style align="right" labelPosition="left" verticalAlign="middle" verticalLabelPosition="bottom"/>
        <yaoqiang:label offset-x="68.33107088989436" offset-y="-16.0" x="0.0" y="1.0"/>
      </extensionElements>
      <outgoing>_12</outgoing>
      <outputSet/>
      <errorEventDefinition id="_4_ED_1"/>
    </boundaryEvent>
    <serviceTask activiti:class="com.knowprocess.resource.spi.RestGet" completionQuantity="1" id="fetchContact" implementation="##WebService" isForCompensation="false" name="Fetch contacts by email address" startQuantity="1">
      <extensionElements>
        <activiti:field name="resourceUsername">
          <activiti:string>userInfo('tenant-bot')</activiti:string>
        </activiti:field>
        <activiti:field name="resourcePassword">
          <activiti:expression>userInfo('cust-mgmt-secret')</activiti:expression>
        </activiti:field>
        <activiti:field name="globalResource">
          <activiti:expression>userInfo('cust-mgmt-url')/${omny_enquiry.getString('tenantId')}/contacts/searchByEmail?email=${omny_enquiry.getString('email')}</activiti:expression>
        </activiti:field>
        <activiti:field name="headers">
          <activiti:string>Accept:application/json</activiti:string>
        </activiti:field>
        <activiti:field expression="contacts" name="responseVar"/>
      </extensionElements>
      <incoming>_7</incoming>
      <outgoing>_9</outgoing>
    </serviceTask>
    <startEvent id="startEvent" isInterrupting="true" name="omny.enquiry" parallelMultiple="false">
      <outgoing>_7</outgoing>
      <outputSet/>
      <messageEventDefinition id="_2_ED_1" messageRef="omny.enquiry"/>
    </startEvent>
    <callActivity calledElement="AddActivityToContact" completionQuantity="1" id="addActivityToContact" isForCompensation="false" name="Add enquiry &#10;to contact" startQuantity="1">
      <extensionElements>
        <activiti:in source="omny_enquiry" target="contact"/>
        <activiti:in sourceExpression="${omny_enquiry.getString('type')}" target="activityType"/>
        <activiti:in sourceExpression="${omny_enquiry.getJsonObject('message') == null ? 'n/a' : omny_enquiry.getString('message')}" target="activityContent"/>
        <activiti:in source="contactId" target="contactId"/>
        <activiti:out source="contactId" target="contactId"/>
        <activiti:out source="activityId" target="activityId"/>
      </extensionElements>
      <incoming>_17</incoming>
      <outgoing>_18</outgoing>
    </callActivity>
    <callActivity calledElement="CreateContactAndAccount" completionQuantity="1" id="_6" isForCompensation="false" name="Create Contact and &#10;Account in CRM" startQuantity="1">
      <extensionElements>
        <activiti:in source="omny_enquiry" target="json"/>
        <activiti:in sourceExpression="omny" target="tenantId"/>
        <activiti:out source="contactId" target="contactId"/>
        <activiti:out source="contactEmail" target="contactEmail"/>
        <activiti:out source="contactPwd" target="contactPwd"/>
        <activiti:out source="accountId" target="accountId"/>
        <activiti:out source="contact" target="contact"/>
      </extensionElements>
      <incoming>_12</incoming>
      <incoming>_13</incoming>
      <outgoing>_26</outgoing>
    </callActivity>
    <sequenceFlow id="_12" sourceRef="_4" targetRef="_6"/>
    <sequenceFlow id="_17" sourceRef="_15" targetRef="addActivityToContact"/>
    <exclusiveGateway gatewayDirection="Converging" id="_15" name="Join">
      <incoming>_26</incoming>
      <incoming>_5</incoming>
      <outgoing>_17</outgoing>
    </exclusiveGateway>
    <endEvent id="endEvent" name="End Event">
      <incoming>_25</incoming>
      <inputSet/>
    </endEvent>
    <callActivity calledElement="SendMemo" completionQuantity="1" id="_23" isForCompensation="false" name="Send Memo" startQuantity="1">
      <extensionElements>
        <activiti:in sourceExpression="ThankYouForEnquiry" target="memoName"/>
        <activiti:in sourceExpression="${omny_enquiry.getString('tenantId')}" target="tenantId"/>
        <activiti:in source="contactId" target="contactId"/>
      </extensionElements>
      <incoming>_19</incoming>
      <outgoing>_25</outgoing>
    </callActivity>
    <sequenceFlow id="_25" sourceRef="_23" targetRef="endEvent"/>
    <sequenceFlow id="_26" sourceRef="_6" targetRef="_15"/>
    <exclusiveGateway default="_13" gatewayDirection="Diverging" id="_8" name="Have contact?">
      <incoming>_9</incoming>
      <outgoing>_13</outgoing>
      <outgoing>_3</outgoing>
    </exclusiveGateway>
    <sequenceFlow id="_9" sourceRef="fetchContact" targetRef="_8"/>
    <sequenceFlow id="_13" name="No" sourceRef="_8" targetRef="_6"/>
    <scriptTask completionQuantity="1" id="_2" isForCompensation="false" name="Select first contact" scriptFormat="JavaScript" startQuantity="1">
      <incoming>_3</incoming>
      <outgoing>_5</outgoing>
      <script><![CDATA[var contacts = execution.getVariable('contacts');
execution.setVariable('contact',contacts.getJsonObject(0));
execution.setVariable('contactId',contacts.getJsonObject(0).getString('selfRef'));]]></script>
    </scriptTask>
    <sequenceFlow id="_3" name="Yes" sourceRef="_8" targetRef="_2">
      <conditionExpression><![CDATA[${!empty(contacts)}]]></conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="_5" sourceRef="_2" targetRef="_15"/>
    <callActivity calledElement="SelectEnquiryResponse" completionQuantity="1" id="selectEnquiryResponse" isForCompensation="false" name="Choose template &#10;to send" startQuantity="1">
      <extensionElements>
        <activiti:in source="omny_enquiry" target="json"/>
        <activiti:in sourceExpression="${omny_enquiry.getString('tenantId')}" target="tenantId"/>
        <activiti:in source="contactId" target="contactId"/>
        <activiti:out source="memoName" target="memoName"/>
      </extensionElements>
      <incoming>_18</incoming>
      <outgoing>_19</outgoing>
    </callActivity>
    <sequenceFlow id="_18" sourceRef="addActivityToContact" targetRef="selectEnquiryResponse"/>
    <sequenceFlow id="_19" sourceRef="selectEnquiryResponse" targetRef="_23"/>
    <textAnnotation id="_11" textFormat="text/plain">
      <text>RECORD ENQUIRY</text>
    </textAnnotation>
    <textAnnotation id="_10" textFormat="text/plain">
      <text>This is not thrown 
at the moment</text>
    </textAnnotation>
    <association associationDirection="None" id="_14" sourceRef="_10" targetRef="_4"/>
  </process>
  <bpmndi:BPMNDiagram id="Yaoqiang_Diagram-RecordEnquiry" name="New Diagram" resolution="96.0">
    <bpmndi:BPMNPlane bpmnElement="RecordEnquiry">
      <bpmndi:BPMNShape bpmnElement="_11" id="Yaoqiang-_11">
        <dc:Bounds height="31.0" width="238.0" x="41.0" y="41.0"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="102.0" x="41.0" y="49.0224609375"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="fetchContact" id="Yaoqiang-fetchContact">
        <dc:Bounds height="91.0" width="119.0" x="121.0512820512821" y="127.71428571428572"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="32.955078125" width="100.0" x="130.5512820512821" y="158.73674665178572"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="startEvent" id="Yaoqiang-startEvent">
        <dc:Bounds height="32.0" width="32.0" x="57.500000000000014" y="157.21428571428572"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="80.0" x="33.5" y="199.51604352678572"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="addActivityToContact" id="Yaoqiang-addActivityToContact" isExpanded="false">
        <dc:Bounds height="91.0" width="119.0" x="664.5" y="292.7142857142857"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="32.955078125" width="72.0" x="688.0" y="323.7367466517857"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_6" id="Yaoqiang-_6" isExpanded="false">
        <dc:Bounds height="91.0" width="119.0" x="245.71428571428572" y="292.7142857142857"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="46.955078125" width="91.0" x="259.7142857142857" y="316.7367466517857"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_15" id="Yaoqiang-_15" isMarkerVisible="true">
        <dc:Bounds height="42.0" width="42.0" x="588.5" y="317.2142857142857"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="26.0" x="596.5" y="361.2142857142857"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="endEvent" id="Yaoqiang-endEvent">
        <dc:Bounds height="32.0" width="32.0" x="1104.0714285714287" y="322.2142857142857"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="58.0" x="1091.0714285714284" y="364.5160435267857"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_23" id="Yaoqiang-_23" isExpanded="false">
        <dc:Bounds height="91.0" width="119.0" x="950.5" y="292.7142857142857"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="67.0" x="976.5" y="330.7367466517857"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_8" id="Yaoqiang-_8" isMarkerVisible="true">
        <dc:Bounds height="42.0" width="42.0" x="284.2142857142857" y="152.21428571428572"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="80.0" x="265.2142857142857" y="196.21428571428572"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_2" id="Yaoqiang-_2">
        <dc:Bounds height="91.0" width="119.0" x="457.3571428571429" y="127.71428571428572"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="105.0" x="464.3571428571429" y="165.73674665178572"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_10" id="Yaoqiang-_10">
        <dc:Bounds height="55.0" width="269.0" x="24.0" y="397.0"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="32.955078125" width="106.0" x="24.0" y="410.0224609375"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="selectEnquiryResponse" id="Yaoqiang-selectEnquiryResponse" isExpanded="false">
        <dc:Bounds height="91.0" width="119.0" x="807.5" y="292.7142857142857"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="32.955078125" width="99.0" x="817.5" y="323.7367466517857"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_4" id="Yaoqiang-_4">
        <dc:Bounds height="32.0" width="32.0" x="189.38235294117646" y="202.71428571428572"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="60.0" x="129.38235294117646" y="243.23674665178572"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge bpmnElement="_19" id="Yaoqiang-_19">
        <di:waypoint x="926.0714285714286" y="338.2142857142857"/>
        <di:waypoint x="950.0714285714286" y="338.2142857142857"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="935.0714285714286" y="328.7367466517857"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_18" id="Yaoqiang-_18">
        <di:waypoint x="783.0714285714286" y="338.2142857142857"/>
        <di:waypoint x="807.0714285714286" y="338.2142857142857"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="792.0714285714286" y="328.7367466517857"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_17" id="Yaoqiang-_17">
        <di:waypoint x="629.8571428571428" y="338.2142857142857"/>
        <di:waypoint x="664.0714285714286" y="338.2142857142857"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="643.9642857142857" y="328.7367466517857"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_9" id="Yaoqiang-_9">
        <di:waypoint x="240.07142857142856" y="173.21428571428572"/>
        <di:waypoint x="284.2857142857143" y="173.21428571428572"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="259.17857142857144" y="163.73674665178572"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_13" id="Yaoqiang-_13">
        <di:waypoint x="305.2142857142857" y="193.85714285714283"/>
        <di:waypoint x="305.2142857142857" y="293.0"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="21.0" x="294.7142857142857" y="233.95103236607142"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_12" id="Yaoqiang-_12">
        <di:waypoint x="202.0" y="234.70243059308373"/>
        <di:waypoint x="202.0" y="323.0"/>
        <di:waypoint x="246.07142857142856" y="323.0"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="199.0" y="291.40939051975613"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_7" id="Yaoqiang-_7">
        <di:waypoint x="89.06999355809698" y="173.21428571428572"/>
        <di:waypoint x="121.07142857142856" y="173.21428571428572"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="102.07071106476278" y="163.73674665178572"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_5" id="Yaoqiang-_5">
        <di:waypoint x="576.0714285714286" y="173.21428571428572"/>
        <di:waypoint x="610.0" y="256.0"/>
        <di:waypoint x="610.0" y="317.92857142857144"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="607.0" y="219.12960379464286"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_3" id="Yaoqiang-_3">
        <di:waypoint x="325.85714285714283" y="173.21428571428572"/>
        <di:waypoint x="457.07142857142856" y="173.21428571428572"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="32.955078125" width="111.0" x="335.96428571428567" y="156.73674665178572"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_26" id="Yaoqiang-_26">
        <di:waypoint x="365.07142857142856" y="336.0"/>
        <di:waypoint x="486.0" y="336.0"/>
        <di:waypoint x="590.0714285714286" y="336.0"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="474.57142857142856" y="326.5224609375"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_25" id="Yaoqiang-_25">
        <di:waypoint x="1069.0714285714284" y="338.2142857142857"/>
        <di:waypoint x="1104.07286358476" y="338.2142857142857"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="1083.5721460780942" y="328.7367466517857"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_14" id="Yaoqiang-_14">
        <di:waypoint x="164.7932708520272" y="397.0"/>
        <di:waypoint x="201.53510313585483" y="234.60430717507006"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="180.16418699394103" y="306.32461452503503"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</definitions>
