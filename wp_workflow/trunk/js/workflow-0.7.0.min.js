function sendMail(){$(".p-messages").empty().append("Sending...").show();$p.sendMessage("inOnly","com.knowprocess.mail.MailData.json",JSON.stringify($p.mail))}$(document).ready(function(){console.info("Document ready handler...");if($("#templates-ctl").length>0){loadTemplates()}});function loadTemplates(){$.getJSON("/wp-content/plugins/syncapt/emails/templates.php",function(A){console.info("Have "+A.length+" templates: "+A);$("#templates-ctl").empty();for(idx in A){$("#templates-ctl").append('<option name="'+A[idx]+'">'+A[idx]+"</option>")}})}$=jQuery;$.fn.moustache=function(B){var A=Mustache.render($(this).html(),B);this.empty().append(A)};EASING_DURATION=500;TAB=9;ENTER=13;function MarkupParser(){this.parse=function(A){var B=new Object();var C=A.split(" ");$.each(C,function(E,H){H=H.toLowerCase();if(H=="--assigned"){B.assignee=username}else{if(H=="--offered"){B.candidateUser=username}else{if(H.substring(0,1)=="+"){if(H.indexOf("@")!=-1){B.user==undefined?B.user=H.substring(1,H.length):B.user+=H.substring(1,H.length);B.user+=","}else{B.group==undefined?B.group=H.substring(1,H.length):B.group+=H.substring(1,H.length);B.group+=","}}else{if(H=="@monday"){console.error("Not yet supported")}else{if(H.substring(0,1)=="@"){var G=H.substring(H.search(/\d/),H.search(/[dwmy]/));var F=H.substring(H.search(/[dwmy]/),H.length).substring(0,1);var D=1;switch(F){case"d":break;case"w":D=7;break;case"m":D=30;break;case"y":D=365;break}B.date=new Date(new Date().getTime()+(D*G*24*60*60*1000))}else{console.error("unhandled expr: "+H)}}}}}});if(B.user!=undefined&&B.user.substring(B.user.length-1,B.user.length)==","){B.user=B.user.substring(0,B.user.length-1)}if(B.group!=undefined&&B.group.substring(B.group.length-1,B.group.length)==","){B.group=B.group.substring(0,B.group.length-1)}return B}}var wf=new App(new Controller());function App(A){this.server="https://www.knowprocess.com";this.locale="en_GB";this.ctrl=A;this.markupParser=new MarkupParser();this.connect=function(B){console.log("connect to "+B);wf.server=B;var C=getSearchParameters()["email"];if(C===undefined){wf.identity()}else{console.log("Logged in as "+C);wf.username=C;wf.ctrl.loadImage(wf.username)}};this.init=function(){if(window.PhoneGap===undefined&&window.Cordova===undefined){console.log("Environment: Browser")}else{console.log("Environment: PhoneGap/Cordova")}$("#nav").moustache(wf);console.log("Setting up menu");if(wf.urlParam("test")!==undefined&&wf.urlParam("test")!=null){$("#selfTest").removeClass("hidden")}$(".search-query").on("keydown",function(C){var B=C.keyCode||C.charCode;if(B==TAB||B==ENTER){wf.taskList(wf.markupParser.parse($(".search-query").val()));C.preventDefault()}});$("#serverUrl").val(wf.server);wf.connect(wf.server);$(document).ajaxSuccess(function(){console.log("Triggered ajaxSuccess handler.");wf.initDeferred()})};this.initDeferred=function(){};this.transition=function(B){console.log("transition...");$(".nav li").removeClass("active");$("[data-section]").each(function(D,E){$("#"+$(E).data("section")).hide()});var C=$(B).parent().addClass("active").data("section");console.log("... to "+C);$("#"+C).show().removeClass("hidden")};this.addDeploymentResource=function(){$("#deployProcessTemplate > fieldset").append($("#resourceControl").html())};this.addFormControls=function(B){$.each(B.formProperties,function(C,D){console.log("create control for "+D.id);D.requiredattr=function(){console.log("setting required = "+D.required);if(D.required){return"required"}};D.control=function(){console.log("ctrl: "+D.type);switch(D.type){case"date":return function(F,E){console.log("date ctrl: "+F);return E(F.replace(/input-xlarge/g,"input-medium"))};case"enum":return function(G,F){console.log("enum 2: ");G='<select class="input-xlarge" id="'+D.id+'" name="'+D.id+'">';if(!D.required){G+="<option></option>"}for(var E in D.enumValues){G+='<option value="'+D.enumValues[E].id+'">'+D.enumValues[E].name+"</option>"}G+="</select>";return G};default:return function(F,E){console.log("ctrl 2: "+F);return E(F)}}}})};this.definitionCategory=function(B,C){console.log("setting category of "+B+" to "+C);return $.ajax({type:"PUT",url:wf.server+"/process-definitions/"+B,contentType:"application/json",data:'{"category" : "'+C+'"}',dataType:"json",success:function(D){console.log("successfully updated category")},error:function(D,F,E){console.log("error:"+F)}})};this.definitionList=function(){if(wf.ctrl.offline){wf.ctrl.loadInstanceList(JSON.parse(localStorage.GET_repository_definitions))}else{return $.ajax({type:"GET",url:wf.server+"/process-definitions",contentType:"application/json",dataType:"text",success:function(B){console.log("success fetching definitions");localStorage.GET_repository_definitions=B;wf.ctrl.renderDefinitionsList(JSON.parse(B))},error:function(B,D,C){console.log("error:"+D+":"+C);console.log("  headers: "+JSON.stringify(B.getAllResponseHeaders()))}})}};this.definitionUpload=function(D){console.log("definitionUpload, id: "+D);wf.showActivityIndicator("Uploading definition...");var B=document.getElementById(D);var C=new FormData(B);return $.ajax({type:"POST",url:wf.server+"/deployments",data:C,cache:false,contentType:false,processData:false,success:function(E){wf.hideActivityIndicator("successfully uploaded definition")},error:function(E,H,F){console.log(H+":"+F+","+E.responseText);var G=JSON.parse(E.responseText.replace(/\n/g,""));wf.hideActivityIndicator("Failed to upload definition, error is: "+G.error)}})};this.deleteDefinition=function(C,B){console.log("delete: "+B);return $.ajax({type:"DELETE",url:wf.server+"/deployments/"+B,contentType:"application/json",dataType:"text",success:function(){console.log("successfully deleted:"+C);$('[data-id="'+C+'"]').hide(EASING_DURATION)},error:function(D,F,E){console.log("error:"+F)}})};this.deleteInstance=function(B){console.log("delete instance: "+B);return $.ajax({type:"DELETE",url:wf.server+"/process-instances/"+B,contentType:"application/json",dataType:"json",success:function(C){console.log("successfully deleted:"+B);$('[data-id="'+B+'"]').hide(EASING_DURATION)},error:function(C,E,D){console.log("error:"+E)}})};this.help=function(){return $.ajax({type:"GET",url:"/markup.html",success:function(B){$("#helpSect").empty().append(B.replace(/h2/g,"h4").replace(/h3/g,"h5"))},error:function(B,D,C){console.log("error:"+D)}})};this.identity=function(){console.log("find identity of current user");return $.ajax({type:"GET",url:wf.server+"/identity.jspx",contentType:"application/json",dataType:"json",success:function(B){console.log("success fetching identity:"+B);if(B.email===undefined){window.location.href=wf.server+"/login.html"}else{wf.currentIdentity=B;wf.username=wf.currentIdentity.email;wf.ctrl.loadImage(wf.username)}},error:function(B,D,C){console.log(D+":"+C);if(wf.server==""){wf.showActivityIndicator("Enter BPMS server url to connect to.")}else{window.location.href=wf.server+"/login?callback="+window.location.href}}})};this.instance=function(C,B){console.log("loading instance start form: "+C+", "+B);return $.ajax({type:"GET",url:wf.server+"/process-definitions/"+C,contentType:"application/json",dataType:"json",success:function(D){console.log("success fetching instance:"+D);wf.activeInstance=D;wf.activeInstance.name=B;wf.addFormControls(wf.activeInstance);$("#instance").html($("#startFormTemplate").html()).moustache(wf.activeInstance);$("#startInstanceModal .btn-primary").on("click",function(){wf.newInstance(wf.activeInstance.processDefinitionId,$("#instance").serializeArray())})},error:function(D,F,E){console.log(F+":"+E)}})};this.instanceAudit=function(B){console.log("TODO Request audit trail for "+B)};this.instanceBusinessKey=function(C){var D=bpms.adapt(JSON.parse(localStorage.GET_runtime_instances));var B;$.each(D,function(E,F){console.info("checking "+F.id+" matches "+C+": "+(F.id==C));if(F.id==C){console.log("returning businessKey: "+F.businessKey);B=F.businessKey}});return B};this.instanceList=function(B){console.info("instance list, filtered by: "+JSON.stringify(B));if(wf.ctrl.offline){wf.ctrl.loadInstanceList(JSON.parse(localStorage.GET_runtime_instances))}else{return $.ajax({type:"GET",url:wf.server+"/process-instances",contentType:"application/json",dataType:"text",success:function(C){localStorage.GET_runtime_instances=C;var D=JSON.parse(C);console.log("success fetching instance list:"+D.length);wf.ctrl.loadInstanceList(D)},error:function(C,E,D){console.log("error:"+E)}})}};this.loadForm=function(B){wf.showActivityIndicator("Loading...");if(!B.formKey.endsWith(".html")){B.formKey+=".html"}var C=B.formKey.substring(B.formKey.lastIndexOf(".")+1)=="js"?"script":"html";return $.ajax({type:"GET",url:B.formKey,dataType:C,success:function(D){console.log("successfully fetched form: "+D);switch(C){case"script":console.log("dont think its a good idea to exec arbitrary code");break;default:$("#taskModal .form-inline").empty().append(D)}wf.hideActivityIndicator()},error:function(D,F,E){console.log("error:"+F);wf.hideActivityIndicator()}})};this.logout=function(){window.location.href=wf.server+"/resources/j_spring_security_logout"};this.nav=function(){console.log("nav");return[{entity:"sop"},{entity:"message"},{entity:"upload"},{entity:"definition"},{entity:"instance"}]};this.newInstance=function(D,E){console.log("newInstance of "+D+", passing "+JSON.stringify(E));E.push({name:"initiator",value:"tim"});var B="myBusinessKey"+new Date().getTime();$.each(E,function(F,G){if(G.name=="businessKey"){B=G.value}});var C='{ "processDefinitionId":"'+D+'","businessKey":"'+B+'","variables":'+JSON.stringify(E)+" }";console.log("Payload:"+C);wf.showActivityIndicator("Starting instance...");return $.ajax({type:"POST",url:wf.server+"/process-instances",contentType:"application/json",data:C,dataType:"json",success:function(F){console.log("successfully start instance:"+JSON.stringify(F));wf.instance=F.data;wf.hideActivityIndicator("Instance started successfully")},error:function(F,H,G){console.log("error:"+H)}})};this.newMessage=function(C,F,E){console.log("starting "+F+'="'+E+'" as mep: '+C);wf.showActivityIndicator("Starting instance...");var B=(C=="inOut"?"GET":"POST");E=(E.length==0?"":JSON.stringify(JSON.parse(E)));var D=(C=="inOut"?{query:E}:{json:E});console.log("msg: "+E);return $.ajax({type:B,url:wf.server+"/msg/"+F,data:D,dataType:"text",timeout:30000,success:function(G,I,H){console.log("successfully start instance by msg: "+H.getResponseHeader("Location"));wf.hideActivityIndicator("Instance started successfully")},error:function(G,I,H){wf.hideActivityIndicatorWithError(G)}})};this.profile=function(){console.log("loading profile for: "+wf.username);return $.ajax({type:"GET",url:wf.server+"/users/"+wf.username,contentType:"application/json",dataType:"json",success:function(B){console.log("success fetching profile:"+B);var C=new Array();wf.activeProfile=B;$.each(wf.activeProfile.info,function(D,E){C[E.key.replace(".","_")]=E.value});wf.activeProfile.info=C;$("#linkedInForm").attr("action",wf.server+"/linkedin");$("#linkedInForm input").val(wf.activeProfile.email);wf.activeProfile.info.linkedIn_connect=(wf.activeProfile.info.linkedIn_secret===undefined);if(!wf.activeProfile.info.linkedIn_connect){$("#linkedInConnectedMsg").removeClass("hidden")}$("#profile").html($("#profileTemplate").html()).moustache(wf.activeProfile)},error:function(B,D,C){console.log(D+":"+C)}})};this.profileUpdate=function(D){console.log("profileUpdate passing "+D);var B=new ObjectHelper().arrToObj(D);B.info=[];for(i in B){if(i!="username"&&i!="firstName"&&i!="lastName"&&i!="info"){console.log("set "+i+" to "+B[i]);B.info.push({key:i,value:B[i]})}}var C=JSON.stringify(B);console.log("Payload:"+C);wf.showActivityIndicator("Updating profile...");return $.ajax({type:"PUT",url:wf.server+"/users/"+B.username+".json",contentType:"application/json",data:C,dataType:"text",success:function(E){console.log("successfully updated profile:"+JSON.stringify(E));wf.activeProfile=E.data;wf.hideActivityIndicator("Profile updated successfully")},error:function(E,G,F){console.log(G+":"+F);wf.hideActivityIndicator(G+":"+F)}})};this.sopList=function(){console.log("sops");wf.sops=[{key:"GTD",name:"Collect Stuff",description:"Collect everything that is competing for your time to 'Get Things Done'"}];$("#sops").moustache(app)};this.task=function(D,C,B){console.log("loading task: "+D+", "+C);if(wf.ctrl.offline){wf.ctrl.loadTask(D,C,B,JSON.parse(localStorage.GET_runtime_tasks))}else{return $.ajax({type:"GET",url:wf.server+"/tasks/"+escape(D),contentType:"application/json",dataType:"json",success:function(E){console.log("success fetching task:"+JSON.stringify(E));wf.ctrl.loadTask(D,C,B,[E])},error:function(E,G,F){console.log(G+":"+F)}})}};this.taskList=function(B){console.log("task list, filtered by: "+JSON.stringify(B));$p.getResource("/tasks",B,wf.ctrl.taskList)};this.updateTask=function(B,E){console.log("updateTask of "+B+", passing "+E);var C="complete";var D='{ "action":"'+C+'","variables":'+JSON.stringify(E)+" }";console.log("Payload:"+D);wf.showActivityIndicator("Submitting task...");return $.ajax({type:"POST",url:wf.server+"/tasks/"+B,contentType:"application/json",data:D,dataType:"text",success:function(F){console.log("successfully updated task:"+JSON.stringify(F));wf.activeTask=F.data;wf.hideActivityIndicator("Task submitted successfully");wf.taskList()},error:function(F,H,G){console.log(H+":"+G)}})};this.uploadDefinition=function(C){console.log("uploadDefinition, passing: "+C);var B='{ "variables":'+JSON.stringify(C)+" }";console.log("Payload:"+B);wf.showActivityIndicator("Submitting new definition...");return $.ajax({type:"POST",url:wf.server+"/deployments",contentType:"application/json",data:B,dataType:"json",success:function(D){console.log("successfully uploaded definition:"+JSON.stringify(D));wf.hideActivityIndicator("successfully uploaded definition")},error:function(D,F,E){console.log(F+":"+E)}})};this.uploadList=function(){console.log("Nothing required")};this.urlParam=function(B){var C=(location.search.match(RegExp("[?|&]"+B+"=(.+?)(&|$)"))||[,null])[1];return C==null?null:decodeURIComponent(C)};this.showMessage=function(B){if(B===undefined){B="Working..."}$(".a-messages").empty().append(B).addClass("blink").show()};this.showActivityIndicator=function(B){document.body.style.cursor="progress";this.showMessage(B)};this.hideActivityIndicator=function(B){if(B===undefined){B="Success!"}$(".a-messages").empty().append(B).removeClass("blink");document.body.style.cursor="auto";setTimeout(function(){$(".a-messages").fadeOut()},EASING_DURATION*10)};this.hideActivityIndicatorWithError=function(B){console.log(B.statusText+":"+B.responseText);var C=JSON.parse(B.responseText.replace(/\n/g,""));$(".a-messages").empty().append(C.error).removeClass("blink");document.body.style.cursor="auto";setTimeout(function(){$(".a-messages").fadeOut()},EASING_DURATION*10)}}function Controller(){this.offline=false;this.renderDefinitionsList=function(A){wf.definitions=bpms.adapt(A);$.each(wf.definitions,function(B,C){if(C.name==null){C.name=C.key}});$("#definitions").html($("#definitionsTemplate").html()).moustache(app);$("[data-instance]").click(function(){wf.instance($(this).data("instance"),$(this).data("name"))});$(".a-definition-category[contenteditable]").on("input",function(){console.log("fired change handler for "+$(this).data("id"));if($(this).text().trim().length>0){wf.definitionCategory($(this).data("id"),$(this).text().trim())}})};this.loadImage=function(B,C,A){console.log("loadImage for: "+B);if(C===undefined){C=30}if(A===undefined){A=".kp-profile"}$(A).empty().append("<a>");$(A+" > a").append('<img class="img-rounded" style="margin-top:5px;" title="Logged in as '+B+'. Image from Gravatar.com" src="http://www.gravatar.com/avatar/'+hex_md5(B)+"?s="+C+'&d=mm"/>')};this.loadInstanceList=function(A){wf.instances=bpms.adapt(A);console.log("instances found: "+wf.instances.length);$("#instances").html($("#instancesTemplate").html()).moustache(app)};this.loadTask=function(D,B,A,C){console.log("load task id:"+D+", name"+B);wf.activeTask=taskFromTasks(C,D);wf.activeTask.name=B;$("#taskTitle").html($("#taskTitleTemplate").html()).moustache(wf.activeTask);$("#taskModal .a-business-key").empty().append(A);if(wf.activeTask.formKey==null){wf.addFormControls(wf.activeTask);$("#task").html($("#formDataTemplate").html()).moustache(wf.activeTask)}else{wf.loadForm(wf.activeTask)}$("#taskModal .btn-primary").on("click",function(){wf.updateTask(wf.activeTask.taskId,$("#task").serializeArray())})};this.loadTaskList=function(A){console.log("success fetching task list");wf.tasks=bpms.adapt(A);$.each(wf.tasks,function(B,C){C.createString=i18n.getAgeString(new Date(C.createTime));C.dueString=i18n.getDeadlineString(new Date(C.dueDate))});$("#tasks").html($("#tasksTemplate").html()).moustache(app);$.each($("#tasks .a-business-key"),function(C,D){var B=wf.instanceBusinessKey($(D).data("instance"));console.log("found key: "+B);if(B!==undefined){$(D).empty().append(B);$("#tasks .a-task-link").data("business-key",B)}});$("[data-task]").click(function(){wf.task($(this).data("task"),$(this).data("name"),$(this).data("business-key"))})};this.sendMessage=function(A,D,C,B){$("#"+B+" .a-response").addClass("hidden");jqXHR=wf.newMessage(A,D,C);jqXHR.success(function(F,H,G){$("#"+B+" .a-response").removeClass("hidden");var E=G.getResponseHeader("Location");if(E==null){E=G.getResponseHeader("Content-Location")}$("#"+B+" #responseLocation").empty().append('<a href="'+E+'">View</a>')})}}function taskFromTasks(B,C){console.log("taskFromTasks, seeking id="+C+" from "+B.length);var A;$.each(B,function(D,E){console.log("checking "+JSON.stringify(E));if(E!==undefined&&(E.id==C||E.taskId==C)){A=E}});return A}function getSearchParameters(){var A=window.location.search.substr(1);return A!=null&&A!=""?transformToAssocArray(A):{}}function transformToAssocArray(A){var E={};var C=A.split("&");for(var B=0;B<C.length;B++){var D=C[B].split("=");E[D[0]]=D[1]}return E}var bpms=new BpmsAdapter();function BpmsAdapter(){this.adapt=function(B,A){if(B.data===undefined){console.log("deteted a-roo, setting: "+A+" to "+B);A=B;console.log(A)}else{A=B.data}return A}}function ObjectHelper(){this.arrToObj=function(A){var B=new Object();for(idx in A){B[A[idx].name]=A[idx].value}return B}}
/*
 * From: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/endsWith 
 * This method has been added to the ECMAScript 6 specification and may not be 
 * available in all JavaScript implementations yet
 * http://mths.be/endswith v0.2.0 by @mathias 
 */
if(!String.prototype.endsWith){(function(){var A=(function(){try{var G={};var F=Object.defineProperty;var D=F(G,G,G)&&F}catch(E){}return D}());var C={}.toString;var B=function(L){if(this==null){throw TypeError()}var I=String(this);if(L&&C.call(L)=="[object RegExp]"){throw TypeError()}var D=I.length;var M=String(L);var G=M.length;var K=D;if(arguments.length>1){var H=arguments[1];if(H!==undefined){K=H?Number(H):0;if(K!=K){K=0}}}var F=Math.min(Math.max(K,0),D);var E=F-G;if(E<0){return false}var J=-1;while(++J<G){if(I.charCodeAt(E+J)!=M.charCodeAt(J)){return false}}return true};if(A){A(String.prototype,"endsWith",{value:B,configurable:true,writable:true})}else{String.prototype.endsWith=B}}())};