function sendMail(){$(".p-messages").empty().append("Sending...").show();$p.sendMessage("inOnly","com.knowprocess.mail.MailData.json",JSON.stringify($p.mail))}$(document).ready(function(){console.debug("Document ready handler...");loadTemplates()});function loadTemplates(){$.getJSON("/wp-content/plugins/syncapt/emails/templates.php",function(a){console.debug("Have "+a.length+" templates: "+a);$("#templates-ctl").empty();for(idx in a){$("#templates-ctl").append('<option name="'+a[idx]+'">'+a[idx]+"</option>")}})}$=jQuery;$.fn.moustache=function(b){var a=Mustache.render($(this).html(),b);this.empty().append(a)};EASING_DURATION=500;TAB=9;ENTER=13;function MarkupParser(){this.parse=function(a){var b=new Object();var c=a.split(" ");$.each(c,function(f,j){j=j.toLowerCase();if(j=="--assigned"){b.assignee=username}else{if(j=="--offered"){b.candidateUser=username}else{if(j.substring(0,1)=="+"){if(j.indexOf("@")!=-1){b.user==undefined?b.user=j.substring(1,j.length):b.user+=j.substring(1,j.length);b.user+=","}else{b.group==undefined?b.group=j.substring(1,j.length):b.group+=j.substring(1,j.length);b.group+=","}}else{if(j=="@monday"){console.error("Not yet supported")}else{if(j.substring(0,1)=="@"){var h=j.substring(j.search(/\d/),j.search(/[dwmy]/));var g=j.substring(j.search(/[dwmy]/),j.length).substring(0,1);var e=1;switch(g){case"d":break;case"w":e=7;break;case"m":e=30;break;case"y":e=365;break}b.date=new Date(new Date().getTime()+(e*h*24*60*60*1000))}else{console.error("unhandled expr: "+j)}}}}}});if(b.user!=undefined&&b.user.substring(b.user.length-1,b.user.length)==","){b.user=b.user.substring(0,b.user.length-1)}if(b.group!=undefined&&b.group.substring(b.group.length-1,b.group.length)==","){b.group=b.group.substring(0,b.group.length-1)}return b}}var wf=new App(new Controller());function App(a){this.server="https://www.knowprocess.com";this.locale="en_GB";this.ctrl=a;this.markupParser=new MarkupParser();this.connect=function(b){console.log("connect to "+b);wf.server=b;var c=getSearchParameters()["email"];if(c===undefined){wf.identity()}else{console.log("Logged in as "+c);wf.username=c;wf.ctrl.loadImage(wf.username)}};this.init=function(){if(window.PhoneGap===undefined&&window.Cordova===undefined){console.log("Environment: Browser")}else{console.log("Environment: PhoneGap/Cordova")}$("#nav").moustache(wf);console.log("Setting up menu");if(wf.urlParam("test")!==undefined&&wf.urlParam("test")!=null){$("#selfTest").removeClass("hidden")}$(".search-query").on("keydown",function(c){var b=c.keyCode||c.charCode;if(b==TAB||b==ENTER){wf.taskList(wf.markupParser.parse($(".search-query").val()));c.preventDefault()}});$("#serverUrl").val(wf.server);wf.connect(wf.server);$(document).ajaxSuccess(function(){console.log("Triggered ajaxSuccess handler.");wf.initDeferred()})};this.initDeferred=function(){};this.transition=function(b){console.log("transition...");$(".nav li").removeClass("active");$("[data-section]").each(function(e,f){$("#"+$(f).data("section")).hide()});var c=$(b).parent().addClass("active").data("section");console.log("... to "+c);$("#"+c).show().removeClass("hidden")};this.addDeploymentResource=function(){$("#deployProcessTemplate > fieldset").append($("#resourceControl").html())};this.addFormControls=function(b){$.each(b.formProperties,function(c,e){console.log("create control for "+e.id);e.requiredattr=function(){console.log("setting required = "+e.required);if(e.required){return"required"}};e.control=function(){console.log("ctrl: "+e.type);switch(e.type){case"date":return function(f,d){console.log("date ctrl: "+f);return d(f.replace(/input-xlarge/g,"input-medium"))};case"enum":return function(g,f){console.log("enum 2: ");g='<select class="input-xlarge" id="'+e.id+'" name="'+e.id+'">';if(!e.required){g+="<option></option>"}for(var d in e.enumValues){g+='<option value="'+e.enumValues[d].id+'">'+e.enumValues[d].name+"</option>"}g+="</select>";return g};default:return function(f,d){console.log("ctrl 2: "+f);return d(f)}}}})};this.definitionCategory=function(b,c){console.log("setting category of "+b+" to "+c);return $.ajax({type:"PUT",url:wf.server+"/process-definitions/"+b,contentType:"application/json",data:'{"category" : "'+c+'"}',dataType:"json",success:function(d){console.log("successfully updated category")},error:function(d,f,e){console.log("error:"+f)}})};this.definitionList=function(){if(wf.ctrl.offline){wf.ctrl.loadInstanceList(JSON.parse(localStorage.GET_repository_definitions))}else{return $.ajax({type:"GET",url:wf.server+"/process-definitions",contentType:"application/json",dataType:"text",success:function(b){console.log("success fetching definitions");localStorage.GET_repository_definitions=b;wf.ctrl.renderDefinitionsList(JSON.parse(b))},error:function(b,d,c){console.log("error:"+d+":"+c);console.log("  headers: "+JSON.stringify(b.getAllResponseHeaders()))}})}};this.definitionUpload=function(d){console.log("definitionUpload, id: "+d);wf.showActivityIndicator("Uploading definition...");var b=document.getElementById(d);var c=new FormData(b);return $.ajax({type:"POST",url:wf.server+"/deployments",data:c,cache:false,contentType:false,processData:false,success:function(e){wf.hideActivityIndicator("successfully uploaded definition")},error:function(e,h,f){console.log(h+":"+f+","+e.responseText);var g=JSON.parse(e.responseText.replace(/\n/g,""));wf.hideActivityIndicator("Failed to upload definition, error is: "+g.error)}})};this.deleteDefinition=function(c,b){console.log("delete: "+b);return $.ajax({type:"DELETE",url:wf.server+"/deployments/"+b,contentType:"application/json",dataType:"text",success:function(){console.log("successfully deleted:"+c);$('[data-id="'+c+'"]').hide(EASING_DURATION)},error:function(d,f,e){console.log("error:"+f)}})};this.deleteInstance=function(b){console.log("delete instance: "+b);return $.ajax({type:"DELETE",url:wf.server+"/process-instances/"+b,contentType:"application/json",dataType:"json",success:function(c){console.log("successfully deleted:"+b);$('[data-id="'+b+'"]').hide(EASING_DURATION)},error:function(c,e,d){console.log("error:"+e)}})};this.help=function(){return $.ajax({type:"GET",url:"/markup.html",success:function(b){$("#helpSect").empty().append(b.replace(/h2/g,"h4").replace(/h3/g,"h5"))},error:function(b,d,c){console.log("error:"+d)}})};this.identity=function(){console.log("find identity of current user");return $.ajax({type:"GET",url:wf.server+"/identity.jspx",contentType:"application/json",dataType:"json",success:function(b){console.log("success fetching identity:"+b);if(b.email===undefined){window.location.href=wf.server+"/login.html"}else{wf.currentIdentity=b;wf.username=wf.currentIdentity.email;wf.ctrl.loadImage(wf.username)}},error:function(b,d,c){console.log(d+":"+c);if(wf.server==""){wf.showActivityIndicator("Enter BPMS server url to connect to.")}else{window.location.href=wf.server+"/login?callback="+window.location.href}}})};this.instance=function(c,b){console.log("loading instance start form: "+c+", "+b);return $.ajax({type:"GET",url:wf.server+"/process-definitions/"+c,contentType:"application/json",dataType:"json",success:function(d){console.log("success fetching instance:"+d);wf.activeInstance=d;wf.activeInstance.name=b;wf.addFormControls(wf.activeInstance);$("#instance").html($("#startFormTemplate").html()).moustache(wf.activeInstance);$("#startInstanceModal .btn-primary").on("click",function(){wf.newInstance(wf.activeInstance.processDefinitionId,$("#instance").serializeArray())})},error:function(d,f,e){console.log(f+":"+e)}})};this.instanceAudit=function(b){console.log("TODO Request audit trail for "+b)};this.instanceBusinessKey=function(c){var d=bpms.adapt(JSON.parse(localStorage.GET_runtime_instances));var b;$.each(d,function(e,f){console.debug("checking "+f.id+" matches "+c+": "+(f.id==c));if(f.id==c){console.log("returning businessKey: "+f.businessKey);b=f.businessKey}});return b};this.instanceList=function(b){console.info("instance list, filtered by: "+JSON.stringify(b));if(wf.ctrl.offline){wf.ctrl.loadInstanceList(JSON.parse(localStorage.GET_runtime_instances))}else{return $.ajax({type:"GET",url:wf.server+"/process-instances",contentType:"application/json",dataType:"text",success:function(c){localStorage.GET_runtime_instances=c;var d=JSON.parse(c);console.log("success fetching instance list:"+d.length);wf.ctrl.loadInstanceList(d)},error:function(c,e,d){console.log("error:"+e)}})}};this.loadForm=function(b){wf.showActivityIndicator("Loading...");if(!b.formKey.endsWith(".html")){b.formKey+=".html"}var c=b.formKey.substring(b.formKey.lastIndexOf(".")+1)=="js"?"script":"html";return $.ajax({type:"GET",url:b.formKey,dataType:c,success:function(d){console.log("successfully fetched form: "+d);switch(c){case"script":console.log("dont think its a good idea to exec arbitrary code");break;default:$("#taskModal .form-inline").empty().append(d)}wf.hideActivityIndicator()},error:function(d,f,e){console.log("error:"+f);wf.hideActivityIndicator()}})};this.logout=function(){window.location.href=wf.server+"/resources/j_spring_security_logout"};this.nav=function(){console.log("nav");return[{entity:"sop"},{entity:"message"},{entity:"upload"},{entity:"definition"},{entity:"instance"}]};this.newInstance=function(d,e){console.log("newInstance of "+d+", passing "+JSON.stringify(e));e.push({name:"initiator",value:"tim"});var b="myBusinessKey"+new Date().getTime();$.each(e,function(f,g){if(g.name=="businessKey"){b=g.value}});var c='{ "processDefinitionId":"'+d+'","businessKey":"'+b+'","variables":'+JSON.stringify(e)+" }";console.log("Payload:"+c);wf.showActivityIndicator("Starting instance...");return $.ajax({type:"POST",url:wf.server+"/process-instances",contentType:"application/json",data:c,dataType:"json",success:function(f){console.log("successfully start instance:"+JSON.stringify(f));wf.instance=f.data;wf.hideActivityIndicator("Instance started successfully")},error:function(f,h,g){console.log("error:"+h)}})};this.newMessage=function(c,g,f){console.log("starting "+g+'="'+f+'" as mep: '+c);wf.showActivityIndicator("Starting instance...");var b=(c=="inOut"?"GET":"POST");f=(f.length==0?"":JSON.stringify(JSON.parse(f)));var e=(c=="inOut"?{query:f}:{json:f});console.log("msg: "+f);return $.ajax({type:b,url:wf.server+"/msg/"+g,data:e,dataType:"text",timeout:30000,success:function(d,j,h){console.log("successfully start instance by msg: "+h.getResponseHeader("Location"));wf.hideActivityIndicator("Instance started successfully")},error:function(d,j,h){wf.hideActivityIndicatorWithError(d)}})};this.profile=function(){console.log("loading profile for: "+wf.username);return $.ajax({type:"GET",url:wf.server+"/users/"+wf.username,contentType:"application/json",dataType:"json",success:function(b){console.log("success fetching profile:"+b);var c=new Array();wf.activeProfile=b;$.each(wf.activeProfile.info,function(e,f){c[f.key.replace(".","_")]=f.value});wf.activeProfile.info=c;$("#linkedInForm").attr("action",wf.server+"/linkedin");$("#linkedInForm input").val(wf.activeProfile.email);wf.activeProfile.info.linkedIn_connect=(wf.activeProfile.info.linkedIn_secret===undefined);if(!wf.activeProfile.info.linkedIn_connect){$("#linkedInConnectedMsg").removeClass("hidden")}$("#profile").html($("#profileTemplate").html()).moustache(wf.activeProfile)},error:function(b,d,c){console.log(d+":"+c)}})};this.profileUpdate=function(d){console.log("profileUpdate passing "+d);var b=new ObjectHelper().arrToObj(d);b.info=[];for(i in b){if(i!="username"&&i!="firstName"&&i!="lastName"&&i!="info"){console.log("set "+i+" to "+b[i]);b.info.push({key:i,value:b[i]})}}var c=JSON.stringify(b);console.log("Payload:"+c);wf.showActivityIndicator("Updating profile...");return $.ajax({type:"PUT",url:wf.server+"/users/"+b.username+".json",contentType:"application/json",data:c,dataType:"text",success:function(e){console.log("successfully updated profile:"+JSON.stringify(e));wf.activeProfile=e.data;wf.hideActivityIndicator("Profile updated successfully")},error:function(e,g,f){console.log(g+":"+f);wf.hideActivityIndicator(g+":"+f)}})};this.sopList=function(){console.log("sops");wf.sops=[{key:"GTD",name:"Collect Stuff",description:"Collect everything that is competing for your time to 'Get Things Done'"}];$("#sops").moustache(app)};this.task=function(d,c,b){console.log("loading task: "+d+", "+c);if(wf.ctrl.offline){wf.ctrl.loadTask(d,c,b,JSON.parse(localStorage.GET_runtime_tasks))}else{return $.ajax({type:"GET",url:wf.server+"/tasks/"+escape(d),contentType:"application/json",dataType:"json",success:function(e){console.log("success fetching task:"+JSON.stringify(e));wf.ctrl.loadTask(d,c,b,[e])},error:function(e,g,f){console.log(g+":"+f)}})}};this.taskList=function(b){console.log("task list, filtered by: "+JSON.stringify(b));$p.getResource("/tasks",b,wf.ctrl.taskList)};this.updateTask=function(b,e){console.log("updateTask of "+b+", passing "+e);var c="complete";var d='{ "action":"'+c+'","variables":'+JSON.stringify(e)+" }";console.log("Payload:"+d);wf.showActivityIndicator("Submitting task...");return $.ajax({type:"POST",url:wf.server+"/tasks/"+b,contentType:"application/json",data:d,dataType:"text",success:function(f){console.log("successfully updated task:"+JSON.stringify(f));wf.activeTask=f.data;wf.hideActivityIndicator("Task submitted successfully");wf.taskList()},error:function(f,h,g){console.log(h+":"+g)}})};this.uploadDefinition=function(c){console.log("uploadDefinition, passing: "+c);var b='{ "variables":'+JSON.stringify(c)+" }";console.log("Payload:"+b);wf.showActivityIndicator("Submitting new definition...");return $.ajax({type:"POST",url:wf.server+"/deployments",contentType:"application/json",data:b,dataType:"json",success:function(d){console.log("successfully uploaded definition:"+JSON.stringify(d));wf.hideActivityIndicator("successfully uploaded definition")},error:function(d,f,e){console.log(f+":"+e)}})};this.uploadList=function(){console.log("Nothing required")};this.urlParam=function(b){var c=(location.search.match(RegExp("[?|&]"+b+"=(.+?)(&|$)"))||[,null])[1];return c==null?null:decodeURIComponent(c)};this.showMessage=function(b){if(b===undefined){b="Working..."}$(".a-messages").empty().append(b).addClass("blink").show()};this.showActivityIndicator=function(b){document.body.style.cursor="progress";this.showMessage(b)};this.hideActivityIndicator=function(b){if(b===undefined){b="Success!"}$(".a-messages").empty().append(b).removeClass("blink");document.body.style.cursor="auto";setTimeout(function(){$(".a-messages").fadeOut()},EASING_DURATION*10)};this.hideActivityIndicatorWithError=function(b){console.log(b.statusText+":"+b.responseText);var c=JSON.parse(b.responseText.replace(/\n/g,""));$(".a-messages").empty().append(c.error).removeClass("blink");document.body.style.cursor="auto";setTimeout(function(){$(".a-messages").fadeOut()},EASING_DURATION*10)}}function Controller(){this.offline=false;this.renderDefinitionsList=function(a){wf.definitions=bpms.adapt(a);$.each(wf.definitions,function(b,c){if(c.name==null){c.name=c.key}});$("#definitions").html($("#definitionsTemplate").html()).moustache(app);$("[data-instance]").click(function(){wf.instance($(this).data("instance"),$(this).data("name"))});$(".a-definition-category[contenteditable]").on("input",function(){console.log("fired change handler for "+$(this).data("id"));if($(this).text().trim().length>0){wf.definitionCategory($(this).data("id"),$(this).text().trim())}})};this.loadImage=function(b,c,a){console.log("loadImage for: "+b);if(c===undefined){c=30}if(a===undefined){a=".kp-profile"}$(a).empty().append("<a>");$(a+" > a").append('<img class="img-rounded" style="margin-top:5px;" title="Logged in as '+b+'. Image from Gravatar.com" src="http://www.gravatar.com/avatar/'+hex_md5(b)+"?s="+c+'&d=mm"/>')};this.loadInstanceList=function(a){wf.instances=bpms.adapt(a);console.log("instances found: "+wf.instances.length);$("#instances").html($("#instancesTemplate").html()).moustache(app)};this.loadTask=function(d,b,a,c){console.log("load task id:"+d+", name"+b);wf.activeTask=taskFromTasks(c,d);wf.activeTask.name=b;$("#taskTitle").html($("#taskTitleTemplate").html()).moustache(wf.activeTask);$("#taskModal .a-business-key").empty().append(a);if(wf.activeTask.formKey==null){wf.addFormControls(wf.activeTask);$("#task").html($("#formDataTemplate").html()).moustache(wf.activeTask)}else{wf.loadForm(wf.activeTask)}$("#taskModal .btn-primary").on("click",function(){wf.updateTask(wf.activeTask.taskId,$("#task").serializeArray())})};this.loadTaskList=function(a){console.log("success fetching task list");wf.tasks=bpms.adapt(a);$.each(wf.tasks,function(b,c){c.createString=i18n.getAgeString(new Date(c.createTime));c.dueString=i18n.getDeadlineString(new Date(c.dueDate))});$("#tasks").html($("#tasksTemplate").html()).moustache(app);$.each($("#tasks .a-business-key"),function(c,e){var b=wf.instanceBusinessKey($(e).data("instance"));console.log("found key: "+b);if(b!==undefined){$(e).empty().append(b);$("#tasks .a-task-link").data("business-key",b)}});$("[data-task]").click(function(){wf.task($(this).data("task"),$(this).data("name"),$(this).data("business-key"))})};this.sendMessage=function(a,d,c,b){$("#"+b+" .a-response").addClass("hidden");jqXHR=wf.newMessage(a,d,c);jqXHR.success(function(f,h,g){$("#"+b+" .a-response").removeClass("hidden");var e=g.getResponseHeader("Location");if(e==null){e=g.getResponseHeader("Content-Location")}$("#"+b+" #responseLocation").empty().append('<a href="'+e+'">View</a>')})}}function taskFromTasks(b,c){console.log("taskFromTasks, seeking id="+c+" from "+b.length);var a;$.each(b,function(e,f){console.log("checking "+JSON.stringify(f));if(f!==undefined&&(f.id==c||f.taskId==c)){a=f}});return a}function getSearchParameters(){var a=window.location.search.substr(1);return a!=null&&a!=""?transformToAssocArray(a):{}}function transformToAssocArray(a){var e={};var c=a.split("&");for(var b=0;b<c.length;b++){var d=c[b].split("=");e[d[0]]=d[1]}return e}var bpms=new BpmsAdapter();function BpmsAdapter(){this.adapt=function(b,a){if(b.data===undefined){console.log("deteted a-roo, setting: "+a+" to "+b);a=b;console.log(a)}else{a=b.data}return a}}function ObjectHelper(){this.arrToObj=function(a){var b=new Object();for(idx in a){b[a[idx].name]=a[idx].value}return b}}
/*!
 * From: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/endsWith 
 * This method has been added to the ECMAScript 6 specification and may not be 
 * available in all JavaScript implementations yet
 * http://mths.be/endswith v0.2.0 by @mathias 
 */
;if(!String.prototype.endsWith){(function(){var a=(function(){try{var g={};var f=Object.defineProperty;var d=f(g,g,g)&&f}catch(e){}return d}());var c={}.toString;var b=function(m){if(this==null){throw TypeError()}var j=String(this);if(m&&c.call(m)=="[object RegExp]"){throw TypeError()}var d=j.length;var n=String(m);var g=n.length;var l=d;if(arguments.length>1){var h=arguments[1];if(h!==undefined){l=h?Number(h):0;if(l!=l){l=0}}}var f=Math.min(Math.max(l,0),d);var e=f-g;if(e<0){return false}var k=-1;while(++k<g){if(j.charCodeAt(e+k)!=n.charCodeAt(k)){return false}}return true};if(a){a(String.prototype,"endsWith",{value:b,configurable:true,writable:true})}else{String.prototype.endsWith=b}}())};