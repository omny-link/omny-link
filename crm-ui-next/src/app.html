<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<link rel="icon" href="/omny-link-icon.svg" type="image/svg+xml" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />

	<!-- Preconnect to external origins (DNS + TCP + TLS) -->
	<link rel="preconnect" href="https://fonts.googleapis.com" />
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
	<link rel="preconnect" href="https://cdn.jsdelivr.net" />

	<!-- Preload critical resources (highest priority) -->
	<link rel="preload" href="https://fonts.googleapis.com/css2?family=Signika:wght@300..700&display=swap" as="style" />
	<link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
		as="style" />

	<!-- Actual stylesheets -->
	<link href="https://fonts.googleapis.com/css2?family=Signika:wght@300..700&display=swap" rel="stylesheet" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />

	<style>
		/* Loading screen - visible until app hydrates */
		#app-loader {
			position: fixed;
			inset: 0;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			gap: 1.5rem;
			z-index: 9999;
			transition: opacity 0.4s ease;
			font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
		}

		html.dark-mode #app-loader {
			background-color: #212529;
			color: #fff;
		}

		html.light-mode #app-loader {
			background-color: #fff;
			color: #212529;
		}

		/* Spinner - using SVG icon */
		.spinner {
			width: 96px;
			height: 96px;
			animation: spin 2s linear infinite;
		}

		/* Loading text */
		.loader-text {
			font-size: 1.1rem;
			font-weight: 500;
			text-align: center;
			max-width: 300px;
		}

		@keyframes spin {
			to {
				transform: rotate(360deg);
			}
		}

		/* Hide loader when loaded */
		#app-loader.loaded {
			opacity: 0;
			pointer-events: none;
		}
	</style>

	<!-- Theme detection script (blocking, runs before body) -->
	<script>
		(function () {
			const stored = localStorage.getItem('colorScheme');
			const scheme = stored || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
			document.documentElement.classList.add(scheme + '-mode');
		})();
	</script>

	%sveltekit.head%
</head>

<body data-sveltekit-preload-data="hover">
	<!-- Loading screen -->
	<div id="app-loader">
		<img src="/omny-link-icon.svg" alt="Loading" class="spinner" />
		<div class="loader-text">We're loading your KnowProcess CRM</div>
	</div>

	<!-- SvelteKit app -->
	<div style="display: contents">%sveltekit.body%</div>

	<!-- Remove loader once app hydrates -->
	<script>
		(function () {
			let removing = false;

			// Listen for custom event from layout when fully initialized
			window.addEventListener('app:ready', function () {
				if (removing) return;
				removing = true;

				setTimeout(function () {
					const loader = document.getElementById('app-loader');
					if (loader) {
						loader.classList.add('loaded');
						setTimeout(function () { loader.remove(); }, 400);
					}
				}, 100);
			});

			// Fallback: remove after 10 seconds if event never fires
			setTimeout(function () {
				if (!removing) {
					removing = true;
					const loader = document.getElementById('app-loader');
					if (loader) {
						loader.classList.add('loaded');
						setTimeout(function () { loader.remove(); }, 400);
					}
				}
			}, 10000);
		})();
	</script>
</body>

</html>