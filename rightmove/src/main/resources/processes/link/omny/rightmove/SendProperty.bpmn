<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:activiti="http://activiti.org/bpmn" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:tns="http://sourceforge.net/bpmn/definitions/SendPropertyPackage" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:yaoqiang="http://bpmn.sourceforge.net" exporter="Yaoqiang BPMN Editor" exporterVersion="2.2.18 (GPLv3, Non-Commercial)" expressionLanguage="http://activiti.org/Juel" id="SendPropertyPackage" name="" targetNamespace="http://sourceforge.net/bpmn/definitions/SendPropertyPackage" typeLanguage="http://www.w3.org/2001/XMLSchema" xsi:schemaLocation="http://www.omg.org/spec/BPMN/20100524/MODEL http://bpmn.sourceforge.net/schemas/BPMN20.xsd">
  <process id="SendProperty" isClosed="false" isExecutable="true" name="Create Activity and attach to a Contact" processType="None">
    <documentation id="SendProperty_D_1" textFormat="text/plain"><![CDATA[Send a unit (stock item) to Right Move]]></documentation>
    <extensionElements>
      <yaoqiang:pageFormat height="842.4" imageableHeight="832.4" imageableWidth="587.6" imageableX="5.0" imageableY="5.0" orientation="0" width="597.6"/>
      <yaoqiang:page background="#FFFFFF" horizontalCount="1" verticalCount="1"/>
    </extensionElements>
    <ioSpecification>
      <dataInput id="_4" isCollection="false" name="tenantId"/>
      <dataInput id="_5" isCollection="false" name="stockItemId"/>
      <inputSet>
        <dataInputRefs>_4</dataInputRefs>
        <dataInputRefs>_5</dataInputRefs>
      </inputSet>
      <outputSet/>
    </ioSpecification>
    <sequenceFlow id="_12" sourceRef="linkActivityToContact" targetRef="updateContact"/>
    <sequenceFlow id="_3" sourceRef="start" targetRef="getStockItem"/>
    <startEvent id="start" isInterrupting="true" name="Start Event" parallelMultiple="false">
      <outgoing>_3</outgoing>
      <outputSet/>
    </startEvent>
    <serviceTask activiti:class="com.knowprocess.resource.spi.RestGet" completionQuantity="1" id="getStockItem" implementation="##WebService" isForCompensation="false" name="GET stock item" startQuantity="1">
      <extensionElements>
        <activiti:field name="resourceUsername">
          <activiti:string>userInfo('tenant-bot')</activiti:string>
        </activiti:field>
        <activiti:field name="resourcePassword">
          <activiti:expression>userInfo('cust-mgmt-secret')</activiti:expression>
        </activiti:field>
        <activiti:field name="globalResource">
          <activiti:expression>${stockItemId}?projection=incCategory</activiti:expression>
        </activiti:field>
        <activiti:field name="headers">
          <activiti:string>Accept:application/json</activiti:string>
        </activiti:field>
        <activiti:field expression="stockItem" name="responseVar"/>
      </extensionElements>
      <incoming>_3</incoming>
      <outgoing>_9</outgoing>
    </serviceTask>
    <serviceTask activiti:class="com.knowprocess.resource.spi.RestPost" completionQuantity="1" id="linkActivityToContact" implementation="##WebService" isForCompensation="false" name="POST to&#10;Right Move" startQuantity="1">
      <extensionElements>
        <!-- Authentication handled by Java keystore -->
        <activiti:field name="globalResource">
          <activiti:expression>https://adfapi.adftest.rightmove.com/v1/property/sendpropertydetails</activiti:expression>
        </activiti:field>
        <activiti:field name="headers">
          <activiti:string>Content-Type:application/json,Accept:application/json</activiti:string>
        </activiti:field>
        <activiti:field name="data">
          <activiti:expression>${rmJson}</activiti:expression>
        </activiti:field>
        <activiti:field name="responseVar">
          <activiti:expression>rmResponse</activiti:expression>
        </activiti:field>
      </extensionElements>
      <incoming>_11</incoming>
      <outgoing>_12</outgoing>
    </serviceTask>
    <endEvent id="end" name="End Event">
      <incoming>_6</incoming>
      <inputSet/>
    </endEvent>
    <scriptTask completionQuantity="1" id="_8" isForCompensation="false" name="Convert to Right &#10;Move format" scriptFormat="JavaScript" startQuantity="1">
      <incoming>_9</incoming>
      <outgoing>_11</outgoing>
      <script><![CDATA[var System = java.lang.System;
var stockItem = execution.getVariable('stockItem');
System.out.println('XXXXXX'+stockItem);
var branchId = -1;
//switch(stockItem.id)
// case 'Swindon':
  branchId = 90511;
//}
var rmJson = {
  "network":{
    "network_id": 9398
  },
  "branch":{
    "branch_id": branchId,
    "channel": 1,
    "overseas": false
  },
  "property":{
    "agent_ref": "02072013_0406",
    "published": true,
    "property_type": 2,
    "status": 1,
    "new_home": false,
    "student_property": false,
    "create_date": "02-07-2013 00:00:00",
    "update_date": "02-07-2013 00:00:00",
    "date_available": "02-07-2013",
    "contract_months": 12,
    "minimum_term": 12,
    "let_type": 1,
    "address":{
      "house_name_number": "33",
      "address_2": "Rightmove",
      "address_3": "4th Floor",
      "address_4": "Soho Square",
      "town": "London",
      "postcode_1": "W1D",
      "postcode_2": "3QU",
      "display_address": "Soho Square",
      "latitude": 51.514899,
      "longitude": -0.132587,
      "pov_latitude": 51.51482,
      "pov_longitude": -0.13249,
      "pov_pitch": -16.78,
      "pov_heading": 235.75,
      "pov_zoom": 0
    },
    "price_information":{
      "price": 1500,
      "price_qualifier": 0,
      "deposit": 1000,
      "administration_fee": "100",
      "rent_frequency": 1,
      "tenure_type": 1,
      "auction": false,
      "tenure_unexpired_years": 999,
      "price_per_unit_area": 10
    },
    "details":{
      "summary": "Rightmove Test Property",
      "description": "Testing full property schema with all the fields in the call for JSON",
      "features": [
        "Has own Drive",
        "Garage included",
        "Double Glazed"
      ],
      "bedrooms": 2,
      "bathrooms": 2,
      "reception_rooms": 1,
      "parking": [13],
      "outside_space": [29],
      "year_built": 999,
      "internal_area": 100,
      "internal_area_unit": 1,
      "land_area": 100,
      "land_area_unit": 1,
      "floors": 5,
      "entrance_floor": 1,
      "condition": 1,
      "accessibility": [42],
      "heating": [1],
      "furnished_type": 0,
      "pets_allowed": true,
      "smokers_considered": true,
      "housing_benefit_considered": true,
      "sharers_considered": true,
      "burglar_alarm": true,
      "washing_machine": true,
      "dishwasher": true,
      "all_bills_inc": true,
      "water_bill_inc": true,
      "gas_bill_inc": true,
      "electricity_bill_inc": true,
      "tv_licence_inc": true,
      "sat_cable_tv_bill_inc": true,
      "internet_bill_inc": true,
      "business_for_sale": true,
      "comm_use_class":[1,4],
      "rooms": [ {
        "room_name": "room1",
        "room_description": "room1" ,
        "room_length": 10.10,
        "room_width": 20.20,
        "room_dimension_unit": 5,
        "room_photo_urls": ["http://www.rightmove.com/image1.JPG"]
      } ]
    },
    "media": [ {
      "media_type":1,
      "media_url":"www.rightmove.com/image1.JPG",
      "caption":"This is an image",
      "sort_order":1,
      "media_update_date": "02-07-2013 12:12:12"
    } ],
    "principal": {
      "principal_email_address": "principal@rightmove.co.uk",
      "auto_email_when_live": true,
      "auto_email_updates": true
    }
  }
};
execution.setVariable('rmJson', JSON.stringify(rmJson));
]]></script>
    </scriptTask>
    <sequenceFlow id="_9" sourceRef="getStockItem" targetRef="_8"/>
    <sequenceFlow id="_11" sourceRef="_8" targetRef="linkActivityToContact"/>
    <serviceTask activiti:class="com.knowprocess.resource.spi.RestPost" completionQuantity="1" id="updateContact" implementation="##WebService" isForCompensation="false" name="Update flag on stock item" startQuantity="1">
      <extensionElements>
        <activiti:field name="resourceUsername">
          <activiti:string>userInfo('tenant-bot')</activiti:string>
        </activiti:field>
        <activiti:field name="resourcePassword">
          <activiti:expression>userInfo('cust-mgmt-secret')</activiti:expression>
        </activiti:field>
        <activiti:field name="globalResource">
          <activiti:expression>userInfo('cust-mgmt-url')/${tenantId}/stock-items/${stockItemShortId}</activiti:expression>
        </activiti:field>
        <activiti:field name="headers">
          <activiti:string>Accept:application/json,Content-Type:application/x-www-form-urlencoded</activiti:string>
        </activiti:field>
        <activiti:field name="data">
          <activiti:string>fieldName=publishRightMove,fieldValue=true</activiti:string>
        </activiti:field>
      </extensionElements>
      <incoming>_12</incoming>
      <outgoing>_6</outgoing>
    </serviceTask>
    <sequenceFlow id="_6" sourceRef="updateContact" targetRef="end"/>
    <textAnnotation id="_2" textFormat="text/plain">
      <text>SEND A UNIT TO RIGHT MOVE</text>
    </textAnnotation>
  </process>
  <bpmndi:BPMNDiagram id="Yaoqiang_Diagram-SendProperty" name="New Diagram" resolution="96.0">
    <bpmndi:BPMNPlane bpmnElement="SendProperty">
      <bpmndi:BPMNShape bpmnElement="start" id="Yaoqiang-start">
        <dc:Bounds height="32.0" width="32.0" x="62.77272727272734" y="239.64285714285717"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="63.0" x="47.27272727272731" y="280.96121651785717"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="getStockItem" id="Yaoqiang-getStockItem">
        <dc:Bounds height="81.0" width="116.0" x="161.80909090909094" y="215.14285714285717"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="85.0" x="177.30909090909094" y="248.16531808035717"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="linkActivityToContact" id="Yaoqiang-linkActivityToContact">
        <dc:Bounds height="81.0" width="116.0" x="443.8818181818182" y="215.14285714285717"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="32.955078125" width="65.0" x="469.3818181818182" y="241.16531808035717"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="end" id="Yaoqiang-end">
        <dc:Bounds height="32.0" width="32.0" x="767.9545454545454" y="239.64285714285717"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="58.0" x="754.9545454545454" y="280.96121651785717"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_2" id="Yaoqiang-_2">
        <dc:Bounds height="40.0" width="216.0" x="63.0" y="52.0"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="163.0" x="63.0" y="64.5224609375"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_4" id="Yaoqiang-_4">
        <dc:Bounds height="38.0" width="29.0" x="62.77272727272734" y="346.6931818181818"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="50.0" x="52.27272727272734" y="386.6931818181818"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_5" id="Yaoqiang-_5">
        <dc:Bounds height="38.0" width="29.0" x="62.77272727272734" y="434.02272727272725"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="68.0" x="43.27272727272734" y="474.02272727272725"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_8" id="Yaoqiang-_8">
        <dc:Bounds height="81.0" width="116.0" x="302.8454545454546" y="215.14285714285717"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="32.955078125" width="94.0" x="313.8454545454546" y="241.16531808035717"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="updateContact" id="Yaoqiang-updateContact">
        <dc:Bounds height="81.0" width="116.0" x="584.9181818181818" y="215.14285714285717"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="32.955078125" width="84.0" x="600.9181818181818" y="241.16531808035717"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge bpmnElement="_12" id="Yaoqiang-_12">
        <di:waypoint x="560.0" y="255.64285714285717"/>
        <di:waypoint x="585.0" y="255.64285714285717"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="569.5" y="246.16531808035717"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_9" id="Yaoqiang-_9">
        <di:waypoint x="278.0" y="255.64285714285717"/>
        <di:waypoint x="303.0" y="255.64285714285717"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="287.5" y="246.16531808035717"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_11" id="Yaoqiang-_11">
        <di:waypoint x="419.0" y="255.64285714285717"/>
        <di:waypoint x="444.0" y="255.64285714285717"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="428.5" y="246.16531808035717"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_6" id="Yaoqiang-_6">
        <di:waypoint x="701.0" y="255.64285714285717"/>
        <di:waypoint x="768.00398646601" y="255.64285714285717"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="731.501993233005" y="246.16531808035717"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_3" id="Yaoqiang-_3">
        <di:waypoint x="94.99601353399002" y="255.64285714285717"/>
        <di:waypoint x="162.0" y="255.64285714285717"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="125.49800676699502" y="246.16531808035717"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</definitions>
