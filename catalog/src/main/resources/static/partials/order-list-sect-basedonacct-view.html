<section class="container container-sticky">
  <h2 class="navbar-sticky">
    {{>navbar}}
    {{>profileArea}}
  </h2>
</section>
<section id="ordersSect">
  <h2 class="navbar-top">
    {{>navbar}}
    <span class="pull-right">
      {{#if tenant.orderActions!=undefined && tenant.orderActions.length>0 }}
        <span class="clickable dropdown" aria-hidden="true" title="Start Process">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" id="customActionBtn" role="button" aria-expanded="false">
            <a class="clickable glyphicon glyphicon-play dropdown" aria-hidden="true" title="Start Process"> <span class="caret"></a>
          </a>
          <ul class="omny-dropdown dropdown-menu" id="customActionMenu" role="menu">
            {{#each tenant.orderActions }}
              {{#name}}
                <li onclick="ractive.startCustomAction('{{ref}}', '{{name}}', undefined{{#url}}, '{{url}}'{{/url}})">{{name}}</li>
              {{else}}
                <li class="divider"></li>
              {{/}}
            {{/each}}
          </ul>
        </span>
      {{/if}}
    </span>
  </h2>



  <h2>
    <span class="ol-collapse glyphicon glyphicon-triangle-bottom" onclick="ractive.toggleSection($(this).closest('section'))"></span>
    <span>{{#tenant.strings.orders}}{{tenant.strings.orders}}{{else}}Orders{{/}}</span>
    {{#if matchRole('sales')}}
      <a class="clickable glyphicon glyphicon-plus" aria-hidden="true" on-click="addOrder()" title="Add a new order"></a>
    {{/if}}
    <a class="clickable glyphicon glyphicon-refresh" aria-hidden="true" on-click="fetchOrders(current)" title="Refresh the order list"></a>
  </h2>
  <div class="col-md-12" id="currentOrders">
    <form id="currentOrderForm">
      <table class="active-table table table-striped">
        <thead>
          <tr>
            {{#1==2}}
              <th on-click="sortOrder:name">Name<span class="sortable {{ sorted('name') }} glyphicon "></th>
            {{/}}
            {{#entityPath=='/accounts'}}
              <th on-click="sortOrder:contactName">Contact<span class="sortable {{ sorted('contactName') }} glyphicon "></th>
            {{/}}
            <th on-click="sortOrder:date" style="width: 11em;" title="{{#tenant.strings.orderDateHint}}{{tenant.strings.orderDateHint}}{{else}}Date order placed{{/}}">{{#tenant.strings.orderDate}}{{tenant.strings.orderDate}}{{else}}Order Date{{/}}<span class="sortable {{ sorted('date') }} glyphicon "></th>
            <th on-click="sortOrder:dueDate" style="width: 11em;" title="{{#tenant.strings.dueDateHint}}{{tenant.strings.dueDateHint}}{{else}}Expected delivery date{{/}}">{{#tenant.strings.dueDate}}{{tenant.strings.dueDate}}{{else}}Due Date{{/}}<span class="sortable {{ sorted('dueDate') }} glyphicon "></th>
            <th on-click="sortOrder:stage" title="{{#tenant.strings.stageHint}}{{tenant.strings.stageHint}}{{else}}Stage the order has reached{{/}}">Stage<span class="sortable {{ sorted('stage') }} glyphicon "></th>
            <th on-click="sortOrder:stockItemName" title="{{#tenant.strings.stockItemProposedHint}}{{tenant.strings.stockItemProposedHint}}{{else}}Stock item{{/}}">{{#tenant.strings.stockItem}}{{tenant.strings.stockItem}}{{else}}Stock Item{{/}}<span class="sortable {{ sorted('stockItemName') }} glyphicon "></th>
            {{#tenant.show.stockPricing}}
              <th on-click="sortOrder:price" style="width: 5em;" title="{{#tenant.strings.priceHint}}{{tenant.strings.priceHint}}{{else}}Price{{/}}">{{#tenant.strings.price}}{{tenant.strings.price}}{{else}}Price{{/}}<span class="sortable {{ sorted('price') }} glyphicon "></th>
            {{/}}
            <th on-click ="sortOrder:invoiceRef" style="width: 5em;" title="{{#tenant.strings.invoiceRefHint}}{{tenant.strings.invoiceRefHint}}{{else}}Invoice reference{{/}}">Invoice Ref<span class="sortable {{ sorted('invoiceRef') }} glyphicon "></th>
            {{#1==2}}<th on-click="sortOrder:created">Created<span class="sortable {{ sorted('created') }} glyphicon "></th>{{/}}
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {{#each sort(orders,sortOrderColumn,sortOrderAsc):i}}
            <tr class="{{#if tenant.show.orderItems && orderItems}}alert-info{{elseif tenant.show.orderItems}}alert-warning{{/if}}">
              {{#1==2}}<td>{{name}}</td>{{/}}
              {{#entityPath=='/accounts'}}
                <td data-order-id="{{selfRef}}" data-key="contactName">
                  <span>{{#contactId}}{{Array.findBy('selfRef','/contacts/'+contactId,current.contacts).fullName}}{{else}}{{contactId}}{{/}}</span>
                  <input class="hidden contact-typeahead typeahead form-control" placeholder="Start typing to filter options" required value="{{#contactId}}{{Array.findBy('selfRef','/contacts/'+contactId,current.contacts).fullName}}{{else}}{{contactId}}{{/}}">
                </td>
              {{/}}
              <td data-order-id="{{selfRef}}" data-key="date">
                <span>{{formatDate(date)}}</span>
                <input class="hidden form-control" placeholder="{{#tenant.strings.orderDateHint}}{{tenant.strings.orderDateHint}}{{else}}Date order placed{{/}}" title="{{#tenant.strings.orderDateHint}}{{tenant.strings.orderDateHint}}{{else}}Date order placed{{/}}" type="date" value="{{date}}">
              </td>
              {{#if tenant.show.orderItems && orderItems}}
                <td data-order-id="{{selfRef}}">{{formatDate(orderItems.0.customFields.date)}}</td>
              {{else}}
                <td data-order-id="{{selfRef}}" data-key="dueDate">
                  <span>{{dueDate}}</span>
                  <input class="hidden form-control" placeholder="{{#tenant.strings.dueDateHint}}{{tenant.strings.dueDateHint}}{{else}}Expected delivery date{{/}}" title="{{#tenant.strings.dueDateHint}}{{tenant.strings.dueDateHint}}{{else}}Expected delivery date{{/}}" value="{{dueDate}}"/>
                </td>
              {{/if}}
              <td data-order-id="{{selfRef}}" data-key="stage">
                <span>{{stage}}</span>
                <input class="hidden typeahead form-control" placeholder="Start typing to filter options" title="{{#tenant.strings.stageHint}}{{tenant.strings.stageHint}}{{else}}Stage the order has reached{{/}}" value="{{stage}}">
              </td>
              {{#if tenant.show.orderItems && orderItems}}
                <td data-order-id="{{selfRef}}" title="{{#tenant.strings.stockItems}}List of included {{tenant.strings.stockItems}}{{else}}List of included stock items{{/}}">{{formatStockItemId(uniq('stockItemId', orderItems))}}</td>
              {{else}}
                <td data-order-id="{{selfRef}}" data-key="customFields.proposedStockItems">
                  <span title="{{#tenant.strings.stockItemProposedHint}}{{tenant.strings.stockItemProposedHint}}{{else}}Proposed or suggested stock items{{/}}">{{customFields['proposedStockItems']}}</span>
                  <input class="hidden form-control stock-item-typeahead typeahead" placeholder="{{#tenant.strings.stockItemProposedHint}}{{tenant.strings.stockItemProposedHint}}{{else}}Proposed or suggested stock items{{/}}" title="{{#tenant.strings.stockItemProposedHint}}{{tenant.strings.stockItemProposedHint}}{{else}}Proposed or suggested stock items{{/}}" value="{{customFields['proposedStockItems']}}"/>
                </td>
              {{/if}}
              {{#tenant.show.stockPricing}}
                <td class="number" data-order-id="{{selfRef}}" data-key="price">
                  <span title="{{#tenant.strings.priceHint}}{{tenant.strings.priceHint}}{{else}}Price{{/}}">{{price}}</span>
                  <input class="hidden form-control" placeholder="{{#tenant.strings.priceHint}}{{tenant.strings.priceHint}}{{else}}Price{{/}}" {{^matchRole('sales_manager')}}readonly{{/}} title="{{#tenant.strings.priceHint}}{{tenant.strings.priceHint}}{{else}}Price{{/}}" type="number" value="{{price}}">
                </td>
              {{/}}
              <td data-order-id="{{selfRef}}" data-key="invoiceRef">
                <span title="{{#tenant.strings.invoiceRefHint}}{{tenant.strings.invoiceRefHint}}{{else}}Invoice reference{{/}}">{{invoiceRef}}</span>
                <input class="hidden form-control" placeholder="{{#tenant.strings.invoiceRefHint}}{{tenant.strings.invoiceRefHint}}{{else}}Invoice reference{{/}}" title="{{#tenant.strings.invoiceRefHint}}{{tenant.strings.invoiceRefHint}}{{else}}Invoice reference{{/}}" value="{{invoiceRef}}"/>
              </td>
              {{#1==2}}<td>{{formatDateTime(created)}}</td>{{/}}
              <td class="actions">
                <a class="glyphicon glyphicon-pencil" aria-hidden="true" on-click="toggleEditOrder(.)" title="Edit this record"></a>
                <a class="glyphicon glyphicon-duplicate" aria-hidden="true" on-click="cloneOrder(.)" title="Duplicate this record"></a>
                {{#if tenant.show.orderItems && orderItems}}
                  <a class="glyphicon {{#tenant.strings.orderItemIcon}}{{tenant.strings.orderItemIcon}}{{else}}glyphicon-th-list{{/}}" aria-hidden="true" on-click="toggleOrderSubEntity(this,'orderItems')" 
                     title="Show {{#tenant.strings.orderItems}}{{tenant.strings.orderItems}}{{else}}Order Items{{/}}"></a>
                {{elseif tenant.show.orderItems}}
                  <a class="glyphicon {{#tenant.strings.orderItemIcon}}{{tenant.strings.orderItemIcon}}{{else}}glyphicon-th-list{{/}}" aria-hidden="true" 
                     on-click="addOrderItems(selfRef, true)"
                     title="{{#tenant.strings.addOrderItems}}{{tenant.strings.addOrderItems}}{{else}}Create Order Items{{/}}"></a>
                {{/if}}
                {{#if tenant.show.feedback}}<a class="glyphicon glyphicon-comment" aria-hidden="true" on-click="toggleOrderSubEntity(this,'feedback')" title="Show Feedback"></a>{{/if}}
                {{#if selfRef && matchRole('admin')}}<a class="glyphicon glyphicon-remove" aria-hidden="true" on-click="deleteOrder(.)" title="Delete this record"></a>{{/if}}
                {{#if tenant.orderActions!=undefined && tenant.orderActions.length>0 }}
                  <span class="clickable dropdown" aria-hidden="true" title="Start Process">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" id="customActionBtn" role="button" aria-expanded="false">
                      <a class="clickable glyphicon glyphicon-play dropdown" aria-hidden="true" title="Perform action"> <span class="caret"></a>
                    </a>
                    <ul class="omny-dropdown dropdown-menu" id="customActionMenu" role="menu">
                      {{#each tenant.orderActions }}
                        {{#name && matchRole(role) && featureEnabled(feature)}}
                          <li onclick="ractive.startCustomAction('{{ref}}', '{{name}}', ractive.get('current'){{#url}}, '{{url}}'{{/url}}, '{{current.fullName}}')" title="{{name}}">{{name}}</li>
                        {{elseif name == undefined}}
                          <li class="divider"></li>
                        {{/}}
                      {{/each}}
                    </ul>
                  </span>
                {{/if}}
              </td>
            </tr>
          {{/each}}
        </tbody>
      </table>
    </form>
  </div>
</section>
