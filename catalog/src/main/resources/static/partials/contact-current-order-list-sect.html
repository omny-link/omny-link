<section id="orderSect">
  <h3>
    <span class="ol-collapse glyphicon glyphicon-triangle-right" onclick="ractive.toggleSection($(this).closest('section'))"></span>
    <span>{{#tenant.strings.orders}}{{tenant.strings.orders}}{{else}}Orders{{/}}</span>
    {{#if matchRole('sales')}}
      <a class="clickable glyphicon glyphicon-plus" aria-hidden="true" on-click="addOrder()" title="Add a new order"></a>
    {{/if}}
    <a class="clickable glyphicon glyphicon-refresh" aria-hidden="true" on-click="fetchOrders(current)" title="Refresh the order list"></a>
  </h3>
  <div class="col-md-12" id="currentOrders" style="display:none">
    <form id="currentOrderForm">
		  <table class="active-table table table-striped">
		    <thead>
		      <tr>
		        {{#1==2}}
		          <th on-click="sortOrder:name">Name<span class="sortable {{ sortedOrder('name') }} glyphicon "></th>
		        {{/}}
		        {{#entityPath=='/accounts'}}
		          <th on-click="sortOrder:contactName">Contact<span class="sortable {{ sortedOrder('contactName') }} glyphicon "></th>
		        {{/}}
		        <th on-click="sortOrder:date" style="width: 11em;" title="{{#tenant.strings.orderDateHint}}{{tenant.strings.orderDateHint}}{{else}}Date order placed{{/}}">{{#tenant.strings.orderDate}}{{tenant.strings.orderDate}}{{else}}Order Date{{/}}<span class="sortable {{ sortedOrder('date') }} glyphicon "></th>
		        <th on-click="sortOrder:dueDate" style="width: 11em;" title="{{#tenant.strings.dueDateHint}}{{tenant.strings.dueDateHint}}{{else}}Expected delivery date{{/}}">{{#tenant.strings.dueDate}}{{tenant.strings.dueDate}}{{else}}Due Date{{/}}<span class="sortable {{ sortedOrder('dueDate') }} glyphicon "></th>
		        <th on-click="sortOrder:stage" title="{{#tenant.strings.stageHint}}{{tenant.strings.stageHint}}{{else}}Stage the order has reached{{/}}">Stage<span class="sortable {{ sortedOrder('stage') }} glyphicon "></th>
		        <th on-click="sortOrder:stockItemName" title="{{#tenant.strings.stockItemProposedHint}}{{tenant.strings.stockItemProposedHint}}{{else}}Stock item{{/}}">{{#tenant.strings.stockItem}}{{tenant.strings.stockItem}}{{else}}Stock Item{{/}}<span class="sortable {{ sortedOrder('stockItemName') }} glyphicon "></th>
	          {{#tenant.show.stockPricing}}
	            <th on-click="sortOrder:price" style="width: 5em;" title="{{#tenant.strings.priceHint}}{{tenant.strings.priceHint}}{{else}}Price{{/}}">{{#tenant.strings.price}}{{tenant.strings.price}}{{else}}Price{{/}}<span class="sortable {{ sortedOrder('price') }} glyphicon "></th>
	          {{/}}
	          {{#tenant.orderFields}}
	            <th on-click="sortOrder:{{key}}" title="{{hint}}">{{label == undefined ? key.toLabel() : label}}<span class="sortable {{ sortedOrder('{{key}}') }} glyphicon "></th>
	          {{/}}
	          <th on-click ="sortOrder:invoiceRef" style="width: 5em;" title="{{#tenant.strings.invoiceRefHint}}{{tenant.strings.invoiceRefHint}}{{else}}Invoice reference{{/}}">Invoice Ref<span class="sortable {{ sortedOrder('invoiceRef') }} glyphicon "></th>
	          {{#1==2}}<th on-click="sortOrder:created">Created<span class="sortable {{ sortedOrder('created') }} glyphicon "></th>{{/}}
	          <th>Actions</th>
	        </tr>
		    </thead>
		    <tbody>
		      {{#each sort(orders,sortOrderColumn,sortOrderAsc):i}}
		        <tr class="{{#if tenant.show.orderItems && orderItems}}alert-info{{elseif tenant.show.orderItems}}alert-warning{{/if}}">
		          {{#1==2}}<td>{{name}}</td>{{/}}
              {{#entityPath=='/accounts'}}
                <td data-order-id="{{selfRef}}" data-key="contactName">
                  <span>{{#contactId}}{{Array.findBy('selfRef','/contacts/'+contactId,current.contacts).fullName}}{{else}}{{contactId}}{{/}}</span>
                  <input class="hidden contact-typeahead typeahead form-control" placeholder="Start typing to filter options" required value="{{#contactId}}{{Array.findBy('selfRef','/contacts/'+contactId,current.contacts).fullName}}{{else}}{{contactId}}{{/}}">
                </td>
              {{/}}
		          <td data-order-id="{{selfRef}}" data-key="date">
		            <span>{{formatDate(date)}}</span>
                <input class="hidden form-control" placeholder="{{#tenant.strings.orderDateHint}}{{tenant.strings.orderDateHint}}{{else}}Date order placed{{/}}" title="{{#tenant.strings.orderDateHint}}{{tenant.strings.orderDateHint}}{{else}}Date order placed{{/}}" type="date" value="{{date}}">
              </td>
              {{#if tenant.show.orderItems && orderItems}}
                <td data-order-id="{{selfRef}}">{{formatDate(orderItems.0.customFields.date)}}</td>
              {{else}}
                <td data-order-id="{{selfRef}}" data-key="dueDate">
                  <span>{{dueDate}}</span>
                  <input class="hidden form-control" placeholder="{{#tenant.strings.dueDateHint}}{{tenant.strings.dueDateHint}}{{else}}Expected delivery date{{/}}" title="{{#tenant.strings.dueDateHint}}{{tenant.strings.dueDateHint}}{{else}}Expected delivery date{{/}}" value="{{dueDate}}"/>
                </td>
              {{/if}}
		          <td data-order-id="{{selfRef}}" data-key="stage">
		            <span>{{stage}}</span>
		            <input class="hidden typeahead form-control" placeholder="Start typing to filter options" title="{{#tenant.strings.stageHint}}{{tenant.strings.stageHint}}{{else}}Stage the order has reached{{/}}" value="{{stage}}">
		          </td>
		          {{#if tenant.show.orderItems && orderItems}}
		            <td data-order-id="{{selfRef}}" title="{{#tenant.strings.stockItems}}List of included {{tenant.strings.stockItems}}{{else}}List of included stock items{{/}}">{{formatStockItemId(uniq('stockItemId', orderItems))}}</td>
	            {{else}}
	              <td data-order-id="{{selfRef}}" data-key="customFields.proposedStockItems">
	                <span title="{{#tenant.strings.stockItemProposedHint}}{{tenant.strings.stockItemProposedHint}}{{else}}Proposed or suggested stock items{{/}}">{{customFields['proposedStockItems']}}</span>
	                <input class="hidden form-control stock-item-typeahead typeahead" placeholder="{{#tenant.strings.stockItemProposedHint}}{{tenant.strings.stockItemProposedHint}}{{else}}Proposed or suggested stock items{{/}}" title="{{#tenant.strings.stockItemProposedHint}}{{tenant.strings.stockItemProposedHint}}{{else}}Proposed or suggested stock items{{/}}" value="{{customFields['proposedStockItems']}}"/>
	              </td>
	            {{/if}}
	            {{#tenant.show.stockPricing}}
	              <td class="number" data-order-id="{{selfRef}}" data-key="price">
	                <span title="{{#tenant.strings.priceHint}}{{tenant.strings.priceHint}}{{else}}Price{{/}}">{{price}}</span>
                  <input class="hidden form-control" placeholder="{{#tenant.strings.priceHint}}{{tenant.strings.priceHint}}{{else}}Price{{/}}" {{^matchRole('sales_manager')}}readonly{{/}} title="{{#tenant.strings.priceHint}}{{tenant.strings.priceHint}}{{else}}Price{{/}}" type="number" value="{{price}}">
                </td>
	            {{/}}
              {{#tenant.orderFields}}
                {{#if tenant.show.orderItems && orderItems && orderItems[0]!=undefined && index(orderItems[0],'customFields.'+key)!=undefined}}
                  <td data-order-id="{{selfRef}}" title="{{hint}}">{{#if type=='number'}}{{sum('customFields.'+key,orderItems)}}{{else}}{{uniq('customFields.'+key,orderItems)}}{{/if}}</td>
                {{else}}
                  <td data-order-id="{{selfRef}}" title="{{hint}}">
                   <span title="{{hint}}">{{customFields[key]}}</span>
                   <input class="hidden form-control" {{#if validation}}pattern="{{validation}}"{{/if}} placeholder="{{hint}}" title="{{hint}}" type="{{type}}" value="{{customFields[key]}}">
                  </td>
                {{/if}}
              {{/}}
	            <td data-order-id="{{selfRef}}" data-key="invoiceRef">
	              <span title="{{#tenant.strings.invoiceRefHint}}{{tenant.strings.invoiceRefHint}}{{else}}Invoice reference{{/}}">{{invoiceRef}}</span>
	              <input class="hidden form-control" placeholder="{{#tenant.strings.invoiceRefHint}}{{tenant.strings.invoiceRefHint}}{{else}}Invoice reference{{/}}" title="{{#tenant.strings.invoiceRefHint}}{{tenant.strings.invoiceRefHint}}{{else}}Invoice reference{{/}}" value="{{invoiceRef}}"/>
	            </td>
		          {{#1==2}}<td>{{formatDateTime(created)}}</td>{{/}}
		          <td class="actions">
		            <a class="glyphicon glyphicon-pencil" aria-hidden="true" on-click="toggleEditOrder(.)" title="Edit this record"></a>
	              <a class="glyphicon glyphicon-duplicate" aria-hidden="true" on-click="cloneOrder(.)" title="Duplicate this record"></a>
			          {{#if tenant.show.orderItems && orderItems}}
	                <a class="glyphicon {{#tenant.strings.orderItemIcon}}{{tenant.strings.orderItemIcon}}{{else}}glyphicon-th-list{{/}}" aria-hidden="true" on-click="toggleOrderSubEntity(this,'orderItems')" 
	                   title="Show {{#tenant.strings.orderItems}}{{tenant.strings.orderItems}}{{else}}Order Items{{/}}"></a>
	              {{elseif tenant.show.orderItems}}
	                <a class="glyphicon {{#tenant.strings.orderItemIcon}}{{tenant.strings.orderItemIcon}}{{else}}glyphicon-th-list{{/}}" aria-hidden="true" 
	                   on-click="addOrderItems(selfRef, true)"
	                   title="{{#tenant.strings.addOrderItems}}{{tenant.strings.addOrderItems}}{{else}}Create Order Items{{/}}"></a>
	              {{/if}}
	              {{#if tenant.show.feedback}}<a class="glyphicon glyphicon-comment" aria-hidden="true" on-click="toggleOrderSubEntity(this,'feedback')" title="Show Feedback"></a>{{/if}}
	              {{#if selfRef && matchRole('admin')}}<a class="glyphicon glyphicon-remove" aria-hidden="true" on-click="deleteOrder(.)" title="Delete this record"></a>{{/if}}
	              {{#if tenant.orderActions!=undefined && tenant.orderActions.length>0 }}
                  <span class="clickable dropdown" aria-hidden="true" title="Start Process">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" id="customActionBtn" role="button" aria-expanded="false">
                      <a class="clickable glyphicon glyphicon-play dropdown" aria-hidden="true" title="Perform action"> <span class="caret"></a>
                    </a>
                    <ul class="omny-dropdown dropdown-menu" id="customActionMenu" role="menu">
                      {{#each tenant.orderActions }}
                        {{#name && matchRole(role) && featureEnabled(feature)}}
                          <li onclick="ractive.startCustomAction('{{ref}}', '{{name}}', ractive.get('current'){{#url}}, '{{url}}'{{/url}}, '{{current.fullName}}')" title="{{name}}">{{name}}</li>
                        {{elseif name == undefined}}
                          <li class="divider"></li>
                        {{/}}
                      {{/each}}
                    </ul>
                  </span>
                {{/if}}
		          </td>
		        </tr>
		        {{#if tenant.show.orderItems}}
              <tr class="orderItems" data-order-id="{{..selfRef}}" style="display:none">
                <th>
                  <div>{{#tenant.strings.orderItems}}{{tenant.strings.orderItems}}{{else}}Order Items{{/}}</div>
                  <div><a class="clickable glyphicon glyphicon-plus" aria-hidden="true" on-click="addOrderItem(..selfRef)" title="Add a new {{#tenant.strings.orderItem}}{{tenant.strings.orderItem.toLowerCase()}}{{else}}order item{{/}}"></a></div>
                </th>
                <td colspan="10">
			            {{#if orderItems==undefined || orderItems.length==0}}
		                None
		              {{else}}
		                <table class="ol-order-items table table-striped">
		                  <thead>
		                    <tr>
		                      <th title="{{#tenant.strings.stockItemHint}}{{tenant.strings.stockItemHint}}{{else}}Stock item{{/}}">{{#tenant.strings.stockItem}}{{tenant.strings.stockItem}}{{else}}Stock Item{{/}}</th>
		                      {{#tenant.orderItemFields}}
		                        <th title="{{hint}}">{{label == undefined ? key.toLabel() : label}}</th>
		                      {{/}}
		                      <th>Actions</th>
		                    </tr>
		                  </thead>
		                  <tbody>
		                    {{#..orderItems:j}}
		                      <tr>
                            <td data-order-item-id="{{..selfRef}}" data-key="stockItem">
                              <span title="{{#tenant.strings.stockItemHint}}{{tenant.strings.stockItemHint}}{{else}}Stock item{{/}}">{{#stockItemId}}{{Array.findBy('selfRef','/stock-items/'+stockItemId,stockItems).name}}{{else}}{{stockItemId}}{{/}}</span>
                              <input class="hidden form-control stock-item-typeahead typeahead" placeholder="{{#tenant.strings.stockItemHint}}{{tenant.strings.stockItemHint}}{{else}}Stock item{{/}}" title="{{#tenant.strings.stockItemHint}}{{tenant.strings.stockItemHint}}{{else}}Stock item{{/}}" value="{{stockItem}}"/>
                            </td>
		                        {{#tenant.orderItemFields}}
			                        <td class="{{type}}" data-order-item-id="{{orderItems[j].selfRef}}" data-key="orderItems.{{j}}.customFields.{{key}}">
	                              {{#if type=='date'}}
	                                <span title="{{hint}}">{{formatDate(customFields[key])}}</span>
	                                <input class="hidden form-control" placeholder="yyyy-mm-dd" type="date" title="{{hint}}" value="{{customFields[key]}}">
	                              {{else}}
	                                <span title="{{hint}}" >{{customFields[key]}}</span>
	                                <input class="hidden form-control" placeholder="{{hint}}" title="{{hint}}" type="{{type}}" value="{{customFields[key]}}">
	                              {{/if}}
			                        </td>
			                      {{/}}
                            <td class="actions">
                              <a class="glyphicon glyphicon-pencil" aria-hidden="true" on-click="toggleEditOrderItem(.)" title="Edit this record"></a>
                              {{#if matchRole('admin')}}
                                <a class="glyphicon glyphicon-remove" aria-hidden="true" on-click="deleteOrderItem(.)" title="Delete this record"></a>
                              {{/if}}
                            </td>
		                      </tr>
		                    {{/}}
		                  </tbody>
		                </table>
		              {{/if}}
		            </td>
		          </tr>
		        {{/if}}
	          <tr class="feedback" data-order-id="{{selfRef}}" style="display:none">
	            <th>Feedback:</th>
	            <td colspan="10">
	              {{#if feedback==undefined || feedback.length==0}}
	                No feedback has been submitted yet.
	              {{else}}
		              <div class="currentBody col-md-6 col-sm-12 col-xs-12">
							      <ul class="form edit-form">
                      {{#if feedback.description}}
                        <li class="form-group">
                          <label class="col-md-4 col-sm-4">{{#tenant.strings.feedbackDesc}}{{tenant.strings.feedbackDesc}}{{else}}Feedback{{/}}:</label>
                          <input class="form-control" id="curFeedbackDescription" value="{{feedback.description}}">
                          <p class="col-md-offset-4 col-sm-offset-4 help-block field-error"></p>
                        </li>
                      {{/if}}
                      {{#each tenant.feedbackFields.slice(0,Math.ceil(tenant.feedbackFields.length/2)):j}}
                        <li class="form-group">
                          <label class="col-md-4 col-sm-4">{{label == undefined ? name.toLabel() : label}}:</label>
                          <input class="form-control" id="cur{{name.toLeadingCaps()}}" value="{{feedback.customFields[name]}}">
                          <p class="col-md-offset-4 col-sm-offset-4 help-block field-error">{{hint}}</p>
                        </li>
                      {{/each}}
                    </ul>
                  </div>
                  <div class="currentBody col-md-6 col-sm-12 col-xs-12">
                    <ul class="form edit-form">
                      {{#if feedback.type}}
                        <li class="form-group">
                          <label class="col-md-4 col-sm-4">Type:</label>
                          <input class="form-control" id="curFeedbackType" value="{{feedback.type}}">
                          <p class="col-md-offset-4 col-sm-offset-4 help-block field-error"></p>
                        </li>
                      {{/if}}
                      {{#each tenant.feedbackFields.slice(Math.ceil(tenant.feedbackFields.length/2),tenant.feedbackFields.length):j}}
                        <li class="form-group">
                          <label class="col-md-4 col-sm-4">{{label == undefined ? name.toLabel() : label}}:</label>
                          <input class="form-control" id="cur{{name.toLeadingCaps()}}" value="{{feedback.customFields[name]}}">
                          <p class="col-md-offset-4 col-sm-offset-4 help-block field-error">{{hint}}</p>
                        </li>
                      {{/each}}
                    </ul>
                  </div>
                {{/if}}
              </td>
            </tr>
		      {{/each}}
		    </tbody>
		  </table>
    </form>
  </div>
</section>
