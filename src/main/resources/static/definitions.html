<!doctype html>
<html lang='en-GB'>
<head>
  <meta charset='utf-8'>
  <title>Process Definitions</title>
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/omny-0.8.0.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="images/icon/omny-icon-16x16.png" />
</head>
<body>
  <div class="clearfix" id="messages"></div>
  <div class="container" id="container"></div>
  <script id='template' type='text/ractive'>
    <div class="profile pull-right">
      <form name="logoutForm" action="/logout" method="POST">
          <span id="tenantId" class="replaceable super_admin" contenteditable="true" onblur="ractive.switchToTenant($('#tenantId').text())" name="tenantId" value="{{tenant == null ? 'Click to set' : tenant.id}}"></span>
        <span class="profile-img">Logged in as: {{username}}</span>
        <a class="clickable glyphicon glyphicon-log-out" aria-hidden="true" on-click="logout()"></a>
        <input type="hidden" id="_csrf" name="_csrf" value="{{csrfToken}}" />
      </form>
    </div>
    <h1>
      <a class="nav navbar-brand" href="http://omny.link">
      </a>
      <span>Process Definitions</span>
    </h1>

    <form id="definitionList">
      <section id="definitionSect">
        <h2>
          <a id="definitionsTableToggle" class="clickable glyphicon glyphicon-triangle-bottom" aria-hidden="true" on-click="toggleResults()" title="Collapse or expand the definition table"></a>
          <span>Definitions</span>
          <a class="clickable glyphicon glyphicon-plus" aria-hidden="true" on-click="add()" title="Upload new BPMN"></a>
          <a class="clickable glyphicon glyphicon-refresh" aria-hidden="true" on-click="fetch()"></a>
          <input type="search" class="form-control search" placeholder="Search" value="{{searchTerm}}">
          <a class="glyphicon glyphicon-search" aria-hidden="true" title="Search for matching contacts"></a>
        </h2>
        <div id="upload" style="display:none">
          <form action="/{{tenant.id}}/deployments" class="well form-inline" enctype="multipart/form-data" id="uploadForm" method="post">
              <fieldset>
                <div class="form-group">
                  <label for="deploymentName">Deployment Name</label>
                  <input id="resourceFile" multiple="multiple" name="resourceFile" style="display: none" type="file">
                  <input name="tenantId" id="tenantId" type="hidden" value="{{tenant.id}}">
                  <input name="deploymentName" id="deploymentName" placeholder="my process application">
                  <button class="btn btn-primary" on-click="addDeploymentResource()" type="button">Select Files</button>
                </div>
                <div class="pull-right">
                  <button class="btn" on-click="cancelAdd()" type="button">Cancel</button>
                  <button class="btn" on-click="upload('uploadForm')" type="button">Upload</button>
                </div>
              </fieldset>
            </form>
        </div>
        <table id="definitionsTable" class="table table-striped">
          <thead>
            <tr>
              <th></th>
              <th>Name</th>
              <th class="col-md-5">Description</th>
              <th>Tenant</th>
              <th>Deployment Bundle</th>
              <th>Version</th>
              <th class="col-md-4">Actions</th>
            </tr>
          </thead>
          <tbody>
          {{#each definitions:i}}
            {{# searchTerm!=undefined && (
                  (name!=undefined && name.toLowerCase().indexOf(searchTerm.toLowerCase()))===0
                  || (description!=undefined && description.toLowerCase().indexOf(searchTerm.toLowerCase()))===0
                ) }}
            <tr data-href="{{_links.self.href}}">
              <td on-click="select(this)">{{i+1}}</td>
              <td on-click="select(this)">{{name}} ({{key}})</td>
              <td class="col-md-5" on-click="select(this)">{{description}}</td>
              <td on-click="select(this)">{{tenantId}}</td>
              <td on-click="select(this)">{{deploymentId}}</td>
              <td on-click="select(this)">{{version}}</td>
              <td on-click="select(this)">
                <a class="glyphicon glyphicon-play" aria-hidden="true" onclick="ractive.startInstance('{{key}}', '{{name}}', '{{username}}')"></a>
                <a href="/{{tenant.id}}/process-definitions/{{id}}.bpmn" target="_newtab">
                  <a class="glyphicon glyphicon-cloud-download" aria-hidden="true"></a></a>
                <a href="/{{tenant.id}}/process-definitions/{{id}}.png" target="_newtab">
                  <a class="glyphicon glyphicon-picture" aria-hidden="true"></a></a>
                <a class="clickable glyphicon glyphicon-remove" aria-hidden="true" on-click="delete(this.deploymentId)"></a>
              </td>
            </tr>
            {{/}}
          {{/each}}
          </tbody>
        </table>
      </section>

      <section id="currentSect" style="display:none">
        <h2>
          <span>{{current.name}}</span>
          <div class="pull-right">
            <a class="clickable glyphicon glyphicon-play" aria-hidden="true" onclick="ractive.startInstance('{{current.key}}', '{{current.name}}', '{{username}}')" title="Start new instance"></a>
            <a class="clickable glyphicon glyphicon-refresh" aria-hidden="true" onclick="ractive.fetchInstances()" title="Refresh instance list"></a>
            <a class="glyphicon glyphicon-cloud-download" href="/{{tenant.id}}/process-definitions/{{current.id}}.bpmn" target="_newtab" title="Download the BPMN representation of the process"></a>
            <a class="clickable glyphicon glyphicon-remove" aria-hidden="true" onclick="ractive.delete({{current.deploymentId}})" title="Delete this definition"></a>
          </div>          
        </h2>
        <p>{{current.description}}</p>
        <p>
          <span class="a-primary-label control-label">{{current.deployment.name}}: </span>
          <span class="a-primary-data control-label">{{activityType.toLabel()}}</span>
          <span class="a-secondary-label control-label">Id: </span> {{current.id}};
          <span class="a-secondary-label control-label">Deployment Id: </span> {{current.deploymentId}};
          <span class="a-secondary-label control-label">Deployed: </span> {{formatDateTime(current.deployment.deploymentTime)}};
          {{#if current.deployment.category}}
            <span class="a-secondary-label control-label">Category: </span> {{current.deployment.category}};
          {{/if current.deployment.category}} 
        </p>
        {{#if current.id}}
          <img src="/{{tenant.id}}/process-definitions/{{current.id}}.png"/>
        {{/if current.id}}
        <h3>Instances</h3>
        {{#each current.instances:i}}
          <section>
            <span class="a-primary-label control-label">Name: </span>
            <span class="a-primary-data">{{current.instances[i].businessKey == undefined ? 'N/A' : current.instances[i].businessKey}}</span>
            {{#if hasRole('admin') }}
              <span class="a-secondary-label control-label">Id: </span>
              <span class="a-secondary-data">{{current.instances[i].id}};</span>
            {{/if}}
            <span class="a-secondary-label control-label">Complete?: </span>
            <span class="a-secondary-data">{{current.instances[i].ended ? 'Yes' : 'No'}};</span>
            {{# !current.instances[i].ended}}
              <span class="a-secondary-label control-label">Current task: </span>
              <span class="a-secondary-data">{{current.instances[i].activityId.toLabel()}};</span>
            {{/}}
            <button class="btn" on-click="showAuditTrail(current.instances[i],i)" type="button">View History</button>
            <section data-instanceId="{{current.instances[i].id}}" style="display:none">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th></th>
                    <th>Type</th>
                    <th class="col-truncate">Event</th>
                    <th>Started</th>
                    <th>Ended</th>
                    <th>Duration</th>
                    <!-- TODO Always empty? <th>Actioned by</th>-->
                  </tr>
                </thead>
                <tbody>
                  {{#each current.instances[i].auditTrail:j}}
                    <tr data-href="{{_links.self.href}}">
                      <td>{{j+1}}</td>
                      <td>{{activityType.toLabel()}}</td>
                      <td>{{activityName}}</td>
                      <td>{{formatDateTime(startTime)}}</td>
                      <td>{{formatDateTime(endTime)}}</td>
                      <td>{{endTime == undefined ? '' : duration(durationInMillis)}}</td>
                      <!-- TODO Always empty? td>{{assignee}}</td>-->
                    </tr>
                  {{/each}}
                </tbody>
              </table>
            </section>
          </section>
        {{/each}}
      </section>

    </form>
  </script>

  <!-- jQuery (necessary for Bootstrap's JavaScript plugins)
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  -->
  <script src="js/jquery-1.11.0.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="js/bootstrap.min.js"></script>
  <script src="js/bootstrap3-typeahead.min.js"></script>
  <script src="js/bootstrap-datepicker.min.js"></script>
  <!--
       If you need IE8 support, change 'ractive' to 'ractive-legacy'.
  <script src="js/ractive.min.js"></script>
  -->
  <script src="js/ractive.min.js"></script>
  <script src="js/autoNumeric.min.js"></script>
  <script src="js/md5.min.js"></script>
  <script src="js/string-functions-0.1.0.js"></script>
  <script src="js/login-0.8.0.js"></script>
  <script src="js/i18n.js"></script>
  <script src="js/definitions-0.8.0.js"></script>
  <script src="js/omny-0.8.0.js"></script>
</body>
</html>
