<!doctype html>
<html lang='en-GB'>
<head>
  <meta charset='utf-8'>
  <title>Customer Management</title>
  <link href='http://fonts.googleapis.com/css?family=Roboto:400italic,400,700' rel='stylesheet' type='text/css'>
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/omny-0.5.0.css" rel="stylesheet">
  <link href="css/firm-gains-0.5.0.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="images/icon/firmgains-icon-32x32.png" />
</head>
<body>
  <div class="clearfix" id="messages"></div>
<!--
  1. This is the element we'll render our Ractive to.
-->
<div class="container" id="container"></div>

  <!--
       2. You can load a template in many ways. For convenience, we'll include it in
       a script tag so that we don't need to mess around with AJAX or multiline strings.
       Note that we've set the type attribute to 'text/ractive' - though it can be
       just about anything except 'text/javascript'
  -->
  <script id='template' type='text/ractive'>
    <div class="profile pull-right">
      <form name="logoutForm" action="/logout" method="POST">
        <span>Logged in as: {{username}}</span>
        <span class="clickable glyphicon glyphicon-log-out" aria-hidden="true" on-click="logout()"></span>
        <input type="hidden" id="_csrf" name="_csrf" value="{{csrfToken}}" />
      </form>
    </div>
    <h1>
      <a class="nav navbar-brand" href="http://omny.link">
        <img src="/images/firmgains-logo.png" alt="logo"/>
      </a>
      <span>Customer Management</span>
    </h1>
    
      <section id="contactsSect">
        <h2>
          <span id="contactsTableToggle" class="clickable glyphicon glyphicon-triangle-bottom" aria-hidden="true" on-click="toggleResults()"></span>
          <span>Contacts</span>
          <span class="clickable glyphicon glyphicon-plus" aria-hidden="true" on-click="add()"></span>
          <span class="clickable glyphicon glyphicon-refresh" aria-hidden="true" on-click="fetch()"></span>
          <input type="search" class="form-control search" placeholder="Search" value="{{searchTerm}}">
          <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
          <form id="upload" class="admin pull-right upload">
            <span class="glyphicon glyphicon-import pull-right" aria-hidden="true" on-click="upload('upload')"></span>
            <input type="file" class="form-control file pull-right" name="file" placeholder="Select file">
            <select class="form-control entity pull-right" name="entity">
              <option value="contacts">Contacts</option>
              <option value="accounts">Accounts</option>
              <option value="activities">Activities</option>
              <option value="notes">Notes</option>
            </select>
          </form>
        </h2>
        <table id="contactsTable" class="table table-striped">
          <thead>
            <tr>
              <th></th>
              <th>Full Name</th>
              <th>Business Name</th>
              <th>Stage</th>
              <th>Enquiry Type</th>
              <th>Owned by</th>
              <th>First Contact</th>
              <th>Last Updated</th>
              <th class="col-actions">Actions</th>
            </tr>
          </thead>
          <tbody>
          {{#each contacts:i}}
            {{# searchTerm!=undefined && (
                  this.firstName.toLowerCase().indexOf(searchTerm.toLowerCase())===0 
                  || this.lastName.toLowerCase().indexOf(searchTerm.toLowerCase())===0
                  || this.email.toLowerCase().indexOf(searchTerm.toLowerCase())===0
                  || this.accountName.toLowerCase().indexOf(searchTerm.toLowerCase())===0
                ) }}
              <tr data-href="{{links[rel=='self'].href}}" on-click="edit(this)">
                <td>{{i+1}}</td>
                <td>{{firstName}} {{lastName}}</td>
                <td>{{account == undefined ? accountName : account.name}}</td>
                <td>{{stage}}</td>
                <td>{{enquiryType}}</td>
                <td>{{owner}}</td>
                <td>{{formatDate(firstContact)}}</td>
                <td>{{formatDate(lastUpdated)}}</td>
                <td class="col-actions">
                  <span class="clickable glyphicon glyphicon-remove" aria-hidden="true" on-click="delete(this)"></span>
                  <span class="clickable glyphicon glyphicon-pencil" aria-hidden="true" onclick="ractive.edit(this);ractive.toggleResults();"></span>
                </td>
              </tr>
            {{/}}
          {{/each}}
          </tbody>
        </table>
      </section>

      <section id="currentSect" style="display:none">
        <form id="currentForm">
          <h2 class="form create-form">Contact</h2>
          <h2 class="form edit-form">
            <span>Contact</span>
            {{#if (current.phone1 != undefined || current.phone2 != undefined) && (current.phone1 != '' || current.phone2 != '')}}
              <a class="clickable glyphicon glyphicon-earphone" href="tel:{{current.phone1 == undefined || current.phone1 == '' ? current.phone2 : current.phone1 }}"></a>
              {{#if (current.phone1 != undefined && current.phone1 != '')}}
                <span>{{current.phone1}}</span>
              {{/if}}
              {{#if (current.phone2 != undefined && current.phone2 != '')}}
                <span> {{current.phone2}}</span>
              {{/if}}
            {{/if}}
            {{#if current.email != undefined && current.email != ''}}
              <a class="clickable glyphicon glyphicon-envelope" href="mailto:{{current.email}}"></a>
            {{/if}}
            <a class="clickable glyphicon glyphicon-list-alt" href="#notes"></a>
          </h2>

          <div id="currentBody" class="col-md-6">
            <ul class="form edit-form">
              <li><label class="col-md-5">Title:</label><input id="curTitle" placeholder="Title" value="{{current.title}}"/></li>
              <li><label class="col-md-5 required">First Name:</label><input id="curFirstName" placeholder="First Name" required value="{{current.firstName}}"/></li>
              <li><label class="col-md-5 required">Last Name:</label><input id="curLastName" placeholder="Last Name" required value="{{current.lastName}}"/></li>
              <li><label class="col-md-5 required">Email:</label><input id="curEmail" required type="email" value="{{current.email}}"></li>
              <li><label class="col-md-5">Preferred Phone:</label><input id="curPhone1" pattern="\+?[0-9, ]{8,13}" type="tel" value="{{current.phone1}}"></li>
              <li><label class="col-md-5">Alternate Phone:</label><input id="curPhone2" pattern="\+?[0-9, ]{8,13}" type="tel" value="{{current.phone2}}"></li>
              <li><label class="col-md-5">Address:</label><input id="curAddress1" value="{{current.address1}}"/></li>
              <li><label class="col-md-5"></label><input id="curAddress2" value="{{current.address2}}"/></li>
              <li><label class="col-md-5"></label><input id="curTown" value="{{current.town}}"/></li>
              <li><label class="col-md-5"></label><input id="curCountyOrCity" value="{{current.countyOrCity}}"/></li>
              <li><label class="col-md-5">Post Code:</label><input id="curPostCode" pattern="[a-z,A-Z,0-9, ]{5,9}" value="{{current.postCode}}"></li>
            </ul>
          </div>
          <div class="col-md-6">
            <ul class="form edit-form">
              <li><label class="col-md-5">Owner:</label><input class="typeahead" id="curOwner" placeholder="Start typing to filter options" value="{{current.owner}}"/></li>
              <li><label class="col-md-5">Stage:</label><input class="typeahead" id="curStage" placeholder="Start typing to filter options" value="{{current.stage}}"></li>
              <li><label class="col-md-5">Enquiry Type:</label><input class="typeahead" placeholder="Start typing to filter options" id="curEnquiryType" value="{{current.enquiryType}}"></li>
              <li><label class="col-md-5">Account Type:</label><input class="typeahead" placeholder="Start typing to filter options" id="curAccountType" value="{{current.accountType}}"></li>
              <li><label class="col-md-5">Partners Contacted:</label><input class="typeahead" id="curPartnersContacted" value="{{current.account.customFields['partnersContacted']}}"/></li>              
              <li><label class="col-md-5">Page Submitted:</label><input id="curPageSubmitted" readonly value="{{customField(current, 'pageSubmitted')}}"></li>
              <li><label class="col-md-5">Source:</label><input class="typeahead" placeholder="Start typing to filter options" id="curSource" value="{{current.source}}"></li>
              <li><label class="col-md-5">Medium:</label><input class="typeahead" placeholder="Start typing to filter options" id="curMedium" value="{{current.medium}}"></li>
              <li><label class="col-md-5">Campaign:</label><input id="curCampaign" readonly value="{{current.campaign}}"></li>
              <li><label class="col-md-5">Keyword:</label><input id="curKeyword" readonly value="{{current.keyword}}"></li>
            </ul>
          </div>
        </form>

        <form id="currentAccountForm">
          <div id="currentAccount" style="clear: both">

            <h2 class="form">Account</h2>

            <div class="col-md-6">
              <ul class="form edit-form">
                <li><label class="col-md-5 required">Company Name:</label><input id="curAccountName" required value="{{current.account.name}}"></li>
                <li><label class="col-md-5">Company Number:</label><input id="curCompanyNumber" pattern="[0-9]{8}" value="{{current.account.companyNumber}}"></li>
                <li><label class="col-md-5">Website:</label><input id="curBusinessWebsite" type="url" value="{{current.account.businessWebsite}}"></li>
              </ul> 
            </div>
            <div class="col-md-6">
              <ul class="form edit-form">
                <li><label class="col-md-5">Also known as:</label><input id="curAliases" value="{{current.account.aliases}}"></li>
                <li><label class="col-md-5">No. of employees:</label><input id="curNoOfEmployees" type="number" value="{{current.account.noOfEmployees}}"/></li>
                <li><label class="col-md-5">Established:</label><input id="curIncorporationYear" pattern="[0-9]{4}" placeholder="yyyy" value="{{current.account.incorporationYear}}"/></li>
              </ul>
            </div>
          </div>

          <div id="currentAccountDesc" style="clear: both" class="col-md-12">
              <ul class="form edit-form">
                <li><label class="col-md-2">Short description:</label><textarea id="curShortDesc" cols="80" value="{{current.account.shortDesc}}"></textarea></li>
                <li><label class="col-md-2">Description:</label><textarea id="curDescription" cols="80" value="{{current.account.description}}"></textarea></li>
              </ul>
          </div>

          <div id="currentAccountExtended" style="clear: both">
            {{>(tenant.id+'AccountExtension')}}
          </div>

        </form>

        {{#current.activities}}
        <div style="clear: both"></div>

        <form id="activityForm">
         <div id="activitySect" style="clear: both">
         <h2 title="Activities are added automatically by the workflows">
            <span>Activities</span>
          </h2>
          <table id="activitiesTable" class="table table-striped"><tbody>
            {{#each current.activities:j}}
              <tr>
                <td class="field-occurred">{{age(occurred)}} ({{formatDate(occurred)}})</td>
                <td class="field-type">{{type}}</td>
                <td class="field-text">{{content}}</td>
              </tr>
            {{/each}}
          </tbody></table>
         </div>
        </form>
        {{/}}

    	<div style="clear: both"></div>

        <form id="noteForm">
         <div id="notesSect" style="clear: both">
          <h2 id="notes">
            <span>Notes</span>
            <span class="clickable glyphicon glyphicon-plus" aria-hidden="true" onclick="ractive.addNote('{{current._links.self.href}}')"></span>
          </h2>
          <table id="notesTable" class="table table-striped"><tbody>
            <tr style="display:none;">
              <td colspan="3">
                <textarea id="note" on-blur="saveNote()" placeholder="Type your note here" required style="width:100%;"></textarea>
                <br/>
                <a onclick="$('#notesTable tr:nth-child(1)').slideUp();">Cancel</a>
              </td>
            </tr>
            {{#each current.notes:j}}
              <tr>
                <td class="field-age">{{age(created)}} ({{formatDate(created)}})</td>
                <td class="field-author">{{author}}</td>
                <td class="field-text">{{content}}</td>
              </tr>
            {{/each}}
          </tbody></table>
         </div>
        </form>

        <form id="documentForm">
         <div id="documentSect" style="clear: both">
          <h2>
            <span>Documents</span>
            <span class="clickable glyphicon glyphicon-plus" aria-hidden="true" onclick="ractive.addDoc('{{current._links.self.href}}')"></span>
          </h2>
          <table id="docsTable" class="table table-striped"><tbody>
            <tr style="display:none;">
              <td colspan="3">
                <input id="doc" on-blur="saveDoc()" placeholder="Paste document link here" required style="width:100%;"/>
                <br/>
                <a onclick="$('#docsTable tr:nth-child(1)').slideUp();">Cancel</a>
              </td>
            </tr>
            {{#each current.documents:k}}
              <tr>
                <td>{{created}} ({{formatDate(created)}})</td>
                <td>{{author}}</td>
                <td>{{url}}</td>
              </tr>
            {{/each}}
          </tbody></table>
         </div>
        </form>

      </section>

    <!-- PARTIALS FOLLOW AS CANNOT CURRENTLY USE SEPERATE ELEMENT TODO --> 

    <!-- {{>firmgainsAccountExtension}} -->
      <div class="col-md-12" id="currentAccountExtended">
        <h2 class="form"><span>Valuation</span></h2> 
        <div class="col-md-6">
          <ul class="form edit-form">
            <li><label class="col-md-5">Low Quote:</label><input class="autoNumeric" id="curLowQuote" data-a-sign="£ " value="{{current.account.customFields['lowQuote']}}"/></li>
            <li><label class="col-md-5">Medium Quote:</label><input class="autoNumeric" id="curMediumQuote" data-a-sign="£ " value="{{current.account.customFields['mediumQuote']}}"/></li>
            <li><label class="col-md-5">High Quote:</label><input class="autoNumeric" id="curHighQuote" data-a-sign="£ " value="{{current.account.customFields['highQuote']}}"/></li>
            <!--li><button on-click="">Calc</button></li>-->
          </ul>
        </div> 
        <div class="col-md-6">
          <ul class="form edit-form">
            <li><label class="col-md-5">Share of Business (%):</label><input id="curShareOfBusiness" type="number" value="{{current.account.customFields['shareOfBusiness']}}"></li>
            <li><label class="col-md-5">Asking Price:</label><input class="autoNumeric" id="curAskingPrice" data-a-sign="£ "value="{{current.account.customFields['askingPrice']}}"></li>
            <li><label class="col-md-5">Preferred Timing:</label><input id="curPreferredTiming" value="{{current.account.customFields['preferredTiming']}}"/></li>
          </ul>
        </div>
      </div>

      <div class="col-md-12" id="currentAccountExtended">
        <h2 class="form"><span>Business Information</span></h2> 
        <div class="col-md-6">
          <ul class="form edit-form">
<!--            
<li><label class="col-md-5">Stage in Sale:</label><input id="curStageInSale" value="{{current.account.customFields['stageInSale']}}"/></li>
            --><li><label class="col-md-5">Region:</label><input id="curRegion" value="{{current.account.customFields['region']}}"/></li>
          </ul>
        </div> 
        <div class="col-md-6">
          <ul class="form edit-form">
            <li><label class="col-md-5">Sector:</label><input id="curSector" value="{{current.account.customFields['sector']}}"/></li>
            <li><label class="col-md-5">Sub-Sector:</label><input id="curSubSector" value="{{current.account.customFields['subSector']}}"/></li>
          </ul>
        </div>
      </div>

      <div id="currentAccountProperty" style="clear: both" class="col-md-12">
        <ul class="form edit-form">
<fieldset>
          <legend>Furthermore...</legend>
        
          <li><label class="col-md-2">Already Contacted:</label><textarea cols="80" id="curAlreadyContacted" value="{{current.account.customFields['alreadyContacted']}}"></textarea></li>
          <li><label class="col-md-2">Reason for Selling:</label><textarea cols="80" id="curReasonForSale" value="{{current.account.customFields['reasonForSale']}}"></textarea></li>
          <li><label class="col-md-2">Potential Purchasers:</label><textarea cols="80" id="curPotentialPurchasers" value="{{current.account.customFields['potentialPurchasers']}}"></textarea></li>
          <li><label class="col-md-2">Property Info:</label><textarea cols="80" id="curPropertyInfo" value="{{current.account.customFields['propertyInfo']}}"></textarea></li>
</fieldset>
        </ul>
      </div>

      <div class="col-md-12" id="currentAccountFinancials">
        <h2 class="form"><span>Financials</span></h2> 
        <div class="col-md-6">
          <ul class="form edit-form">
            <li><label class="col-md-5">EBITDA:</label><input class="autoNumeric" id="curEbitda" data-a-sign="£ "value="{{current.account.customFields['ebitda']}}"/></li>
            <li><label class="col-md-5">Surplus:</label><input class="autoNumeric" id="curSurplus" data-a-sign="£ "value="{{current.account.customFields['surplus']}}"/></li>
            <li><label class="col-md-5">Depreciation:</label><input class="autoNumeric" id="curDepreciation" data-a-sign="£ "value="{{current.account.customFields['depreciationAmortisation']}}"/></li>
            <li><label class="col-md-5">Assets:</label><input class="autoNumeric" id="curAssets" data-a-sign="£ "value="{{current.account.customFields['assets']}}"/></li>
          </ul>
        </div> 
        <div class="col-md-6">
          <ul class="form edit-form">
            <li><label class="col-md-5">Operating Profit:</label><input class="autoNumeric" id="curOperatingProfit" data-a-sign="£ "value="{{current.account.customFields['operatingProfit']}}"/></li>
            <li><label class="col-md-5">Adjustments:</label><input class="autoNumeric" id="curAdjustments" data-a-sign="£ "value="{{current.account.customFields['adjustments']}}"/></li>
            <li><label class="col-md-5">Borrowing:</label><input class="autoNumeric" id="curBorrowing" data-a-sign="£ "value="{{current.account.customFields['borrowing']}}"/></li>
          </ul>
        </div> 
        <div class="col-md-12">
          <fieldset>
            <legend>Current Year</legend>
            <label class="col-md-offset-1">Financial Year:</label><input id="curCurrentFinancialYear" pattern="[0-9]{4}" placeholder="yyyy" type="number" value="{{current.account.customFields['currentFinancialYear']}}"/>
            <label>Turnover:</label><input class="autoNumeric" id="curCurrentTurnover" data-a-sign="£ "value="{{current.account.customFields['currentTurnover']}}"/>
            <label>Profit:</label><input class="autoNumeric" id="curCurrentProfit" data-a-sign="£ "value="{{current.account.customFields['currentProfit']}}"/>
          </fieldset>
          <fieldset>
            <legend>Last Year</legend>
            <label class="col-md-offset-1">Financial Year:</label><input id="curLastFinancialYear" pattern="[0-9]{4}" placeholder="yyyy" type="number" value="{{current.account.customFields['lastFinancialYear']}}"/>
            <label>Turnover:</label><input class="autoNumeric" id="curLastTurnover" data-a-sign="£ "value="{{current.account.customFields['lastTurnover']}}"/>
            <label>Profit:</label><input class="autoNumeric" id="curLastProfit" data-a-sign="£ "value="{{current.account.customFields['lastProfit']}}"/>
          </fieldset>
          <fieldset>
            <legend>Previous Year</legend>
            <label class="col-md-offset-1">Financial Year:</label><input id="curPreviousFinancialYear" pattern="[0-9]{4}" placeholder="yyyy" type="number" value="{{current.account.customFields['previousFinancialYear']}}"/>
            <label>Turnover:</label><input class="autoNumeric" id="curPreviousTurnover" data-a-sign="£ "value="{{current.account.customFields['previousTurnover']}}"/>
            <label>Profit:</label><input class="autoNumeric" id="curPreviousProfit" data-a-sign="£ "value="{{current.account.customFields['previousProfit']}}"/>
          </fieldset>

        </div>

      </div>
    <!-- {{/firmgainsAccountExtension}} -->

    <!-- {{>column}} -->
      <div class="col-md-6">
        <ul class="form edit-form">
          {{#each fields:j}}
            <li><label class="col-md-5">{{label}}:</label><input id="curUnknown" value="{{object.customFields[key]}}"></li>
          {{/each}}
        </ul>
      </div>
    <!-- {{/column}} -->

  </script>
  
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="js/jquery-1.11.0.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="js/bootstrap.min.js"></script>
  <script src="js/bootstrap3-typeahead.js"></script>
  <!--
       3. You can always get the most recent stable version from the URL below.
       If you want the newest features, use the 'edge' version instead:

           http://cdn.ractivejs.org/edge/ractive.min.js

       If you need IE8 support, change 'ractive' to 'ractive-legacy'.
  -->
  <script src="js/ractive.min.js"></script>
  <script src="js/autoNumeric.min.js"></script>
  <script src="js/login-0.5.0.js"></script>
  <script src="js/i18n.js"></script>
  <script src="js/cust-mgmt-0.5.0.js"></script>
  <script src="js/omny-0.5.0.js"></script>
</body>
</html>
