<!doctype html>
<html lang='en-GB'>
<head>
  <meta charset='utf-8'>
  <title>Customer Management</title>
  <link href="/webjars/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
  <link href="/webjars/bootstrap/3.3.5/css/bootstrap-theme.min.css" rel="stylesheet">
  <link href="css/omny-0.9.0.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="images/icon/omny-icon-16x16.png" />
  <!-- nice blocky yet tall font 
  <link rel='stylesheet' id='google-fonts-css'  href='//fonts.googleapis.com/css?family=Oswald%3A400%7CNoto+Sans&#038;ver=2.1.2' type='text/css' media='all' />
  -->
</head>
<body>
  <div class="clearfix" id="messages"></div>
  <div class="container" id="container"></div>
  <script id='template' type='text/ractive'>
    <div class="profile pull-right">
      <form name="logoutForm" action="/logout" method="POST">
          <span id="tenantId" class="replaceable super_admin" contenteditable="true" onblur="ractive.switchToTenant($('#tenantId').text())" name="tenantId" value="{{tenant == null ? 'Click to set' : tenant.id}}"></span>
        <span class="profile-img">Logged in as: {{username}}</span>
        <a class="clickable glyphicon glyphicon-log-out" aria-hidden="true" on-click="logout()"></a>
        <input type="hidden" id="_csrf" name="_csrf" value="{{csrfToken}}" />
      </form>
    </div>
    <h1>
      <a class="nav navbar-brand" href="http://omny.link"></a>
      <span>Customer Management</span>
    </h1>
    
      <section id="contactsSect">
        <h2>
          <a id="contactsTableToggle" class="clickable glyphicon glyphicon-triangle-bottom" aria-hidden="true" on-click="toggleResults()" title="Collapse or expand the contact table"></a>
          <span>Contacts</span>
          <a class="clickable glyphicon glyphicon-plus" aria-hidden="true" on-click="add()" title="Add a new contact"></a>
          <a class="clickable glyphicon glyphicon-refresh" aria-hidden="true" on-click="fetch()" title="Refresh the list"></a>
          <input type="search" class="form-control search" placeholder="Search" value="{{searchTerm}}">
          <a class="glyphicon glyphicon-search" aria-hidden="true" title="Search for matching contacts"></a>
          <a class="clickable dropdown" aria-hidden="true" title="Show filters">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
                <a class="clickable glyphicon glyphicon-filter dropdown" aria-hidden="true" title="Show filters"> <span class="caret"></a>
              </a>
              <ul class="omny-dropdown dropdown-menu" role="menu">
                <li on-click="filter()">Clear filter</li>
                <li class="divider"></li>
                {{#stages}}
                  <li onclick="ractive.filter('stage','{{id}}')">{{name}}</li>
                {{/stages}}
                <li class="divider"></li>
                {{#accountTypes}}
                  <li onclick="ractive.filter('accountType','{{id}}')">{{name}}</li>
                {{/accountTypes}}
              </ul>
          </a>

          <form id="upload" class="super-admin pull-right upload">
            <a class="glyphicon glyphicon-import pull-right" aria-hidden="true" on-click="upload('upload')" title="Import data from file"></a>
            <input type="file" class="form-control file pull-right" name="file" placeholder="Select file">
            <select class="form-control entity pull-right" name="entity">
              <option value="contacts">Contacts</option>
              <option value="accounts">Accounts</option>
              <option value="activities">Activities</option>
              <option value="notes">Notes</option>
            </select>
          </form>
        </h2>
        <table id="contactsTable" class="table table-striped">
          <thead>
            <tr>
              <th></th>
              <th>Full Name</th>
              {{#tenant.show.account}}<th>Business Name</th>{{/}}
              <th>Stage</th>
              <th>Enquiry Type</th>
              <th>Owned by</th>
              <th>First Contact</th>
              <th>Last Updated</th>
              <th class="col-actions">Actions</th>
            </tr>
          </thead>
          <tbody>
          {{#each contacts:i}}
            {{# (searchTerm!=undefined && (
                  (this.firstName!=undefined && this.firstName.toLowerCase().indexOf(searchTerm.toLowerCase()))===0 
                  || (this.lastName!=undefined && this.lastName.toLowerCase().indexOf(searchTerm.toLowerCase()))===0
                  || (this.email!=undefined && this.email.toLowerCase().indexOf(searchTerm.toLowerCase()))===0
                  || (this.town!=undefined && this.town.toLowerCase().indexOf(searchTerm.toLowerCase()))===0
                  || (this.countyOrCity!=undefined && this.countyOrCity.toLowerCase().indexOf(searchTerm.toLowerCase()))===0
                  || (this.country!=undefined && this.country.toLowerCase().indexOf(searchTerm.toLowerCase()))===0
                  || (this.accountName!=undefined && this.accountName.toLowerCase().indexOf(searchTerm.toLowerCase()))===0
                ))
                && 
                (matchFilter(this))
            }}
                <tr data-href="{{links[rel=='self'].href}}" on-click="edit(this)">
                  <td>{{i+1}}</td>
                  <td>{{firstName}} {{lastName}}</td>
                  {{#tenant.show.account}}
                    <td>{{account == undefined ? accountName : account.name}}</td>
                  {{/}}
                  <td>{{stage}}</td>
                  <td>{{enquiryType}}</td>
                  <td>{{{hash(owner)}}}</td>
                  <td>{{formatDate(firstContact)}}</td>
                  <td>{{formatDate(lastUpdated)}}</td>
                  <td class="col-actions">
                    <a class="clickable admin glyphicon glyphicon-remove" aria-hidden="true" on-click="delete(this)" title="Delete this record"></a>
                    <a class="clickable glyphicon glyphicon-pencil" aria-hidden="true" onclick="ractive.edit(this);ractive.toggleResults();" title="View or edit this contact"></a>
                  </td>
                </tr>
            {{/}}
          {{/each}}
          </tbody>
          <tfoot>
            {{# searchTerm!=undefined }}
              <tr><th colspan="9">{{searchMatched == 0 ? 'No' : searchMatched}} matching contact{{searchMatched==1 ? '' : 's'}}</th></tr>
            {{/}} 
          </tfoot>
        </table>
      </section>

      <section id="currentSect" style="display:none">
        <form id="currentForm">
          <div class="form create-form">
            <input class="col-xs-1" id="curTitle" placeholder="Title" value="{{current.title}}"/>
            <input class="col-xs-2" id="curFirstName" placeholder="First Name" required value="{{current.firstName}}"/>
            <input class="col-xs-2" id="curLastName" placeholder="Last Name" required value="{{current.lastName}}"/>
          </div>

          <h2 class="form create-form">&nbsp;</h2>
          <h2 class="form edit-form">
            <span contenteditable id="curTitle2" on-focus="editField('#curTitle2','current.title')" on-blur="updateField('#curTitle2','current.title')">{{current.title}}</span>
            <span contenteditable id="curFirstName2" on-focus="editField('#curFirstName2','current.firstName')" on-blur="updateField('#curFirstName2','current.firstName')">{{current.firstName}}</span>
            <span contenteditable id="curLastName2" on-focus="editField('#curLastName2','current.lastName')" on-blur="updateField('#curLastName2','current.lastName')">{{current.lastName}}</span>
            {{#if (current.phone1 != undefined || current.phone2 != undefined) && (current.phone1 != '' || current.phone2 != '')}}
              <a class="clickable glyphicon glyphicon-earphone" href="tel:{{current.phone1 == undefined || current.phone1 == '' ? current.phone2 : current.phone1 }}" title="Click to call"></a>
              {{#if (current.phone1 != undefined && current.phone1 != '')}}
                <span>{{current.phone1}}</span>
              {{/if}}
              {{#if (current.phone2 != undefined && current.phone2 != '')}}
                <span> {{current.phone2}}</span>
              {{/if}}
            {{/if}}
            {{#if current.email != undefined && current.email != ''}}
              <a class="clickable glyphicon glyphicon-envelope" href="mailto:{{current.email}}" title="Click to email"></a>
            {{/if}}
            <a class="clickable glyphicon glyphicon-paperclip" href="#notes" title="Jump to Notes"></a>
            <span class="pull-right">
              <a class="clickable admin glyphicon glyphicon-remove" aria-hidden="true" on-click="delete(current)" title="Delete this record"></a>
              {{#if tenant.customerActions!=undefined && tenant.customerActions.length>0 }}
                <span class="clickable dropdown" aria-hidden="true" title="Start Process">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
                    <a class="clickable glyphicon glyphicon-play dropdown" aria-hidden="true" title="Start Process"> <span class="caret"></a>
                  </a>
                  <ul class="omny-dropdown dropdown-menu" role="menu">
                    {{#each tenant.customerActions }}
                      <li onclick="ractive.startCustomerAction('{{key}}', '{{label}}', ractive.get('current'))">{{label}}</li>
                    {{/each}}
                  </ul>
                </span>
              {{/if}}
            </span>
          </h2>

          <div class="currentBody col-md-6">
            <ul class="form edit-form">
              <li><label class="col-md-5 required">Email:</label><input id="curEmail" required type="email" value="{{current.email}}"></li>
              <li><label class="col-md-offset-5">Do Not Email:</label><input id="curDoNotEmail" type="checkbox" checked="{{current.doNotEmail}}"></li>
              <li><label class="col-md-5">Preferred Phone:</label><input id="curPhone1" value="{{current.phone1}}"></li>
              <li><label class="col-md-5">Alternate Phone:</label><input id="curPhone2" value="{{current.phone2}}"></li>
              <li><label class="col-md-offset-5">Do Not Call:</label><input id="curDoNotCall" type="checkbox" checked="{{current.doNotCall}}"></li>
              <li><label class="col-md-5">Owner: </label><input class="typeahead" placeholder="Start typing to filter options" id="curOwner" value="{{current.owner}}"></li>
              <li><label class="col-md-5">Stage:</label><input class="typeahead" placeholder="Start typing to filter options" id="curStage" value="{{current.stage}}"></li>
              <li><label class="col-md-5">Enquiry Type:</label><input class="typeahead" placeholder="Start typing to filter options" id="curEnquiryType" value="{{current.enquiryType}}"></li>
              <li><label class="col-md-5">Account Type:</label><input class="typeahead" placeholder="Start typing to filter options" placeholder="Start typing to filter options" id="curAccountType" value="{{current.accountType}}"></li>
            </ul>
          </div>
          <div class="currentBody col-md-6">
            <ul class="form edit-form">
              <li><label class="col-md-5">Address:</label><input id="curAddress1" value="{{current.address1}}"/></li>
              <li><label class="col-md-5"></label><input id="curAddress2" value="{{current.address2}}"/></li>
              <li><label class="col-md-5"></label><input id="curTown" placeholder="Town or village" value="{{current.town}}"/></li>
              <li><label class="col-md-5"></label><input id="curCountyOrCity" placeholder="City, county or other province" value="{{current.countyOrCity}}"/></li>
              <li><label class="col-md-5">Post Code:</label><input id="curPostCode" pattern="[a-z,A-Z,0-9, ]{5,9}" value="{{current.postCode}}"></li>
              <li><label class="col-md-5">Country:</label><input autocomplete="false" class="typeahead" placeholder="Start typing to filter options" id="curCountry" value="{{current.country}}"></li>
            </ul>
          </div>

          {{#tenant.show.marketing}}
            <h2 style="clear:both">Marketing</h2>
            <div class="currentBody col-md-6">
              <ul class="form edit-form">
                <li><label class="col-md-5">Source:</label><input class="typeahead" placeholder="Start typing to filter options" id="curSource" {{ current.source ? 'disabled readonly' : '' }} value="{{current.source}}"></li>
                <li><label class="col-md-5">Medium:</label><input class="typeahead" placeholder="Start typing to filter options" id="curMedium" {{ current.medium ? 'disabled readonly' : '' }} value="{{current.medium}}"></li>
              </ul>
            </div>
            <div class="currentBody col-md-6">
              <ul class="form edit-form">
                <li><label class="col-md-5">Page Submitted:</label><input id="curPageSubmitted" disabled readonly value="{{customField(current, 'pageSubmitted')}}"></li>
                <li><label class="col-md-5">Campaign:</label><input id="curCampaign" {{ current.campaign ? 'disabled readonly' : '' }} value="{{current.campaign}}"></li>
              </ul>
            </div>
          {{/tenant.show.marketing}}

          {{#tenant.show.budget}}
            <h2 style="clear:both">Budget</h2>
            <div class="currentBody col-md-6">
              <ul class="form edit-form">
                <li><label class="col-md-5">Budget:</label>
                  <input class="autoNumeric" data-a-sign="£ " id="curBudget" on-blur="ractive.save()" value="{{current.customFields['budget']}}"></li>
              </ul>
            </div>
            <div class="currentBody col-md-6">
              <ul class="form edit-form">
                <li><label class="col-md-5">Discussed Budget?:</label>
                  <input id="curDiscussedBudget" on-blur="ractive.save()" type="checkbox" checked="{{current.customFields['discussedBudget']}}"></li>
              </ul>              
            </div>
          {{/tenant.show.account}}

          <div id="currentContactExtended" style="clear: both">
            {{>(tenant.id+'ContactExtension')}}
          </div>
        </form>

        {{#tenant.show.account}}
        <form id="currentAccountForm">
          <div id="currentAccount" style="clear: both">

            <h2 class="form">Account</h2>

            <div class="currentBody col-md-6">
              <ul class="form edit-form">
                <li><label class="col-md-5 required">Company Name:</label><input id="curAccountName" required value="{{current.account.name}}"></li>
                <li><label class="col-md-5">Website:</label><input id="curBusinessWebsite" type="url" value="{{current.account.businessWebsite}}"></li>
                <!--<li><label class="col-md-5">Also known as:</label><input id="curAliases" value="{{current.account.aliases}}"></li>-->
              </ul> 
            </div>
            <div class="currentBody col-md-6">
              <ul class="form edit-form">
                <li><label class="col-md-5">Company Number:</label><input id="curCompanyNumber" pattern="[0-9]{8}" value="{{current.account.companyNumber}}"></li>
                <li><label class="col-md-5">No. of employees:</label><input id="curNoOfEmployees" type="number" value="{{current.account.noOfEmployees}}"/></li>
              </ul>
            </div>
          </div>

          <div id="currentAccountDesc" style="clear: both" class="col-md-12">
              <ul class="form edit-form">
                <li><label class="col-md-2">Description:</label><textarea id="curDescription" cols="80" value="{{current.account.description}}"></textarea></li>
              </ul>
          </div>

          <div id="currentAccountExtended" style="clear: both">
            {{>(tenant.id+'AccountExtension')}}

            <!-- TODO General purpose account extension if no dedicated one available 
            {{#if tenant.accountFields}}
              <div class="col-md-12" id="currentAccountExtended">
                <h2 class="form">
                  <span>More...</span>
                </h2>

                <!-- first column - ->  
                {{>column {object: current.account, fields: tenant.accountFields.slice(0,Math.floor(tenant.accountFields.length/2))} }}

                <!-- second column - ->  
                {{>column {object: current.account, fields: tenant.accountFields.slice(Math.ceil(tenant.accountFields.length/2),tenant.accountFields.length)} }}

              </div>
            {{/if}}-->
          </div>

        </form>
        {{/}}
        
      {{#if current['activities'] != undefined}}
        <div style="clear: both"></div>

        <form id="activityForm">
         <div id="activitySect" style="clear: both">
          <h2 title="Activities are added automatically by the workflows">
            <span>Activities</span>
            <!--<span class="glyphicon glyphicon-flash" aria-hidden="true" on-click="followUp(this.get('current'))"></span>-->
          </h2>
          <table id="activitiesTable" class="table table-striped"><tbody>
            {{#each current.activities:j}}
              <tr>
                <td class="field-occurred">{{age(occurred)}} ({{formatDate(occurred)}})</td>
                <td class="field-type">{{type}}</td>
                <td class="field-text" id="activity{{j}}">{{{formatJson(content)}}}</td>
              </tr>
            {{/each}}
            {{^ current.activities }}
              <tr><td>None</td></tr>
            {{/ current.activities }}
          </tbody></table>
         </div>
        </form>
      {{/if}}
        
    	<div style="clear: both"></div>

        <form id="noteForm">
         <div id="notesSect" style="clear: both">
          <h2 id="notes">
            <span>Notes</span>
            <span class="clickable glyphicon glyphicon-plus" aria-hidden="true" onclick="ractive.addNote('{{current._links.self.href}}')" title="Add a new note"></span>
          </h2>
          <table id="notesTable" class="table table-striped"><tbody>
            <tr style="display:none;">
              <td colspan="3">
                <textarea id="note" on-blur="saveNote()" placeholder="Type your note here" required style="width:100%;"></textarea>
                <br/>
                <a onclick="$('#notesTable tr:nth-child(1)').slideUp();">Cancel</a>
              </td>
            </tr>
            {{#each current.notes:j}}
              <tr>
                <td class="field-age">{{age(created)}} ({{formatDate(created)}})</td>
                <td class="field-author">{{{hash(author)}}}</td>
                <td class="field-text">{{{content}}}</td>
              </tr>
            {{/each}}
            {{^ current.notes }}
              <tr><td>None</td></tr>
            {{/ current.notes }}
          </tbody></table>
         </div>
        </form>

        <form id="documentForm">
         <div id="documentSect" style="clear: both">
          <h2>
            <span>Documents</span>
            <span class="clickable glyphicon glyphicon-plus" aria-hidden="true" onclick="ractive.addDoc('{{current._links.self.href}}')" title="Add a new Document"></span>
          </h2>
          <table id="docsTable" class="table table-striped"><tbody>
            <tr style="display:none;">
              <td colspan="3">
                <input id="doc" on-blur="saveDoc()" placeholder="Paste document link here" required style="width:100%;"/>
                <br/>
                <a onclick="$('#docsTable tr:nth-child(1)').slideUp();">Cancel</a>
              </td>
            </tr>
            {{#each current.documents:k}}
              <tr>
                <td class="field-age">{{age(created)}} ({{formatDate(created)}})</td>
                <td class="field-author">{{{hash(author)}}}</td>
                <td class="field-url"><a href="{{url}}">Click to open</a></td>
              </tr>
            {{/each}}
            {{^ current.documents }}
              <tr><td>None</td></tr>
            {{/ current.documents }}
          </tbody></table>
         </div>
        </form>

      </section>

    <!-- {{>column}} -->
      <div class="currentBody col-md-6">
        <ul class="form edit-form">
          {{#each fields:j}}
            <li><label class="col-md-5">{{label}}:</label><input id="curUnknown" value="{{object.customFields[key]}}"></li>
          {{/each}}
        </ul>
      </div>
    <!-- {{/column}} -->
  </script>

  <script src="/webjars/jquery/1.11.1/jquery.min.js"></script>
  <script src="/webjars/bootstrap/3.3.5/js/bootstrap.min.js"></script>
  <script src="/webjars/Bootstrap-3-Typeahead/3.1.1/bootstrap3-typeahead.js"></script>
  <script src="/webjars/ractive/0.7.1/ractive.min.js"></script>

  <script src="js/autoNumeric.js"></script>
  <script src="js/md5.min.js"></script>
  <script src="js/login-0.9.0.js"></script>
  <script src="js/i18n.js"></script>
  <script src="js/cust-mgmt-0.9.0.js"></script>
  <script src="js/omny-0.9.0.js"></script>
</body>
</html>
