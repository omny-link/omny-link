<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:activiti="http://activiti.org/bpmn" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:tns="http://omny.link/custmgmt" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:yaoqiang="http://bpmn.sourceforge.net" exporter="Yaoqiang BPMN Editor" exporterVersion="2.2.18 (GPLv3, Non-Commercial)" expressionLanguage="http://activiti.org/Juel" id="_1422450380149" name="" targetNamespace="http://omny.link/custmgmt" typeLanguage="http://www.w3.org/2001/XMLSchema" xsi:schemaLocation="http://www.omg.org/spec/BPMN/20100524/MODEL http://bpmn.sourceforge.net/schemas/BPMN20.xsd">
  <process id="CreateContactAndAccount" isClosed="false" isExecutable="true" name="Create Contact and Account" processType="None">
    <documentation id="CreateContactAndAccount_D_1" textFormat="text/plain"><![CDATA[Reusable process to create contact and account from a single JSON message.]]></documentation>
    <extensionElements>
      <yaoqiang:pageFormat height="842.4" imageableHeight="832.4" imageableWidth="587.6" imageableX="5.0" imageableY="5.0" orientation="0" width="597.6"/>
      <yaoqiang:page background="#FFFFFF" horizontalCount="1" verticalCount="1"/>
    </extensionElements>
    <ioSpecification>
      <dataInput id="_15" isCollection="false" name="External Contact"/>
      <dataOutput id="_17" isCollection="false" name="Omny Contact"/>
      <dataOutput id="_19" isCollection="false" name="Omny Account"/>
      <inputSet>
        <dataInputRefs>_15</dataInputRefs>
      </inputSet>
      <outputSet>
        <dataOutputRefs>_17</dataOutputRefs>
        <dataOutputRefs>_19</dataOutputRefs>
      </outputSet>
    </ioSpecification>
    <startEvent id="_2" isInterrupting="true" name="Start Event" parallelMultiple="false">
      <outgoing>_4</outgoing>
    </startEvent>
    <scriptTask completionQuantity="1" id="_3" isForCompensation="false" name="Split Contact&#10;and Account" scriptFormat="JavaScript" startQuantity="1">
      <incoming>_4</incoming>
      <outgoing>_6</outgoing>
      <ioSpecification>
        <dataInput id="Din_3_15" isCollection="false"/>
        <dataOutput id="Dout_3_17" isCollection="false"/>
        <dataOutput id="Dout_3_19" isCollection="false"/>
        <inputSet>
          <dataInputRefs>Din_3_15</dataInputRefs>
        </inputSet>
        <outputSet>
          <dataOutputRefs>Dout_3_17</dataOutputRefs>
          <dataOutputRefs>Dout_3_19</dataOutputRefs>
        </outputSet>
      </ioSpecification>
      <dataInputAssociation id="_16">
        <sourceRef>_15</sourceRef>
        <targetRef>Din_3_15</targetRef>
      </dataInputAssociation>
      <dataOutputAssociation id="_18">
        <sourceRef>Dout_3_17</sourceRef>
        <targetRef>_17</targetRef>
      </dataOutputAssociation>
      <dataOutputAssociation id="_13">
        <sourceRef>Dout_3_19</sourceRef>
        <targetRef>_19</targetRef>
      </dataOutputAssociation>
      <script><![CDATA[
var System = java.lang.System;
var json = execution.getVariable('json');
System.out.println('JSON: '+json);
var extContact = JSON.parse(json);
System.out.println('extContact: '+extContact);
System.out.println('external acct: '+extContact.account);
var account = JSON.stringify(extContact.account);
var contact = extContact;
contact.account = undefined; 
//var account = extContact.account;

var pageSubmitted = extContact['pageSubmitted'];
if (pageSubmitted!=undefined) { 
  //println('Setting page submitted to: '+pageSubmitted);
  if (contact['customFields']==undefined) contact.customFields = {};
  contact.customFields.pageSubmitted = pageSubmitted; 
}
  
execution.setVariable('contactFirstName',extContact.firstName);
execution.setVariable('contactEmail',extContact.email);
execution.setVariable('contactPwd',extContact.password == undefined ? null : extContact.password);
execution.setVariable('contact',JSON.stringify(contact));
execution.setVariable('account',account == undefined ? null : account);
]]></script>
    </scriptTask>
    <sequenceFlow id="_4" sourceRef="_2" targetRef="_3"/>
    <serviceTask activiti:class="com.knowprocess.resource.spi.RestPost" completionQuantity="1" id="_5" implementation="##WebService" isForCompensation="false" name="POST &#10;contact" startQuantity="1">
      <extensionElements>
        <activiti:field name="resourceUsername">
          <activiti:string>userInfo('tenant-bot')</activiti:string>
        </activiti:field>
        <activiti:field name="resourcePassword">
          <activiti:expression>userInfo('cust-mgmt-secret')</activiti:expression>
        </activiti:field>
        <activiti:field name="globalResource">
          <activiti:expression>userInfo('cust-mgmt-url')/contacts</activiti:expression>
        </activiti:field>
        <activiti:field name="headers">
          <activiti:string>Content-Type:application/json,Accept:application/json</activiti:string>
        </activiti:field>
        <activiti:field name="data">
          <activiti:expression>${contact}</activiti:expression>
        </activiti:field>
        <activiti:field expression="contactId=Location" name="responseHeaders"/>
      </extensionElements>
      <incoming>_6</incoming>
      <outgoing>_32</outgoing>
    </serviceTask>
    <sequenceFlow id="_6" sourceRef="_3" targetRef="_5"/>
    <serviceTask activiti:class="com.knowprocess.resource.spi.RestPost" completionQuantity="1" id="_7" implementation="##WebService" isForCompensation="false" name="POST &#10;account" startQuantity="1">
      <extensionElements>
        <activiti:field name="resourceUsername">
          <activiti:string>userInfo('tenant-bot')</activiti:string>
        </activiti:field>
        <activiti:field name="resourcePassword">
          <activiti:expression>userInfo('cust-mgmt-secret')</activiti:expression>
        </activiti:field>
        <activiti:field name="globalResource">
          <activiti:expression>userInfo('cust-mgmt-url')/accounts</activiti:expression>
        </activiti:field>
        <activiti:field name="headers">
          <activiti:string>Content-Type:application/json,Accept:application/json</activiti:string>
        </activiti:field>
        <activiti:field name="data">
          <activiti:expression>${account}</activiti:expression>
        </activiti:field>
        <activiti:field expression="accountId=Location" name="responseHeaders"/>
      </extensionElements>
      <incoming>_21</incoming>
      <outgoing>_10</outgoing>
    </serviceTask>
    <serviceTask activiti:class="com.knowprocess.resource.spi.RestPut" completionQuantity="1" id="_9" implementation="##WebService" isForCompensation="false" name="PUT association&#10;between contact &#10;and account" startQuantity="1">
      <extensionElements>
        <activiti:field name="resourceUsername">
          <activiti:string>userInfo('tenant-bot')</activiti:string>
        </activiti:field>
        <activiti:field name="resourcePassword">
          <activiti:expression>userInfo('cust-mgmt-secret')</activiti:expression>
        </activiti:field>
        <activiti:field name="globalResource">
          <activiti:expression>${contactId}/account</activiti:expression>
        </activiti:field>
        <activiti:field name="headers">
          <activiti:string>Content-Type:text/uri-list,Accept:application/json</activiti:string>
        </activiti:field>
        <activiti:field name="data">
          <activiti:expression>${accountId}</activiti:expression>
        </activiti:field>
        <activiti:field name="responseVar">
          <activiti:expression>textResponse</activiti:expression>
        </activiti:field>
      </extensionElements>
      <incoming>_10</incoming>
      <outgoing>_12</outgoing>
    </serviceTask>
    <sequenceFlow id="_10" sourceRef="_7" targetRef="_9"/>
    <endEvent id="_11" name="End Event">
      <incoming>_12</incoming>
    </endEvent>
    <sequenceFlow id="_12" sourceRef="_9" targetRef="_11"/>
    <dataObject id="DO_CreateContactAndAccount_1" isCollection="false" name="Data Object"/>
    <sequenceFlow id="_21" name="Yes" sourceRef="_14" targetRef="_7">
      <extensionElements>
        <yaoqiang:label offset-x="-3.0" offset-y="0.0" x="0.0" y="22.0"/>
      </extensionElements>
      <conditionExpression><![CDATA[${!empty account}]]></conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="_23" name="No" sourceRef="_14" targetRef="_22"/>
    <endEvent id="_22" name="End Event">
      <incoming>_23</incoming>
    </endEvent>
    <exclusiveGateway default="_23" gatewayDirection="Diverging" id="_14" name="Have account?">
      <incoming>_33</incoming>
      <outgoing>_21</outgoing>
      <outgoing>_23</outgoing>
    </exclusiveGateway>
    <callActivity calledElement="SendAddressConfirmationEmail" completionQuantity="1" id="_31" isForCompensation="false" name="Send&#10;confirmation&#10;email" startQuantity="1">
      <extensionElements>
        <activiti:in sourceExpression="Account activation code" target="subject"/>
        <activiti:in sourceExpression="${contact.getString('email')}" target="contactEmail"/>
        <activiti:in sourceExpression="${contact.getString('firstName')}" target="contactFirstName"/>
        <activiti:in sourceExpression="http://api.omny.link:8082/${tenantId}/contacts" target="baseUrl"/>
        <activiti:in sourceExpression="The Omny Link Team" target="signOff"/>
        <activiti:in sourceExpression="${contact}" target="contact"/>
      </extensionElements>
      <incoming>_32</incoming>
      <outgoing>_33</outgoing>
    </callActivity>
    <sequenceFlow id="_32" sourceRef="_5" targetRef="_31"/>
    <sequenceFlow id="_33" sourceRef="_31" targetRef="_14"/>
  </process>
  <globalTask id="GT_1" name="Global Task"/>
  <bpmndi:BPMNDiagram id="Yaoqiang_Diagram-_1" name="New Diagram" resolution="96.0">
    <bpmndi:BPMNPlane bpmnElement="CreateContactAndAccount">
      <bpmndi:BPMNShape bpmnElement="_2" id="Yaoqiang-_2">
        <dc:Bounds height="32.0" width="32.0" x="70.96153846153848" y="287.8181818181818"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="63.0" x="55.46153846153845" y="329.1443536931818"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_3" id="Yaoqiang-_3">
        <dc:Bounds height="81.0" width="116.0" x="196.38461538461536" y="263.3181818181818"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="32.955078125" width="74.0" x="217.38461538461536" y="289.3406427556818"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_5" id="Yaoqiang-_5">
        <dc:Bounds height="81.0" width="116.0" x="348.30769230769226" y="263.3181818181818"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="32.955078125" width="46.0" x="383.30769230769226" y="289.3406427556818"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_7" id="Yaoqiang-_7">
        <dc:Bounds height="81.0" width="116.0" x="775.2307692307692" y="263.3181818181818"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="32.955078125" width="49.0" x="808.7307692307692" y="289.3406427556818"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_9" id="Yaoqiang-_9">
        <dc:Bounds height="81.0" width="116.0" x="927.0" y="263.3181818181818"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="46.955078125" width="93.0" x="938.5" y="282.3406427556818"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_11" id="Yaoqiang-_11">
        <dc:Bounds height="32.0" width="32.0" x="1072.9545454545455" y="287.8181818181818"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="58.0" x="1059.9545454545455" y="329.1443536931818"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_15" id="Yaoqiang-_15">
        <dc:Bounds height="38.0" width="29.0" x="153.42307692307693" y="139.49999999999997"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="95.0" x="120.42307692307693" y="179.5"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_17" id="Yaoqiang-_17">
        <dc:Bounds height="38.0" width="29.0" x="348.5769230769231" y="65.80769230769229"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="83.0" x="321.5769230769231" y="105.80769230769229"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_19" id="Yaoqiang-_19">
        <dc:Bounds height="38.0" width="29.0" x="348.5769230769231" y="139.49999999999997"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="86.0" x="320.0769230769231" y="179.5"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_22" id="Yaoqiang-_22">
        <dc:Bounds height="32.0" width="32.0" x="1072.9545454545455" y="414.0"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="58.0" x="1059.9545454545455" y="454.837890625"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_14" id="Yaoqiang-_14" isMarkerVisible="true">
        <dc:Bounds height="42.0" width="42.0" x="632.0454545454545" y="282.8181818181818"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="83.0" x="611.5454545454545" y="326.8181818181818"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_31" id="Yaoqiang-_31" isExpanded="false">
        <dc:Bounds height="81.0" width="116.0" x="491.22727272727275" y="263.3181818181818"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="46.955078125" width="75.0" x="511.72727272727275" y="282.3406427556818"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge bpmnElement="_18" id="Yaoqiang-_18">
        <di:waypoint x="312.0454545454546" y="303.8181818181818"/>
        <di:waypoint x="349.0454545454546" y="84.80769230769229"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="327.4807692307692" y="184.77071268575168"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_16" id="Yaoqiang-_16">
        <di:waypoint x="182.04545454545462" y="158.49999999999997"/>
        <di:waypoint x="196.04545454545462" y="303.8181818181818"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="186.40384615384613" y="221.32316023819936"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_13" id="Yaoqiang-_13">
        <di:waypoint x="312.0454545454546" y="303.8181818181818"/>
        <di:waypoint x="349.0454545454546" y="158.49999999999997"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="327.4807692307692" y="221.61686653190554"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_12" id="Yaoqiang-_12">
        <di:waypoint x="1043.0454545454545" y="303.8181818181818"/>
        <di:waypoint x="1073.050685255837" y="303.8181818181818"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="1055.0480699006457" y="294.3406427556818"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_6" id="Yaoqiang-_6">
        <di:waypoint x="312.0454545454546" y="303.8181818181818"/>
        <di:waypoint x="348.0454545454546" y="303.8181818181818"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="327.0454545454546" y="294.3406427556818"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_10" id="Yaoqiang-_10">
        <di:waypoint x="891.0454545454546" y="303.8181818181818"/>
        <di:waypoint x="927.0454545454546" y="303.8181818181818"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="906.0454545454546" y="294.3406427556818"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_4" id="Yaoqiang-_4">
        <di:waypoint x="103.04022383507237" y="303.8181818181818"/>
        <di:waypoint x="196.04545454545462" y="303.8181818181818"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="146.5428391902635" y="294.3406427556818"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_23" id="Yaoqiang-_23">
        <di:waypoint x="651.0" y="323.18181818181813"/>
        <di:waypoint x="651.0" y="418.0"/>
        <di:waypoint x="1078.725871140448" y="418.0"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="21.0" x="806.953844661133" y="408.5224609375"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_21" id="Yaoqiang-_21">
        <di:waypoint x="673.6363636363636" y="303.8181818181818"/>
        <di:waypoint x="775.0454545454546" y="303.8181818181818"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="32.955078125" width="103.0" x="669.8409090909091" y="265.3406427556818"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_33" id="Yaoqiang-_33">
        <di:waypoint x="607.0454545454546" y="303.8181818181818"/>
        <di:waypoint x="632.4545454545456" y="303.8181818181818"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="616.7500000000001" y="294.3406427556818"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_32" id="Yaoqiang-_32">
        <di:waypoint x="464.0454545454546" y="303.8181818181818"/>
        <di:waypoint x="491.0454545454546" y="303.8181818181818"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="474.5454545454546" y="294.3406427556818"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</definitions>
