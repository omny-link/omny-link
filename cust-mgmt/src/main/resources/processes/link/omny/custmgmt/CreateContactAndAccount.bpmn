<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:activiti="http://activiti.org/bpmn" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:tns="http://omny.link/custmgmt" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:yaoqiang="http://bpmn.sourceforge.net" exporter="Yaoqiang BPMN Editor" exporterVersion="2.2.18 (GPLv3, Non-Commercial)" expressionLanguage="http://activiti.org/Juel" id="_1422450380149" name="" targetNamespace="http://omny.link/custmgmt" typeLanguage="http://www.w3.org/2001/XMLSchema" xsi:schemaLocation="http://www.omg.org/spec/BPMN/20100524/MODEL http://bpmn.sourceforge.net/schemas/BPMN20.xsd">
  <process id="CreateContactAndAccount" isClosed="false" isExecutable="true" name="Create Contact and Account" processType="None">
    <documentation id="CreateContactAndAccount_D_1" textFormat="text/plain"><![CDATA[Reusable process to create contact and account from a single JSON message.]]></documentation>
    <extensionElements>
      <yaoqiang:pageFormat height="842.4" imageableHeight="832.4" imageableWidth="587.6" imageableX="5.0" imageableY="5.0" orientation="0" width="597.6"/>
      <yaoqiang:page background="#FFFFFF" horizontalCount="1" verticalCount="1"/>
    </extensionElements>
    <ioSpecification>
      <dataInput id="_15" isCollection="false" name="External Contact"/>
      <dataOutput id="_17" isCollection="false" name="Omny Contact"/>
      <dataOutput id="_19" isCollection="false" name="Omny Account"/>
      <inputSet>
        <dataInputRefs>_15</dataInputRefs>
      </inputSet>
      <outputSet>
        <dataOutputRefs>_17</dataOutputRefs>
        <dataOutputRefs>_19</dataOutputRefs>
      </outputSet>
    </ioSpecification>
    <startEvent id="_2" isInterrupting="true" name="Start Event" parallelMultiple="false">
      <outgoing>_4</outgoing>
    </startEvent>
    <scriptTask completionQuantity="1" id="_3" isForCompensation="false" name="Split Contact&#10;and Account" scriptFormat="JavaScript" startQuantity="1">
      <incoming>_4</incoming>
      <outgoing>_6</outgoing>
      <ioSpecification>
        <dataInput id="Din_3_15" isCollection="false"/>
        <dataOutput id="Dout_3_17" isCollection="false"/>
        <dataOutput id="Dout_3_19" isCollection="false"/>
        <inputSet>
          <dataInputRefs>Din_3_15</dataInputRefs>
        </inputSet>
        <outputSet>
          <dataOutputRefs>Dout_3_17</dataOutputRefs>
          <dataOutputRefs>Dout_3_19</dataOutputRefs>
        </outputSet>
      </ioSpecification>
      <dataInputAssociation id="_16">
        <sourceRef>_15</sourceRef>
        <targetRef>Din_3_15</targetRef>
      </dataInputAssociation>
      <dataOutputAssociation id="_18">
        <sourceRef>Dout_3_17</sourceRef>
        <targetRef>_17</targetRef>
      </dataOutputAssociation>
      <dataOutputAssociation id="_13">
        <sourceRef>Dout_3_19</sourceRef>
        <targetRef>_19</targetRef>
      </dataOutputAssociation>
      <script><![CDATA[
var System = java.lang.System;
var json = execution.getVariable('json');
System.out.println('JSON: '+json);
var extContact = JSON.parse(json);
System.out.println('extContact: '+extContact);
System.out.println('external acct: '+extContact.account);
var account = JSON.stringify(extContact.account);
var contact = extContact;
contact.account = undefined; 
//var account = extContact.account;

var pageSubmitted = extContact['pageSubmitted'];
if (pageSubmitted!=undefined) { 
  //println('Setting page submitted to: '+pageSubmitted);
  if (contact['customFields']==undefined) contact.customFields = {};
  contact.customFields.pageSubmitted = pageSubmitted; 
}
  
execution.setVariable('contactFirstName',extContact.firstName);
execution.setVariable('contactEmail',extContact.email);
execution.setVariable('contactPwd',extContact.password == undefined ? null : extContact.password);
execution.setVariable('contact',JSON.stringify(contact));
execution.setVariable('account',account == undefined ? null : account);
]]></script>
    </scriptTask>
    <sequenceFlow id="_4" sourceRef="_2" targetRef="_3"/>
    <serviceTask activiti:class="com.knowprocess.resource.spi.RestPost" completionQuantity="1" id="_5" implementation="##WebService" isForCompensation="false" name="POST &#10;contact" startQuantity="1">
      <extensionElements>
        <activiti:field name="resourceUsername">
          <activiti:string>userInfo('tenant-bot')</activiti:string>
        </activiti:field>
        <activiti:field name="resourcePassword">
          <activiti:expression>userInfo('cust-mgmt-secret')</activiti:expression>
        </activiti:field>
        <activiti:field name="globalResource">
          <activiti:expression>userInfo('cust-mgmt-url')/contacts</activiti:expression>
        </activiti:field>
        <activiti:field name="headers">
          <activiti:string>Content-Type:application/json,Accept:application/json</activiti:string>
        </activiti:field>
        <activiti:field name="data">
          <activiti:expression>${contact}</activiti:expression>
        </activiti:field>
        <activiti:field expression="contactId=Location" name="responseHeaders"/>
      </extensionElements>
      <incoming>_6</incoming>
      <outgoing>_20</outgoing>
    </serviceTask>
    <sequenceFlow id="_6" sourceRef="_3" targetRef="_5"/>
    <serviceTask activiti:class="com.knowprocess.resource.spi.RestPost" completionQuantity="1" id="_7" implementation="##WebService" isForCompensation="false" name="POST &#10;account" startQuantity="1">
      <extensionElements>
        <activiti:field name="resourceUsername">
          <activiti:string>userInfo('tenant-bot')</activiti:string>
        </activiti:field>
        <activiti:field name="resourcePassword">
          <activiti:expression>userInfo('cust-mgmt-secret')</activiti:expression>
        </activiti:field>
        <activiti:field name="globalResource">
          <activiti:expression>userInfo('cust-mgmt-url')/accounts</activiti:expression>
        </activiti:field>
        <activiti:field name="headers">
          <activiti:string>Content-Type:application/json,Accept:application/json</activiti:string>
        </activiti:field>
        <activiti:field name="data">
          <activiti:expression>${account}</activiti:expression>
        </activiti:field>
        <activiti:field expression="accountId=Location" name="responseHeaders"/>
      </extensionElements>
      <incoming>_21</incoming>
      <outgoing>_10</outgoing>
    </serviceTask>
    <serviceTask activiti:class="com.knowprocess.resource.spi.RestPut" completionQuantity="1" id="_9" implementation="##WebService" isForCompensation="false" name="PUT association&#10;between contact &#10;and account" startQuantity="1">
      <extensionElements>
        <activiti:field name="resourceUsername">
          <activiti:string>userInfo('tenant-bot')</activiti:string>
        </activiti:field>
        <activiti:field name="resourcePassword">
          <activiti:expression>userInfo('cust-mgmt-secret')</activiti:expression>
        </activiti:field>
        <activiti:field name="globalResource">
          <activiti:expression>${contactId}/account</activiti:expression>
        </activiti:field>
        <activiti:field name="headers">
          <activiti:string>Content-Type:text/uri-list,Accept:application/json</activiti:string>
        </activiti:field>
        <activiti:field name="data">
          <activiti:expression>${accountId}</activiti:expression>
        </activiti:field>
        <activiti:field name="responseVar">
          <activiti:expression>textResponse</activiti:expression>
        </activiti:field>
      </extensionElements>
      <incoming>_10</incoming>
      <outgoing>_12</outgoing>
    </serviceTask>
    <sequenceFlow id="_10" sourceRef="_7" targetRef="_9"/>
    <endEvent id="_11" name="End Event">
      <incoming>_12</incoming>
    </endEvent>
    <sequenceFlow id="_12" sourceRef="_9" targetRef="_11"/>
    <dataObject id="DO_CreateContactAndAccount_1" isCollection="false" name="Data Object"/>
    <sequenceFlow id="_20" sourceRef="_5" targetRef="_14"/>
    <sequenceFlow id="_21" name="Yes" sourceRef="_14" targetRef="_7">
      <extensionElements>
        <yaoqiang:label offset-x="-3.0" offset-y="0.0" x="0.0" y="22.0"/>
      </extensionElements>
      <conditionExpression><![CDATA[${!empty account}]]></conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="_23" name="No" sourceRef="_14" targetRef="_22"/>
    <endEvent id="_22" name="End Event">
      <incoming>_23</incoming>
    </endEvent>
    <exclusiveGateway default="_23" gatewayDirection="Diverging" id="_14" name="Have account?">
      <incoming>_20</incoming>
      <outgoing>_21</outgoing>
      <outgoing>_23</outgoing>
    </exclusiveGateway>
  </process>
  <bpmndi:BPMNDiagram id="Yaoqiang_Diagram-_1" name="New Diagram" resolution="96.0">
    <bpmndi:BPMNPlane bpmnElement="CreateContactAndAccount">
      <bpmndi:BPMNShape bpmnElement="_2" id="Yaoqiang-_2">
        <dc:Bounds height="32.0" width="32.0" x="70.96153846153848" y="266.3636363636364"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="63.0" x="55.46153846153845" y="307.6673473011364"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_3" id="Yaoqiang-_3">
        <dc:Bounds height="81.0" width="116.0" x="196.38461538461536" y="241.86363636363637"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="32.955078125" width="74.0" x="217.38461538461536" y="267.8860973011364"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_5" id="Yaoqiang-_5">
        <dc:Bounds height="81.0" width="116.0" x="348.30769230769226" y="241.86363636363637"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="32.955078125" width="46.0" x="383.30769230769226" y="267.8860973011364"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_7" id="Yaoqiang-_7">
        <dc:Bounds height="81.0" width="116.0" x="639.2307692307692" y="241.86363636363637"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="32.955078125" width="49.0" x="672.7307692307692" y="267.8860973011364"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_9" id="Yaoqiang-_9">
        <dc:Bounds height="81.0" width="116.0" x="791.0" y="241.86363636363637"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="46.955078125" width="93.0" x="802.5" y="260.8860973011364"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_11" id="Yaoqiang-_11">
        <dc:Bounds height="32.0" width="32.0" x="936.9545454545455" y="266.3636363636364"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="58.0" x="923.9545454545455" y="307.6673473011364"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_15" id="Yaoqiang-_15">
        <dc:Bounds height="38.0" width="29.0" x="153.42307692307693" y="139.49999999999997"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="95.0" x="120.42307692307693" y="179.5"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_17" id="Yaoqiang-_17">
        <dc:Bounds height="38.0" width="29.0" x="348.5769230769231" y="65.80769230769229"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="83.0" x="321.5769230769231" y="105.80769230769229"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_19" id="Yaoqiang-_19">
        <dc:Bounds height="38.0" width="29.0" x="348.5769230769231" y="139.49999999999997"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="86.0" x="320.0769230769231" y="179.5"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_22" id="Yaoqiang-_22">
        <dc:Bounds height="32.0" width="32.0" x="936.9545454545455" y="417.0"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="58.0" x="923.9545454545455" y="457.8154296875"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="_14" id="Yaoqiang-_14" isMarkerVisible="true">
        <dc:Bounds height="42.0" width="42.0" x="496.0454545454545" y="261.3636363636364"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="83.0" x="475.5454545454545" y="305.3636363636364"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge bpmnElement="_18" id="Yaoqiang-_18">
        <di:waypoint x="312.0454545454546" y="282.3636363636364"/>
        <di:waypoint x="349.0454545454546" y="84.80769230769229"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="327.4807692307692" y="174.04343995847893"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_16" id="Yaoqiang-_16">
        <di:waypoint x="182.04545454545462" y="158.49999999999997"/>
        <di:waypoint x="196.04545454545462" y="282.3636363636364"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="186.40384615384613" y="210.59588751092667"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_13" id="Yaoqiang-_13">
        <di:waypoint x="312.0454545454546" y="282.3636363636364"/>
        <di:waypoint x="349.0454545454546" y="158.49999999999997"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="327.4807692307692" y="210.8895938046328"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_12" id="Yaoqiang-_12">
        <di:waypoint x="907.0454545454546" y="282.3636363636364"/>
        <di:waypoint x="937.0460356510486" y="282.3636363636364"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="919.0457450982516" y="272.8860973011364"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_6" id="Yaoqiang-_6">
        <di:waypoint x="312.0454545454546" y="282.3636363636364"/>
        <di:waypoint x="348.0454545454546" y="282.3636363636364"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="327.0454545454546" y="272.8860973011364"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_10" id="Yaoqiang-_10">
        <di:waypoint x="755.0454545454546" y="282.3636363636364"/>
        <di:waypoint x="791.0454545454546" y="282.3636363636364"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="770.0454545454546" y="272.8860973011364"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_4" id="Yaoqiang-_4">
        <di:waypoint x="103.04487343986068" y="282.3636363636364"/>
        <di:waypoint x="196.04545454545462" y="282.3636363636364"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="146.54516399265765" y="272.8860973011364"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_23" id="Yaoqiang-_23">
        <di:waypoint x="515.0" y="301.18181818181813"/>
        <di:waypoint x="515.0" y="421.0"/>
        <di:waypoint x="942.7258711404478" y="421.0"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="21.0" x="658.453844661133" y="411.5224609375"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_21" id="Yaoqiang-_21">
        <di:waypoint x="537.909090909091" y="282.3636363636364"/>
        <di:waypoint x="639.0454545454546" y="282.3636363636364"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="32.955078125" width="103.0" x="533.9772727272729" y="243.88609730113637"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="_20" id="Yaoqiang-_20">
        <di:waypoint x="464.0454545454546" y="282.3636363636364"/>
        <di:waypoint x="496.18181818181824" y="282.3636363636364"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds height="18.955078125" width="6.0" x="477.1136363636364" y="272.8860973011364"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</definitions>
